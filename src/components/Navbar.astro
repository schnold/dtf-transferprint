---
import { SITE_CONFIG } from '../constants/site';
import AuthModal from './AuthModal.astro';
import CartDropdown from './CartDropdown.astro';
import { pool } from '../lib/db';

const user = Astro.locals.user;

// Fetch categories with products for navigation
const client = await pool.connect();
let categoriesWithProducts = [];
try {
	const categoriesResult = await client.query(`
		SELECT id, name, slug, "displayOrder", "parentId"
		FROM categories
		WHERE "isActive" = true
		ORDER BY "displayOrder", name
	`);

	categoriesWithProducts = await Promise.all(
		categoriesResult.rows.map(async (category) => {
			const productsResult = await client.query(`
				SELECT id, slug, name, "shortDescription", "basePrice", "isFeatured"
				FROM products
				WHERE "categoryId" = $1 AND "isActive" = true
				ORDER BY "isFeatured" DESC, name
				LIMIT 10
			`, [category.id]);

			return {
				...category,
				products: productsResult.rows.map(p => ({
					...p,
					basePrice: parseFloat(p.basePrice),
				})),
			};
		})
	);
} finally {
	client.release();
}

// Group by parent category for mega menu
const basicDTFCategory = categoriesWithProducts.find(c => c.name.toLowerCase().includes('basic') || c.name.toLowerCase() === 'dtf');
const blockoutCategory = categoriesWithProducts.find(c => c.name.toLowerCase().includes('blockout'));
const otherCategories = categoriesWithProducts.filter(c => c !== basicDTFCategory && c !== blockoutCategory);
---

<!-- Navbar -->
<div class="w-full px-4 sm:px-6 lg:px-8 pt-6 sticky top-0 z-50">
	<div class="navbar bg-base-100/20 backdrop-blur-xl backdrop-saturate-150 border border-white/20 shadow-lg rounded-2xl px-3 sm:px-4 lg:px-6 py-4 max-w-7xl lg:max-w-7xl-extended mx-auto min-h-[4.5rem] overflow-visible">
		<div class="navbar-start">
			<a href="/" class="px-2 sm:px-4 flex items-center no-underline">
				<img 
					src={SITE_CONFIG.brand.logo.primary} 
					alt={SITE_CONFIG.brand.logo.alt}
					class="h-6 sm:h-8 lg:h-10 w-auto object-contain"
				/>
			</a>
		</div>
		<div class="navbar-center hidden md:flex flex-1 min-w-0 justify-center">
			<ul class="flex flex-row flex-wrap gap-0.5 sm:gap-1 px-1 max-w-4xl justify-center md:justify-start mega-menu">
				<!-- Produkte Mega Menu -->
				<li class="dropdown mega-dropdown flex-shrink-0 relative">
					<label class="text-neutral/80 hover:text-neutral hover:bg-white/10 px-2 sm:px-3 lg:px-4 py-2 rounded-md transition-all duration-200 cursor-pointer flex items-center gap-1.5 text-sm lg:text-base font-medium">
						<span>Produkte</span>
						<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 transition-transform duration-200">
							<path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
						</svg>
					</label>
					<div class="mega-dropdown-content absolute left-1/2 -translate-x-1/2 top-full mt-2 bg-base-100 rounded-2xl shadow-2xl border border-base-300/30 p-6 w-[calc(100vw-4rem)] max-w-[700px] opacity-0 invisible transform translate-y-2 transition-all duration-300 ease-out z-50">
						<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
							<!-- Basic DTF Column -->
							{basicDTFCategory && basicDTFCategory.products.length > 0 && (
								<div>
									<h3 class="font-bold text-neutral mb-4 text-lg flex items-center gap-2">
										<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5" style="color: var(--color-primary);">
											<path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
										</svg>
										{basicDTFCategory.name}
									</h3>
									<ul class="space-y-3">
										{basicDTFCategory.products.map((product) => (
											<li>
												<a href={`/product/${product.slug}`} class="text-neutral/70 hover:text-primary text-sm py-1.5 transition-colors block">
													{product.name}
												</a>
											</li>
										))}
									</ul>
								</div>
							)}

							<!-- Blockout DTF Column -->
							{blockoutCategory && blockoutCategory.products.length > 0 && (
								<div>
									<h3 class="font-bold text-neutral mb-4 text-lg flex items-center gap-2">
										<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5" style="color: var(--color-primary);">
											<path stroke-linecap="round" stroke-linejoin="round" d="M6.429 9.75L2.25 12l4.179 2.25m0-4.5l5.571 3 5.571-3m-11.142 0L2.25 7.5l4.179-2.25m11.142 0L21.75 7.5l-4.179 2.25m0 0L21.75 12l-4.179 2.25m0 0l4.179 2.25L21.75 16.5l-4.179-2.25m-11.142 0l-4.179 2.25L2.25 16.5l4.179-2.25" />
										</svg>
										{blockoutCategory.name}
									</h3>
									<ul class="space-y-3">
										{blockoutCategory.products.map((product) => (
											<li>
												<a href={`/product/${product.slug}`} class="text-neutral/70 hover:text-primary text-sm py-1.5 transition-colors block">
													{product.name}
												</a>
											</li>
										))}
									</ul>
								</div>
							)}

							<!-- Other Categories or Static Links -->
							<div>
								{otherCategories.length > 0 ? (
									<>
										<h3 class="font-bold text-neutral mb-4 text-lg flex items-center gap-2">
											<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5" style="color: var(--color-primary);">
												<path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" />
											</svg>
											Weitere Produkte
										</h3>
										<ul class="space-y-3">
											{otherCategories.slice(0, 2).map((category) => (
												<li>
													<a href={`/categories/${category.slug}`} class="text-neutral/70 hover:text-primary text-sm py-1.5 transition-colors block">
														{category.name}
													</a>
												</li>
											))}
										</ul>
									</>
								) : (
									<>
										<h3 class="font-bold text-neutral mb-4 text-lg flex items-center gap-2">
											<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5" style="color: var(--color-primary);">
												<path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" />
											</svg>
											Mustermappen & Info
										</h3>
										<ul class="space-y-3">
											<li><a href="/mustermappe/" class="text-neutral/70 hover:text-primary text-sm py-1.5 transition-colors">
												Basic Mustermappe
											</a></li>
											<li><a href="/blockout/" class="text-neutral/70 hover:text-primary text-sm py-1.5 transition-colors">
												Blockout Mustermappe
											</a></li>
										</ul>
									</>
								)}
								<div class="mt-6 pt-4 border-t border-base-300/20">
									<a href="/products/" class="btn btn-primary btn-sm w-full">Alle Produkte ansehen</a>
								</div>
							</div>
						</div>
					</div>
				</li>

				<!-- Dienstleistungen Mega Menu -->
				<li class="dropdown mega-dropdown flex-shrink-0 relative">
					<label class="text-neutral/80 hover:text-neutral hover:bg-white/10 px-2 sm:px-3 lg:px-4 py-2 rounded-md transition-all duration-200 cursor-pointer flex items-center gap-1.5 text-sm lg:text-base font-medium">
						<span>Dienstleistungen</span>
						<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 transition-transform duration-200">
							<path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
						</svg>
					</label>
					<div class="mega-dropdown-content absolute left-1/2 -translate-x-1/2 top-full mt-2 bg-base-100 rounded-2xl shadow-2xl border border-base-300/30 p-6 w-[calc(100vw-4rem)] max-w-[700px] opacity-0 invisible transform translate-y-2 transition-all duration-300 ease-out z-50">
						<div class="grid grid-cols-1 md:grid-cols-2 gap-8">
							<!-- Druckdienstleistungen -->
							<div>
								<h3 class="font-bold text-neutral mb-4 text-lg flex items-center gap-2">
									<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5" style="color: var(--color-primary);">
										<path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
									</svg>
									Druckdienstleistungen
								</h3>
								<ul class="space-y-3">
									<li><a href="/dtf-express-druck/" class="text-neutral/70 hover:text-primary text-sm py-1.5 transition-colors flex items-center justify-between">
										<span>DTF Express Druck</span>
										<span class="badge badge-accent badge-xs">24-48h</span>
									</a></li>
									<li><a href="/textil-lohndruck/" class="text-neutral/70 hover:text-primary text-sm py-1.5 transition-colors">
										Textil-Lohndruck
									</a></li>
									<li><a href="/individueller-druck/" class="text-neutral/70 hover:text-primary text-sm py-1.5 transition-colors">
										Individueller Druck
									</a></li>
								</ul>
							</div>

							<!-- Zusatzleistungen -->
							<div>
								<h3 class="font-bold text-neutral mb-4 text-lg flex items-center gap-2">
									<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5" style="color: var(--color-primary);">
										<path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
									</svg>
									Zusatzleistungen
								</h3>
								<ul class="space-y-3">
									<li><a href="/druckvorlagen/" class="text-neutral/70 hover:text-primary text-sm py-1.5 transition-colors">
										Druckvorlagen
									</a></li>
									<li><a href="/beratung/" class="text-neutral/70 hover:text-primary text-sm py-1.5 transition-colors">
										Fachberatung
									</a></li>
									<li><a href="/support/" class="text-neutral/70 hover:text-primary text-sm py-1.5 transition-colors">
										Technischer Support
									</a></li>
								</ul>
								<div class="mt-6 pt-4 border-t border-base-300/20">
									<a href="#contact" class="btn btn-primary btn-sm w-full">Angebot anfordern</a>
								</div>
							</div>
						</div>
					</div>
				</li>

				<!-- Informationen Mega Menu -->
				<li class="dropdown mega-dropdown flex-shrink-0 relative">
					<label class="text-neutral/80 hover:text-neutral hover:bg-white/10 px-2 sm:px-3 lg:px-4 py-2 rounded-md transition-all duration-200 cursor-pointer flex items-center gap-1.5 text-sm lg:text-base font-medium">
						<span>Informationen</span>
						<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 transition-transform duration-200">
							<path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
						</svg>
					</label>
					<div class="mega-dropdown-content absolute left-1/2 -translate-x-1/2 top-full mt-2 bg-base-100 rounded-2xl shadow-2xl border border-base-300/30 p-6 w-[calc(100vw-4rem)] max-w-[800px] opacity-0 invisible transform translate-y-2 transition-all duration-300 ease-out z-50">
						<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
							<!-- Unternehmen -->
							<div>
								<h3 class="font-bold text-neutral mb-4 text-lg flex items-center gap-2">
									<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5" style="color: var(--color-primary);">
										<path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M6.75 21v-3.375c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21M3 3h12m-.75 4.5H21m-3.75 3.75h.008v.008h-.008v-.008zm0 3h.008v.008h-.008v-.008zm0 3h.008v.008h-.008v-.008z" />
									</svg>
									Unternehmen
								</h3>
								<ul class="space-y-3">
									<li><a href="/ueber-uns/" class="text-neutral/70 hover:text-primary text-sm py-1.5 transition-colors">
										Über Uns
									</a></li>
									<li><a href="/karriere/" class="text-neutral/70 hover:text-primary text-sm py-1.5 transition-colors">
										Stellenangebote
									</a></li>
								</ul>
							</div>

							<!-- DTF-Ratgeber -->
							<div>
								<h3 class="font-bold text-neutral mb-4 text-lg flex items-center gap-2">
									<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5" style="color: var(--color-primary); transform: scaleY(-1);">
										<path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
									</svg>
									DTF-Ratgeber
								</h3>
								<ul class="space-y-3">
									<li><a href="/dtf-ratgeber-und-infos/" class="text-neutral/70 hover:text-primary text-sm py-1.5 transition-colors">
										DTF Grundlagen
									</a></li>
									<li><a href="/dtf-druck/" class="text-neutral/70 hover:text-primary text-sm py-1.5 transition-colors">
										DTF Druckprozess
									</a></li>
									<li><a href="/dtf-haltbarkeit/" class="text-neutral/70 hover:text-primary text-sm py-1.5 transition-colors">
										DTF Haltbarkeit
									</a></li>
									<li><a href="/infos-zu-printpunk/" class="text-neutral/70 hover:text-primary text-sm py-1.5 transition-colors">
										Tipps & Tricks
									</a></li>
									<li><a href="/textildruckverfahren/" class="text-neutral/70 hover:text-primary text-sm py-1.5 transition-colors">
										Textildruckverfahren
									</a></li>
								</ul>
							</div>

							<!-- Support -->
							<div>
								<h3 class="font-bold text-neutral mb-4 text-lg flex items-center gap-2">
									<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5" style="color: var(--color-primary);">
										<path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" />
									</svg>
									Support & FAQ
								</h3>
								<ul class="space-y-3">
									<li><a href="/faq/" class="text-neutral/70 hover:text-primary text-sm py-1.5 transition-colors">
										Häufige Fragen
									</a></li>
									<li><a href="/kontakt/" class="text-neutral/70 hover:text-primary text-sm py-1.5 transition-colors">
										Kontakt
									</a></li>
									<li><a href="/support/" class="text-neutral/70 hover:text-primary text-sm py-1.5 transition-colors">
										Technischer Support
									</a></li>
								</ul>
								<div class="mt-6 pt-4 border-t border-base-300/20">
									<div class="text-center">
										<p class="text-xs text-neutral/60 mb-2">24/7 Support</p>
										<a href="tel:+49123456789" class="btn btn-outline btn-primary btn-xs">Jetzt anrufen</a>
									</div>
								</div>
							</div>
						</div>
					</div>
				</li>

				<!-- Muster bestellen - Simple Link -->
				<li class="flex-shrink-0">
					<a href="/muster-bestellen/" class="text-neutral/80 hover:text-neutral hover:bg-white/10 px-2 sm:px-3 lg:px-4 py-2 rounded-md transition-all duration-200 flex items-center gap-1.5 text-sm lg:text-base font-medium">
						<span>Muster bestellen</span>
					</a>
				</li>
			</ul>
		</div>
		<div class="navbar-end flex items-center gap-4">
			<!-- Auth Section -->
			{user ? (
				<>
					<!-- Cart Dropdown Component -->
					<CartDropdown />
					
					<!-- User Icon -->
				<!-- Logged In: User Icon with Accent Color -->
				<div class="dropdown relative user-dropdown">
					<button
						tabindex="0"
						class="w-8 h-8 rounded-full border-2 border-accent flex items-center justify-center hover:bg-accent/10 transition-all duration-200 cursor-pointer"
						aria-label="User menu"
					>
						<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 text-accent">
							<path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
						</svg>
					</button>
					<ul tabindex="0" class="user-dropdown-content absolute right-0 top-full mt-3 z-[1] p-6 shadow-2xl bg-base-100 rounded-xl w-80 border border-base-300/30 overflow-hidden opacity-0 invisible transform translate-y-2 transition-all duration-300 ease-out">
						<!-- Header -->
						<div class="pt-6 pb-4 bg-base-100 border-b border-base-200">
							<div class="flex items-center gap-3 mb-2">
								<div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center">
									<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-primary">
										<path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
									</svg>
								</div>
								<div class="flex-1 min-w-0">
									<p class="text-base font-semibold text-base-content truncate">Mein Konto</p>
									<p class="text-sm text-base-content/60 truncate">{user.email}</p>
								</div>
							</div>
						</div>
						
						<!-- Menu Items -->
						<div class="py-2">
							<li>
								<a href="/auth/account?tab=profile" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-base-200 transition-colors">
									<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-base-content/70">
										<path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
									</svg>
									<span class="text-base">Mein Profil</span>
								</a>
							</li>
							{user.isAdmin && (
								<li>
									<a href="/admin" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-base-200 transition-colors bg-primary/5">
										<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-primary">
											<path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z" />
											<path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
										</svg>
										<span class="text-base font-medium">Admin Panel</span>
									</a>
								</li>
							)}
							<li>
								<a href="/auth/account?tab=orders" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-base-200 transition-colors">
									<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-base-content/70">
										<path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 1 0-7.5 0v4.5m11.356-1.993 1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 0 1-1.12-1.243l1.264-12A1.125 1.125 0 0 1 5.513 7.5h12.974c.576 0 1.059.435 1.119 1.007ZM8.625 10.5a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm7.5 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
									</svg>
									<span class="text-base">Bestellungen</span>
								</a>
							</li>
						</div>
						
						<!-- Divider -->
						<div class="border-t border-base-200 my-1"></div>
						
						<!-- Sign Out -->
						<div class="pb-2">
							<li>
								<button id="logout-button" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-error/10 text-error w-full transition-colors">
									<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
										<path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m3 0 3-3m0 0-3-3m3 3H9" />
									</svg>
									<span class="text-base font-medium">Abmelden</span>
								</button>
							</li>
						</div>
					</ul>
				</div>
				</>
			) : (
				<!-- Not Logged In: User Icon -->
				<button
					id="auth-icon-button"
					class="w-8 h-8 rounded-full border border-neutral/30 flex items-center justify-center hover:border-neutral/50 hover:bg-white/10 transition-all duration-200 cursor-pointer"
					aria-label="Sign in or Sign up"
				>
					<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 text-neutral/80 hover:text-neutral transition-colors">
						<path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
					</svg>
				</button>
			)}

			<!-- Mobile Menu Dropdown -->
			<div class="dropdown dropdown-end md:hidden">
				<label tabindex="0" class="btn btn-ghost text-neutral hover:bg-white/10 px-2 sm:px-3" aria-label="Menu">
					<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
						<path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
					</svg>
				</label>
				<div tabindex="0" class="dropdown-content mt-3 bg-base-100 rounded-2xl shadow-2xl border border-base-300/30 p-6 w-[calc(100vw-2rem)] max-w-sm max-h-[calc(100vh-8rem)] overflow-y-auto overflow-x-hidden z-50">
					<div class="space-y-6">
						<!-- Products -->
						{basicDTFCategory && basicDTFCategory.products.length > 0 && (
							<div>
								<h3 class="font-bold text-neutral mb-4 text-lg flex items-center gap-2">
									<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5" style="color: var(--color-primary);">
										<path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
									</svg>
									{basicDTFCategory.name}
								</h3>
								<ul class="space-y-3">
									{basicDTFCategory.products.map((product) => (
										<li>
											<a href={`/product/${product.slug}`} class="text-neutral/70 hover:text-primary text-sm py-1.5 transition-colors">
												{product.name}
											</a>
										</li>
									))}
								</ul>
							</div>
						)}

						{blockoutCategory && blockoutCategory.products.length > 0 && (
							<div>
								<h3 class="font-bold text-neutral mb-4 text-lg flex items-center gap-2">
									<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5" style="color: var(--color-primary);">
										<path stroke-linecap="round" stroke-linejoin="round" d="M6.429 9.75L2.25 12l4.179 2.25m0-4.5l5.571 3 5.571-3m-11.142 0L2.25 7.5l4.179-2.25m11.142 0L21.75 7.5l-4.179 2.25m0 0L21.75 12l-4.179 2.25m0 0l4.179 2.25L21.75 16.5l-4.179-2.25m-11.142 0l-4.179 2.25L2.25 16.5l4.179-2.25" />
									</svg>
									{blockoutCategory.name}
								</h3>
								<ul class="space-y-3">
									{blockoutCategory.products.map((product) => (
										<li>
											<a href={`/product/${product.slug}`} class="text-neutral/70 hover:text-primary text-sm py-1.5 transition-colors">
												{product.name}
											</a>
										</li>
									))}
								</ul>
							</div>
						)}

						{otherCategories.length > 0 && otherCategories.map((category) => (
							<div>
								<h3 class="font-bold text-neutral mb-4 text-lg">{category.name}</h3>
								<ul class="space-y-3">
									{category.products.slice(0, 5).map((product) => (
										<li>
											<a href={`/product/${product.slug}`} class="text-neutral/70 hover:text-primary text-sm py-1.5 transition-colors">
												{product.name}
											</a>
										</li>
									))}
								</ul>
							</div>
						))}

						<div class="pt-4 border-t border-base-300/20">
							<a href="/products/" class="btn btn-primary btn-sm w-full">Alle Produkte ansehen</a>
						</div>

						<!-- Muster bestellen -->
						<div class="pt-4 border-t border-base-300/20">
							<a href="/muster-bestellen/" class="text-neutral/80 hover:text-primary text-base font-medium py-2 transition-colors block">
								Muster bestellen
							</a>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Mega Menu Styles -->
<style>
	.mega-menu {
		display: flex;
		flex-wrap: wrap;
		gap: 0.25rem;
	}

	/* Add a pseudo-element to bridge the gap between label and dropdown */
	.mega-dropdown::before {
		content: '';
		position: absolute;
		top: 100%;
		left: 0;
		right: 0;
		height: 0.5rem;
		pointer-events: none;
	}

	.mega-dropdown:hover::before {
		pointer-events: auto;
	}

	.mega-dropdown:hover .mega-dropdown-content,
	.mega-dropdown-content:hover {
		opacity: 1;
		visibility: visible;
		transform: translateX(-50%) translateY(0);
		transition-delay: 0s;
	}

	.mega-dropdown:hover > label svg {
		transform: rotate(180deg);
	}

	.mega-dropdown-content {
		pointer-events: none;
		transition: opacity 0.3s ease-out, visibility 0.3s ease-out, transform 0.3s ease-out;
		transition-delay: 0s, 0s, 0s;
	}

	.mega-dropdown:not(:hover) .mega-dropdown-content {
		opacity: 0;
		visibility: hidden;
		transform: translateX(-50%) translateY(2px);
		transition-delay: 0.15s;
	}

	.mega-dropdown:hover .mega-dropdown-content {
		pointer-events: auto;
	}

	.mega-dropdown {
		position: relative;
	}

	.mega-dropdown-content:hover {
		pointer-events: auto;
	}

	/* Desktop: Single row, no wrap */
	@media (min-width: 1024px) {
		.mega-menu {
			flex-wrap: nowrap;
			gap: 0.5rem;
		}

		.mega-menu li a,
		.mega-menu li label {
			white-space: nowrap;
			font-size: 1rem;
			padding-left: 0.75rem;
			padding-right: 0.75rem;
		}
	}

	/* Tablet: Maximum 2 rows */
	@media (min-width: 768px) and (max-width: 1023px) {
		.mega-menu {
			justify-content: center;
			overflow: visible;
		}

		.mega-menu li a,
		.mega-menu li label {
			font-size: 0.875rem;
		}
	}

	/* User dropdown styles */
	.user-dropdown:hover .user-dropdown-content,
	.user-dropdown-content:hover {
		opacity: 1;
		visibility: visible;
		transform: translateY(0);
		transition-delay: 0s;
	}

	.user-dropdown:not(:hover) .user-dropdown-content {
		opacity: 0;
		visibility: hidden;
		transform: translateY(2px);
		transition-delay: 0.15s;
	}

	/* Mobile: Burger menu (navbar-center is hidden, these styles won't apply) */
	@media (max-width: 767px) {
		.mega-menu {
			flex-direction: column;
			align-items: center;
			gap: 0.5rem;
		}

		.mega-dropdown {
			width: 100%;
		}

		.mega-dropdown-content {
			position: static !important;
			opacity: 1 !important;
			visibility: visible !important;
			transform: none !important;
			box-shadow: none !important;
			border: 1px solid rgba(209, 213, 219, 0.3) !important;
			margin-top: 0.5rem !important;
			max-width: none !important;
			width: 100% !important;
			display: none;
		}

		.mega-dropdown:hover .mega-dropdown-content {
			display: block;
		}

		.user-dropdown .user-dropdown-content {
			position: static !important;
			opacity: 1 !important;
			visibility: visible !important;
			transform: none !important;
			box-shadow: none !important;
			border: 1px solid rgba(209, 213, 219, 0.3) !important;
			margin-top: 0.5rem !important;
			width: 100% !important;
			display: none;
		}

		.user-dropdown:hover .user-dropdown-content {
			display: block;
		}
	}
</style>

<!-- Auth Modal -->
<AuthModal />

<!-- Client-side Auth Scripts -->
<script>
	import { authClient } from '../lib/auth-client';

	// Open auth modal when clicking the user icon
	const authIconButton = document.getElementById('auth-icon-button');
	if (authIconButton) {
		authIconButton.addEventListener('click', () => {
			(window as any).openAuthModal('login');
		});
	}

	// Handle logout
	const logoutButton = document.getElementById('logout-button');
	if (logoutButton) {
		logoutButton.addEventListener('click', async (e) => {
			e.preventDefault();
			try {
				await authClient.signOut();
				window.location.href = '/';
			} catch (error) {
				console.error('Logout error:', error);
				alert('Abmeldung fehlgeschlagen. Bitte versuche es erneut.');
			}
		});
	}
</script>
