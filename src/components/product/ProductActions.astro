---
interface Props {
	productId: string;
	productName: string;
	productSlug: string;
	price: number;
	inStock: boolean;
}

const { productId, productName, productSlug, price, inStock } = Astro.props;

const formatPrice = (price: number) => {
	return new Intl.NumberFormat('de-DE', {
		style: 'currency',
		currency: 'EUR'
	}).format(price);
};
---

<div class="product-actions space-y-5" data-product-name={productName} data-product-price={price} data-product-slug={productSlug}>
	<!-- Zusatzleistungen Section -->
	<div id="zusatzleistungen-section" class="hidden space-y-3">
		<div class="border-t border-base-300/20 pt-5">
			<h3 class="text-sm font-semibold text-neutral mb-3">
				Zusätzliche Leistungen
			</h3>
			<div id="zusatzleistungen-checkboxes" class="space-y-2">
				<!-- Populated via script -->
			</div>
			<div id="zusatzleistungen-total-display" class="hidden mt-3 pt-3 border-t border-base-300/20">
				<div class="flex justify-between items-center text-sm">
					<span class="text-neutral/70">Zusatzleistungen:</span>
					<span class="font-semibold text-primary" id="zusatzleistungen-total">0,00 €</span>
				</div>
			</div>
		</div>
	</div>

	<!-- Action Buttons -->
	<div class="space-y-4">
		{inStock ? (
			<>
				<button
					class="btn btn-primary btn-lg w-full text-lg font-semibold shadow-lg hover:shadow-xl transition-all"
					id="add-to-cart-btn"
					data-product-id={productId}
				>
					<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
					</svg>
					In den Warenkorb
				</button>
				<button
					class="btn btn-outline btn-lg w-full text-lg"
					id="quote-btn"
				>
					Angebot anfordern
				</button>
			</>
		) : (
			<button
				class="btn btn-disabled btn-lg w-full text-lg"
				disabled
			>
				Nicht verfügbar
			</button>
		)}
	</div>

	<!-- Trust Badges -->
	<div class="grid grid-cols-1 gap-4 pt-6 border-t border-base-300/20">
		<div class="flex items-center gap-3 text-sm text-neutral/70">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-success flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
			</svg>
			<span>Schnelle Lieferung in 3-5 Werktagen</span>
		</div>
		<div class="flex items-center gap-3 text-sm text-neutral/70">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-success flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
			</svg>
			<span>Premium Qualität garantiert</span>
		</div>
		<div class="flex items-center gap-3 text-sm text-neutral/70">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-success flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
			</svg>
			<span>Sicherer Checkout & Zahlung</span>
		</div>
	</div>
</div>

<script>
	document.addEventListener('DOMContentLoaded', () => {
		const quantityInput = document.getElementById('quantity-input') as HTMLInputElement;
		const quantityDecrease = document.getElementById('quantity-decrease');
		const quantityIncrease = document.getElementById('quantity-increase');
		const totalPrice = document.getElementById('total-price');
		const unitPrice = document.getElementById('unit-price');
		const discountBadge = document.getElementById('discount-badge');
		const discountPercent = document.getElementById('discount-percent');
		const originalPriceContainer = document.getElementById('original-price-container');
		const originalUnitPrice = document.getElementById('original-unit-price');
		const orderBtn = document.getElementById('order-btn');
		const quoteBtn = document.getElementById('quote-btn');
		const productContainer = document.querySelector('[data-product-price]');

		if (!quantityInput || !totalPrice || !unitPrice || !productContainer) return;

		const basePrice = parseFloat(productContainer.getAttribute('data-product-price') || '0');
		const productName = productContainer.getAttribute('data-product-name') || 'Produkt';
		const productSlug = productContainer.getAttribute('data-product-slug') || '';

		let currentPriceData = {
			unitPrice: basePrice,
			basePrice: basePrice,
			discountPercent: 0,
			total: basePrice,
		};

		let availableZusatzleistungen: any[] = [];
		let selectedZusatzleistungIds: string[] = [];

		const formatPrice = (price: number) => {
			return new Intl.NumberFormat('de-DE', {
				style: 'currency',
				currency: 'EUR'
			}).format(price);
		};

		const updatePriceDisplay = (priceData: typeof currentPriceData) => {
			currentPriceData = priceData;
			
			// Update unit price
			unitPrice.textContent = formatPrice(priceData.unitPrice);
			
			// Update total price
			totalPrice.textContent = formatPrice(priceData.total);

			// Show/hide discount badge
			if (priceData.discountPercent > 0) {
				if (discountBadge && discountPercent) {
					discountBadge.classList.remove('hidden');
					discountPercent.textContent = `-${priceData.discountPercent.toFixed(0)}%`;
				}
				// Show original price with strikethrough
				if (originalPriceContainer && originalUnitPrice) {
					originalPriceContainer.classList.remove('hidden');
					originalUnitPrice.textContent = formatPrice(priceData.basePrice);
				}
			} else {
				if (discountBadge) {
					discountBadge.classList.add('hidden');
				}
				if (originalPriceContainer) {
					originalPriceContainer.classList.add('hidden');
				}
			}
		};

		const fetchPrice = async (quantity: number) => {
			if (!productSlug) {
				// Fallback to client-side calculation if no slug
				const total = basePrice * quantity;
				updatePriceDisplay({
					unitPrice: basePrice,
					basePrice: basePrice,
					discountPercent: 0,
					total: total,
				});
				return;
			}

			try {
				const response = await fetch(`/api/products/${productSlug}/price?quantity=${quantity}`);
				const result = await response.json();

				if (result.success && result.data) {
					updatePriceDisplay({
						unitPrice: result.data.unitPrice,
						basePrice: result.data.basePrice,
						discountPercent: result.data.discountPercent,
						total: result.data.total,
					});
				} else {
					// Fallback on error
					const total = basePrice * quantity;
					updatePriceDisplay({
						unitPrice: basePrice,
						basePrice: basePrice,
						discountPercent: 0,
						total: total,
					});
				}
			} catch (error) {
				console.error('Error fetching price:', error);
				// Fallback on error
				const total = basePrice * quantity;
				updatePriceDisplay({
					unitPrice: basePrice,
					basePrice: basePrice,
					discountPercent: 0,
					total: total,
				});
			}
		};

		const updatePriceTierHighlight = (quantity: number) => {
			const tierRows = document.querySelectorAll('.price-tier-row');
			tierRows.forEach((row) => {
				const minQty = parseInt(row.getAttribute('data-min-quantity') || '0');
				const maxQtyAttr = row.getAttribute('data-max-quantity');
				const maxQty = maxQtyAttr === '999999' || !maxQtyAttr ? Infinity : parseInt(maxQtyAttr);

				// Remove existing highlight classes
				row.classList.remove('bg-success/20', 'border-l-4', 'border-success', 'shadow-sm');

				// Check if current quantity falls within this tier
				if (quantity >= minQty && quantity <= maxQty) {
					row.classList.add('bg-success/20', 'border-l-4', 'border-success', 'shadow-sm');
				}
			});
		};

		// Load zusatzleistungen for this product
		const loadZusatzleistungen = async () => {
			if (!productSlug) return;

			try {
				const response = await fetch(`/api/products/${productSlug}/zusatzleistungen`);
				const result = await response.json();

				if (result.success && result.data.length > 0) {
					availableZusatzleistungen = result.data;
					renderZusatzleistungen();
					document.getElementById('zusatzleistungen-section')?.classList.remove('hidden');
				}
			} catch (error) {
				console.error('Error loading zusatzleistungen:', error);
			}
		};

		// Render zusatzleistungen checkboxes
		const renderZusatzleistungen = () => {
			const container = document.getElementById('zusatzleistungen-checkboxes');
			if (!container) return;

			container.innerHTML = availableZusatzleistungen.map(service => `
				<label class="flex items-start gap-3 p-3 bg-base-100 rounded-lg border border-base-300/50 hover:border-primary/30 cursor-pointer transition-all">
					<input
						type="checkbox"
						class="checkbox checkbox-primary checkbox-sm mt-0.5"
						data-zusatzleistung-id="${service.id}"
						data-zusatzleistung-price="${service.price}"
						onchange="window.updateZusatzleistungenTotal()"
					/>
					<div class="flex-1 min-w-0">
						<div class="flex items-baseline justify-between gap-2">
							<span class="text-sm font-medium text-neutral">${service.name}</span>
							<span class="text-sm font-semibold text-primary">+${formatPrice(service.price)}</span>
						</div>
						${service.description ? `<p class="text-xs text-neutral/60 mt-1">${service.description}</p>` : ''}
					</div>
				</label>
			`).join('');
		};

		// Update zusatzleistungen total
		(window as any).updateZusatzleistungenTotal = function() {
			const checkboxes = document.querySelectorAll<HTMLInputElement>('#zusatzleistungen-checkboxes input[type="checkbox"]:checked');
			let total = 0;
			selectedZusatzleistungIds = [];

			checkboxes.forEach(cb => {
				total += parseFloat(cb.dataset.zusatzleistungPrice || '0');
				const id = cb.dataset.zusatzleistungId;
				if (id) selectedZusatzleistungIds.push(id);
			});

			const totalDisplay = document.getElementById('zusatzleistungen-total-display');
			const totalElement = document.getElementById('zusatzleistungen-total');

			if (total > 0) {
				totalDisplay?.classList.remove('hidden');
				if (totalElement) totalElement.textContent = formatPrice(total);
			} else {
				totalDisplay?.classList.add('hidden');
			}
		};

		const updateTotal = () => {
			const quantity = parseInt(quantityInput.value) || 1;
			fetchPrice(quantity);
			updatePriceTierHighlight(quantity);
		};

		// Initial price fetch
		updateTotal();

		// Load zusatzleistungen
		loadZusatzleistungen();

		quantityDecrease?.addEventListener('click', () => {
			const current = parseInt(quantityInput.value) || 1;
			if (current > 1) {
				quantityInput.value = (current - 1).toString();
				updateTotal();
			}
		});

		quantityIncrease?.addEventListener('click', () => {
			const current = parseInt(quantityInput.value) || 1;
			if (current < 100) {
				quantityInput.value = (current + 1).toString();
				updateTotal();
			}
		});

		quantityInput.addEventListener('input', () => {
			const value = parseInt(quantityInput.value);
			if (value < 1) quantityInput.value = '1';
			if (value > 100) quantityInput.value = '100';
			updateTotal();
		});

		// Show success toast notification
		const showSuccessToast = (message: string) => {
			// Create toast container if it doesn't exist
			let toastContainer = document.getElementById('toast-container');
			if (!toastContainer) {
				toastContainer = document.createElement('div');
				toastContainer.id = 'toast-container';
				toastContainer.className = 'fixed top-20 right-4 z-[200] space-y-2';
				document.body.appendChild(toastContainer);
			}

			// Create toast element
			const toast = document.createElement('div');
			toast.className = 'alert alert-success shadow-lg flex items-center gap-2 px-4 py-3 rounded-lg min-w-[300px] animate-slide-in';
			toast.innerHTML = `
				<svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
				</svg>
				<span class="text-sm font-medium">${message}</span>
			`;

			toastContainer.appendChild(toast);

			// Remove toast after 3 seconds
			setTimeout(() => {
				toast.classList.add('animate-fade-out');
				setTimeout(() => {
					toast.remove();
				}, 300);
			}, 3000);
		};

		const addToCartBtn = document.getElementById('add-to-cart-btn') as HTMLButtonElement;
		
		addToCartBtn?.addEventListener('click', async () => {
			const quantity = parseInt(quantityInput.value) || 1;
			const productId = addToCartBtn.getAttribute('data-product-id');

			if (!productId) {
				alert('Produktfehler. Bitte laden Sie die Seite neu.');
				return;
			}

			// Get uploaded file info if available
			const getUploadedFileInfo = (window as any).getUploadedFileInfo;
			const uploadedFile = getUploadedFileInfo ? getUploadedFileInfo() : null;

			// Show loading state
			addToCartBtn.disabled = true;
			const originalText = addToCartBtn.innerHTML;
			addToCartBtn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Wird hinzugefügt...';

			try {
				const requestBody: {
					productId: string;
					quantity: number;
					zusatzleistungIds?: string[];
					uploadedFileUrl?: string;
					uploadedFileName?: string;
					fileMetadata?: any;
				} = {
					productId,
					quantity,
				};

				// Include zusatzleistungen if selected
				if (selectedZusatzleistungIds.length > 0) {
					requestBody.zusatzleistungIds = selectedZusatzleistungIds;
				}

				// Include uploaded file info if available
				if (uploadedFile) {
					requestBody.uploadedFileUrl = uploadedFile.fileUrl;
					requestBody.uploadedFileName = uploadedFile.fileName;
					requestBody.fileMetadata = uploadedFile.metadata;
				}

				const response = await fetch('/api/cart/add', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify(requestBody),
				});

				const result = await response.json();

				if (response.status === 401) {
					// User not logged in
					alert('Bitte melden Sie sich an, um Produkte in den Warenkorb zu legen.');
					(window as any).openAuthModal('login');
					return;
				}

				if (result.success) {
					// Clear uploaded file from session storage since it's now in the cart
					if (uploadedFile) {
						sessionStorage.removeItem('uploadedDesignFile');
						// Trigger file removal event for the upload UI
						window.dispatchEvent(new CustomEvent('designFileAddedToCart'));
					}

					// Show success message
					addToCartBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> Hinzugefügt!';
					addToCartBtn.classList.add('btn-success');

					// Show success toast notification
					showSuccessToast(`${productName} wurde zum Warenkorb hinzugefügt`);

					// Dispatch event to update full cart UI - this will handle badge and icon updates
					window.dispatchEvent(new CustomEvent('cartItemAdded', {
						detail: {
							cartCount: result.data.cartCount,
							productName: productName
						}
					}));

					// Reset button after 2 seconds
					setTimeout(() => {
						addToCartBtn.innerHTML = originalText;
						addToCartBtn.classList.remove('btn-success');
						addToCartBtn.disabled = false;
					}, 2000);
				} else {
					throw new Error(result.error?.message || 'Fehler beim Hinzufügen zum Warenkorb');
				}
			} catch (error: unknown) {
				console.error('Error adding to cart:', error);
				const errorMessage = error instanceof Error ? error.message : 'Fehler beim Hinzufügen zum Warenkorb. Bitte versuchen Sie es erneut.';
				alert(errorMessage);
				addToCartBtn.innerHTML = originalText;
				addToCartBtn.disabled = false;
			}
		});

		quoteBtn?.addEventListener('click', () => {
			const quantity = parseInt(quantityInput.value) || 1;
			// In a real app, this would open a contact form or redirect
			alert(`Angebot anfordern für: ${quantity}x ${productName}`);
		});
	});
</script>

<style>
	/* Hide number input spinner buttons */
	.no-spinner::-webkit-outer-spin-button,
	.no-spinner::-webkit-inner-spin-button {
		-webkit-appearance: none;
		margin: 0;
	}

	.no-spinner {
		-moz-appearance: textfield;
	}

	/* Toast animations */
	@keyframes slideIn {
		from {
			transform: translateX(100%);
			opacity: 0;
		}
		to {
			transform: translateX(0);
			opacity: 1;
		}
	}

	@keyframes fadeOut {
		from {
			opacity: 1;
		}
		to {
			opacity: 0;
		}
	}

	.animate-slide-in {
		animation: slideIn 0.3s ease-out;
	}

	.animate-fade-out {
		animation: fadeOut 0.3s ease-out;
	}
</style>
