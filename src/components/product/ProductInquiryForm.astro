---
interface Props {
	productId: string;
	productName: string;
	productSlug: string;
}

const { productId, productName, productSlug } = Astro.props;
---

<div class="product-inquiry-form space-y-5">
	<!-- Info Banner -->
	<div class="alert alert-info">
		<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
			<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
		</svg>
		<div>
			<h3 class="font-bold">Anfrage erforderlich</h3>
			<div class="text-sm">
				Dieses Produkt ist nicht direkt bestellbar. Bitte füllen Sie das Formular aus und wir erstellen Ihnen ein individuelles Angebot.
			</div>
		</div>
	</div>

	<!-- Inquiry Form -->
	<div class="product-container rounded-xl p-6 space-y-4">
		<h3 class="text-xl font-bold text-neutral flex items-center gap-2">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
			</svg>
			Anfrage stellen
		</h3>

		<form id="product-inquiry-form" class="space-y-4">
			<!-- Name Field -->
			<div class="form-control">
				<label class="label">
					<span class="label-text font-semibold">Name <span class="text-error">*</span></span>
				</label>
				<input
					type="text"
					name="name"
					placeholder="Ihr Name"
					class="input input-bordered w-full"
					required
				/>
			</div>

			<!-- Email Field -->
			<div class="form-control">
				<label class="label">
					<span class="label-text font-semibold">E-Mail <span class="text-error">*</span></span>
				</label>
				<input
					type="email"
					name="email"
					placeholder="ihre.email@beispiel.de"
					class="input input-bordered w-full"
					required
				/>
			</div>

			<!-- Phone Field (Optional) -->
			<div class="form-control">
				<label class="label">
					<span class="label-text font-semibold">Telefon (Optional)</span>
				</label>
				<input
					type="tel"
					name="phone"
					placeholder="+49 123 456789"
					class="input input-bordered w-full"
				/>
			</div>

			<!-- Message Field -->
			<div class="form-control">
				<label class="label">
					<span class="label-text font-semibold">Ihre Nachricht <span class="text-error">*</span></span>
				</label>
				<textarea
					name="message"
					placeholder="Bitte beschreiben Sie Ihre Anfrage oder Wünsche für dieses Produkt..."
					class="textarea textarea-bordered w-full h-32"
					required
				></textarea>
				<label class="label">
					<span class="label-text-alt">Mindestens 10 Zeichen</span>
				</label>
			</div>

			<!-- Product Info (Hidden) -->
			<input type="hidden" name="productId" value={productId} />
			<input type="hidden" name="productName" value={productName} />
			<input type="hidden" name="productSlug" value={productSlug} />

			<!-- Submit Button -->
			<button
				type="submit"
				class="btn btn-primary btn-lg w-full text-lg font-semibold shadow-lg hover:shadow-xl transition-all"
				id="inquiry-submit-btn"
			>
				<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
				</svg>
				Anfrage absenden
			</button>
		</form>

		<!-- Success Message (Hidden by default) -->
		<div id="inquiry-success" class="hidden">
			<div class="alert alert-success">
				<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
				</svg>
				<div>
					<h3 class="font-bold">Anfrage erfolgreich gesendet!</h3>
					<div class="text-sm">Wir haben Ihre Anfrage erhalten und melden uns schnellstmöglich bei Ihnen.</div>
				</div>
			</div>
		</div>

		<!-- Error Message (Hidden by default) -->
		<div id="inquiry-error" class="hidden">
			<div class="alert alert-error">
				<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
				</svg>
				<div>
					<h3 class="font-bold">Fehler beim Senden</h3>
					<div class="text-sm" id="inquiry-error-message">Bitte versuchen Sie es später erneut.</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Trust Badges -->
	<div class="grid grid-cols-1 gap-4 pt-6 border-t border-base-300/20">
		<div class="flex items-center gap-3 text-sm text-neutral/70">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-success flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
			</svg>
			<span>Kostenlose und unverbindliche Beratung</span>
		</div>
		<div class="flex items-center gap-3 text-sm text-neutral/70">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-success flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
			</svg>
			<span>Individuelle Angebote nach Ihren Wünschen</span>
		</div>
		<div class="flex items-center gap-3 text-sm text-neutral/70">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-success flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
			</svg>
			<span>Antwort innerhalb von 24 Stunden</span>
		</div>
	</div>
</div>

<script>
	document.addEventListener('DOMContentLoaded', () => {
		const form = document.getElementById('product-inquiry-form') as HTMLFormElement;
		const submitBtn = document.getElementById('inquiry-submit-btn') as HTMLButtonElement;
		const successMessage = document.getElementById('inquiry-success');
		const errorMessage = document.getElementById('inquiry-error');
		const errorMessageText = document.getElementById('inquiry-error-message');

		if (!form || !submitBtn) return;

		form.addEventListener('submit', async (e) => {
			e.preventDefault();

			// Hide previous messages
			successMessage?.classList.add('hidden');
			errorMessage?.classList.add('hidden');

			// Get form data
			const formData = new FormData(form);
			const data = {
				name: formData.get('name') as string,
				email: formData.get('email') as string,
				phone: formData.get('phone') as string,
				message: formData.get('message') as string,
				productId: formData.get('productId') as string,
				productName: formData.get('productName') as string,
				productSlug: formData.get('productSlug') as string,
			};

			// Validate message length
			if (data.message.length < 10) {
				errorMessageText!.textContent = 'Bitte geben Sie eine ausführlichere Nachricht ein (mindestens 10 Zeichen).';
				errorMessage?.classList.remove('hidden');
				return;
			}

			// Show loading state
			submitBtn.disabled = true;
			const originalText = submitBtn.innerHTML;
			submitBtn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Wird gesendet...';

			try {
				const response = await fetch('/api/product-inquiry', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify(data),
				});

				const result = await response.json();

				if (result.success) {
					// Show success message
					successMessage?.classList.remove('hidden');

					// Hide form
					form.style.display = 'none';

					// Scroll to success message
					successMessage?.scrollIntoView({ behavior: 'smooth', block: 'center' });

					// Optional: Reset form after a delay
					setTimeout(() => {
						form.reset();
					}, 1000);
				} else {
					throw new Error(result.error || 'Fehler beim Senden der Anfrage');
				}
			} catch (error: unknown) {
				console.error('Error submitting inquiry:', error);
				const errorMsg = error instanceof Error ? error.message : 'Ein Fehler ist aufgetreten. Bitte versuchen Sie es später erneut.';
				errorMessageText!.textContent = errorMsg;
				errorMessage?.classList.remove('hidden');

				// Reset button
				submitBtn.innerHTML = originalText;
				submitBtn.disabled = false;
			}
		});
	});
</script>
