---
import { pool } from '../lib/db';

const user = Astro.locals.user;

// Fetch cart with price tier information
let cartItems: any[] = [];
let hasCartItems = false;
let subtotal = 0;

if (user) {
	const response = await fetch(`${Astro.url.origin}/api/cart/get`, {
		headers: {
			'Cookie': Astro.request.headers.get('Cookie') || '',
		},
	});
	
	if (response.ok) {
		const result = await response.json();
		if (result.success) {
			cartItems = result.data.items || [];
			hasCartItems = cartItems.length > 0;
			subtotal = result.data.subtotal || 0;
		}
	}
}

const formatPrice = (price: number) => {
	return new Intl.NumberFormat('de-DE', {
		style: 'currency',
		currency: 'EUR'
	}).format(price);
};
---

<!-- Cart Icon & Dropdown -->
{user ? (
	<div class="dropdown dropdown-end cart-dropdown relative">
		<button
			tabindex="0"
			class="w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all duration-200 cursor-pointer relative"
			style="border-color: #4B5563;"
			aria-label="Shopping cart"
			id="cart-icon-button"
		>
			<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 transition-colors" style="color: #4B5563;">
				<path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 1 0-7.5 0v4.5m11.356-1.993 1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 0 1-1.12-1.243l1.264-12A1.125 1.125 0 0 1 5.513 7.5h12.974c.576 0 1.059.435 1.119 1.007ZM8.625 10.5a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm7.5 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
			</svg>
			{hasCartItems && (
				<span class="absolute -top-2 -right-2 bg-accent text-accent-content text-xs font-bold rounded-full min-w-[1.25rem] h-5 px-1 flex items-center justify-center shadow-md animate-badge-appear" id="cart-count-badge">
					{cartItems.length}
				</span>
			)}
		</button>
		
		<div tabindex="0" class="cart-dropdown-content absolute top-full mt-3 z-[100] shadow-2xl bg-base-100 rounded-xl w-96 border border-base-300/30 overflow-hidden opacity-0 invisible transform translate-y-2 transition-all duration-300 ease-out">
			{hasCartItems ? (
				<div class="max-h-[500px] flex flex-col">
					<!-- Header -->
					<div class="p-4 bg-base-200 border-b border-base-200">
						<div class="flex items-center justify-between">
							<h3 class="text-lg font-bold text-neutral flex items-center gap-2">
								<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="color: var(--color-metrics-text);">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
								</svg>
								Warenkorb
							</h3>
						</div>
					</div>

					<!-- Cart Items -->
					<div class="overflow-y-auto flex-1 p-4 space-y-3" id="cart-items-container">
						{cartItems.map((item) => (
							<div class="cart-item relative flex gap-3 p-3 bg-base-200/30 rounded-lg border border-base-300/50 transition-colors" data-cart-item-id={item.id}>
								<!-- Product Image -->
								<div class="flex-shrink-0">
									<div class="w-16 h-16 bg-base-300 rounded-lg overflow-hidden">
										{item.productImage ? (
											<img src={item.productImage} alt={item.productName} class="w-full h-full object-cover" />
										) : (
											<div class="w-full h-full flex items-center justify-center text-neutral/20">
												<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
													<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
												</svg>
											</div>
										)}
									</div>
								</div>

								<!-- Product Info -->
								<div class="flex-1 min-w-0 flex flex-col">
									<a href={`/product/${item.productSlug}`} class="text-sm font-medium text-neutral menu-link-hover transition-colors line-clamp-2 mb-1">
										{item.productName}
									</a>
									<!-- Price with Savings right beside it -->
									<div class="flex items-center gap-2 flex-wrap">
										<span class="text-xs text-neutral/60">Stückpreis:</span>
										<span class="text-sm font-semibold text-primary cart-item-unit-price" data-cart-item-id={item.id}>{formatPrice(item.unitPrice)}</span>
										{item.currentSavings > 0 && (
											<span class="savings-indicator text-xs text-success flex items-center gap-1">
												<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
													<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
												</svg>
												Sie sparen {formatPrice(item.currentSavings)}
											</span>
										)}
									</div>
								</div>

								<!-- Item Total with Quantity Selector Below -->
								<div class="flex-shrink-0 text-right flex flex-col items-end">
									<div class="text-sm font-bold text-neutral cart-item-total mb-1">
										{formatPrice(item.unitPrice * item.quantity)}
									</div>
									<!-- Quantity Controls under total price -->
									<div class="flex items-center gap-1">
										<button 
											class="quantity-decrease btn btn-xs btn-ghost p-0.5 h-5 w-5 min-h-0 text-neutral/70 menu-link-hover"
											data-cart-item-id={item.id}
											aria-label="Menge verringern"
										>
											<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
											</svg>
										</button>
										<span class="cart-item-quantity text-xs font-medium px-1 min-w-[1.5rem] text-center">{item.quantity}</span>
										<button 
											class="quantity-increase btn btn-xs btn-ghost p-0.5 h-5 w-5 min-h-0 text-neutral/70 menu-link-hover"
											data-cart-item-id={item.id}
											aria-label="Menge erhöhen"
										>
											<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
											</svg>
										</button>
									</div>
								</div>

								<!-- Delete button at bottom right -->
								<button 
									class="remove-item absolute bottom-2 right-2 btn btn-sm btn-ghost h-7 w-7 min-h-0 p-1 text-error hover:bg-error/10"
									data-cart-item-id={item.id}
									aria-label="Entfernen"
								>
									<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
									</svg>
								</button>
							</div>
						))}
					</div>

					<!-- Footer -->
					<div class="p-4 border-t border-base-200 bg-base-100">
						<!-- Subtotal -->
						<div class="flex justify-between items-center mb-3">
							<span class="text-sm text-neutral/70">Zwischensumme</span>
							<span class="text-lg font-bold text-neutral" id="cart-subtotal">{formatPrice(subtotal)}</span>
						</div>

						<!-- Action Buttons -->
						<div class="space-y-2">
							<a href="/checkout" class="btn btn-primary btn-block">
								Zur Kasse
							</a>
							<a href="/cart" class="btn btn-outline btn-block text-sm">
								Warenkorb ansehen
							</a>
						</div>
					</div>
				</div>
			) : (
				<!-- Empty Cart State -->
				<div class="p-8 text-center">
					<div class="w-20 h-20 mx-auto mb-4 bg-base-200 rounded-full flex items-center justify-center">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-neutral/30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
						</svg>
					</div>
					<h3 class="text-lg font-bold text-neutral mb-2">Warenkorb ist leer</h3>
					<p class="text-sm text-neutral/60 mb-4">Fügen Sie Produkte hinzu, um fortzufahren</p>
					<a href="/products" class="btn btn-primary btn-sm">
						Produkte ansehen
					</a>
				</div>
			)}
		</div>
	</div>
) : (
	<!-- Not logged in - redirect to login when clicking cart -->
	<button
		id="cart-login-prompt"
		class="w-8 h-8 rounded-full border-2 flex items-center justify-center transition-all duration-200 cursor-pointer"
		style="border-color: #4B5563;"
		aria-label="Shopping cart - Login required"
	>
		<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4" style="color: #4B5563;">
			<path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 1 0-7.5 0v4.5m11.356-1.993 1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 0 1-1.12-1.243l1.264-12A1.125 1.125 0 0 1 5.513 7.5h12.974c.576 0 1.059.435 1.119 1.007ZM8.625 10.5a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm7.5 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
		</svg>
	</button>
)}

<style>
	/* Badge appear animation */
	@keyframes badgeAppear {
		from {
			transform: scale(0);
			opacity: 0;
		}
		to {
			transform: scale(1);
			opacity: 1;
		}
	}

	.animate-badge-appear {
		animation: badgeAppear 0.3s ease-out;
	}

	/* Cart dropdown styles with hover bridge */
	.cart-dropdown {
		position: relative;
	}

	/* Create invisible bridge between button and dropdown */
	.cart-dropdown::before {
		content: '';
		position: absolute;
		top: 100%;
		left: -20px;
		right: -20px;
		height: 1rem;
		pointer-events: none;
		z-index: 99;
	}

	.cart-dropdown:hover::before {
		pointer-events: auto;
	}

	.cart-dropdown-content {
		pointer-events: none;
		transition: opacity 0.2s ease-out, visibility 0.2s ease-out, transform 0.2s ease-out;
		transition-delay: 0s;
		/* Align to the right like profile dropdown */
		right: 0;
		/* Ensure it doesn't overflow viewport */
		max-width: calc(100vw - 2rem);
	}

	.cart-dropdown:hover .cart-dropdown-content,
	.cart-dropdown-content:hover,
	.cart-dropdown-content:focus-within {
		opacity: 1;
		visibility: visible;
		transform: translateY(0);
		pointer-events: auto;
		transition-delay: 0s;
	}

	.cart-dropdown:not(:hover) .cart-dropdown-content:not(:hover):not(:focus-within) {
		opacity: 0;
		visibility: hidden;
		transform: translateY(2px);
		transition-delay: 0.3s;
	}

	/* Mobile and Tablet: Better centered positioning */
	@media (max-width: 1023px) {
		.cart-dropdown-content {
			/* Position relative to viewport, not parent */
			position: fixed !important;
			right: auto !important;
			left: 50% !important;
			top: 4.5rem !important;
			transform: translateX(-50%) translateY(2px) !important;
			width: calc(100vw - 2rem) !important;
			max-width: 24rem !important;
			margin-top: 0 !important;
		}

		.cart-dropdown:hover .cart-dropdown-content,
		.cart-dropdown-content:hover,
		.cart-dropdown-content:focus-within {
			transform: translateX(-50%) translateY(0) !important;
		}

		.cart-dropdown:not(:hover) .cart-dropdown-content:not(:hover):not(:focus-within) {
			transform: translateX(-50%) translateY(2px) !important;
		}
	}
</style>

<script>
	// Cart management functions
	const formatPrice = (price: number) => {
		return new Intl.NumberFormat('de-DE', {
			style: 'currency',
			currency: 'EUR'
		}).format(price);
	};

	// Escape HTML to prevent XSS
	const escapeHtml = (text: string) => {
		const div = document.createElement('div');
		div.textContent = text;
		return div.innerHTML;
	};

	// Render a single cart item
	const renderCartItem = (item: any) => {
		const savingsHtml = item.currentSavings > 0 
			? `<span class="savings-indicator text-xs text-success flex items-center gap-1">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
					</svg>
					Sie sparen ${formatPrice(item.currentSavings)}
				</span>`
			: '';

		const imageHtml = item.productImage
			? `<img src="${escapeHtml(item.productImage)}" alt="${escapeHtml(item.productName)}" class="w-full h-full object-cover" />`
			: `<div class="w-full h-full flex items-center justify-center text-neutral/20">
					<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
					</svg>
				</div>`;

		return `
			<div class="cart-item relative flex gap-3 p-3 bg-base-200/30 rounded-lg border border-base-300/50 transition-colors" data-cart-item-id="${escapeHtml(item.id)}">
				<!-- Product Image -->
				<div class="flex-shrink-0">
					<div class="w-16 h-16 bg-base-300 rounded-lg overflow-hidden">
						${imageHtml}
					</div>
				</div>

				<!-- Product Info -->
				<div class="flex-1 min-w-0 flex flex-col">
					<a href="/product/${escapeHtml(item.productSlug)}" class="text-sm font-medium text-neutral menu-link-hover transition-colors line-clamp-2 mb-1">
						${escapeHtml(item.productName)}
					</a>
					<!-- Price with Savings right beside it -->
					<div class="flex items-center gap-2 flex-wrap">
						<span class="text-xs text-neutral/60">Stückpreis:</span>
						<span class="text-sm font-semibold text-primary cart-item-unit-price" data-cart-item-id="${escapeHtml(item.id)}">${formatPrice(item.unitPrice)}</span>
						${savingsHtml}
					</div>
				</div>

				<!-- Item Total with Quantity Selector Below -->
				<div class="flex-shrink-0 text-right flex flex-col items-end">
					<div class="text-sm font-bold text-neutral cart-item-total mb-1">
						${formatPrice(item.unitPrice * item.quantity)}
					</div>
					<!-- Quantity Controls under total price -->
					<div class="flex items-center gap-1">
						<button 
							class="quantity-decrease btn btn-xs btn-ghost p-0.5 h-5 w-5 min-h-0 text-neutral/70 menu-link-hover"
							data-cart-item-id="${escapeHtml(item.id)}"
							aria-label="Menge verringern"
						>
							<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
							</svg>
						</button>
						<span class="cart-item-quantity text-xs font-medium px-1 min-w-[1.5rem] text-center">${item.quantity}</span>
						<button 
							class="quantity-increase btn btn-xs btn-ghost p-0.5 h-5 w-5 min-h-0 text-neutral/70 menu-link-hover"
							data-cart-item-id="${escapeHtml(item.id)}"
							aria-label="Menge erhöhen"
						>
							<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
							</svg>
						</button>
					</div>
				</div>

				<!-- Delete button at bottom right -->
				<button 
					class="remove-item absolute bottom-2 right-2 btn btn-sm btn-ghost h-7 w-7 min-h-0 p-1 text-error hover:bg-error/10"
					data-cart-item-id="${escapeHtml(item.id)}"
					aria-label="Entfernen"
				>
					<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
					</svg>
				</button>
			</div>
		`;
	};

	// Re-render all cart items
	const renderCartItems = (items: any[]) => {
		const container = document.getElementById('cart-items-container');
		if (!container) {
			// If container doesn't exist (empty cart initially), we might need to reload
			// But for now, just return - the page will show empty state from server
			return;
		}

		if (items.length === 0) {
			// If cart becomes empty, reload to show empty state
			// This is simpler than dynamically showing/hiding the empty state structure
			window.location.reload();
			return;
		}

		container.innerHTML = items.map(item => renderCartItem(item)).join('');
		
		// Re-attach event listeners
		attachCartItemListeners();
	};

	// Attach event listeners to cart items
	const attachCartItemListeners = () => {
		// Quantity decrease buttons
		document.querySelectorAll('.quantity-decrease').forEach((button) => {
			button.addEventListener('click', async (e) => {
				e.preventDefault();
				const buttonElement = e.currentTarget as HTMLElement;
				const cartItemId = buttonElement.getAttribute('data-cart-item-id');
				if (!cartItemId) return;

				const quantityElement = document.querySelector(`[data-cart-item-id="${cartItemId}"] .cart-item-quantity`);
				const currentQuantity = parseInt(quantityElement?.textContent || '1');

				if (currentQuantity > 1) {
					// Disable buttons during update
					const cartItemElement = document.querySelector(`[data-cart-item-id="${cartItemId}"]`);
					const buttons = cartItemElement?.querySelectorAll('button');
					buttons?.forEach(btn => (btn as HTMLButtonElement).disabled = true);

					await updateCartItemQuantity(cartItemId, currentQuantity - 1);

					// Re-enable buttons after update
					buttons?.forEach(btn => (btn as HTMLButtonElement).disabled = false);
				}
			});
		});

		// Quantity increase buttons
		document.querySelectorAll('.quantity-increase').forEach((button) => {
			button.addEventListener('click', async (e) => {
				e.preventDefault();
				const buttonElement = e.currentTarget as HTMLElement;
				const cartItemId = buttonElement.getAttribute('data-cart-item-id');
				if (!cartItemId) return;

				const quantityElement = document.querySelector(`[data-cart-item-id="${cartItemId}"] .cart-item-quantity`);
				const currentQuantity = parseInt(quantityElement?.textContent || '1');

				// Disable buttons during update
				const cartItemElement = document.querySelector(`[data-cart-item-id="${cartItemId}"]`);
				const buttons = cartItemElement?.querySelectorAll('button');
				buttons?.forEach(btn => (btn as HTMLButtonElement).disabled = true);

				await updateCartItemQuantity(cartItemId, currentQuantity + 1);

				// Re-enable buttons after update
				buttons?.forEach(btn => (btn as HTMLButtonElement).disabled = false);
			});
		});

		// Remove item buttons
		document.querySelectorAll('.remove-item').forEach((button) => {
			button.addEventListener('click', (e) => {
				e.preventDefault();
				e.stopPropagation();
				const cartItemId = (e.currentTarget as HTMLElement).getAttribute('data-cart-item-id');
				if (!cartItemId) return;

				removeCartItem(cartItemId);
			});
		});
	};

	const updateCartUI = async (showAnimation = false) => {
		try {
			const response = await fetch('/api/cart/get');
			const result = await response.json();

			if (result.success) {
				const { items, count, subtotal } = result.data;

				// Update cart count badge
				const cartCountBadge = document.getElementById('cart-count-badge');
				const cartIconButton = document.getElementById('cart-icon-button');

				if (count > 0) {
					if (cartCountBadge) {
						cartCountBadge.textContent = count.toString();
						cartCountBadge.style.display = 'flex';

						// Add bounce animation if requested
						if (showAnimation) {
							cartCountBadge.classList.add('animate-bounce');
							setTimeout(() => {
								cartCountBadge.classList.remove('animate-bounce');
							}, 1000);
						}
					} else {
						// Create badge if it doesn't exist - ALWAYS use accent (green) color
						if (cartIconButton) {
							const newBadge = document.createElement('span');
							newBadge.id = 'cart-count-badge';
							newBadge.className = 'absolute -top-2 -right-2 bg-accent text-accent-content text-xs font-bold rounded-full min-w-[1.25rem] h-5 px-1 flex items-center justify-center shadow-md';
							newBadge.textContent = count.toString();
							cartIconButton.appendChild(newBadge);

							// Add bounce animation if requested
							if (showAnimation) {
								newBadge.classList.add('animate-bounce');
								setTimeout(() => {
									newBadge.classList.remove('animate-bounce');
								}, 1000);
							}
						}
					}

					// Update cart icon styling - ALWAYS keep dark gray color
					if (cartIconButton) {
						const svgIcon = cartIconButton.querySelector('svg');
						if (svgIcon) {
							svgIcon.style.color = '#4B5563';
						}
						// Ensure border stays dark gray
						cartIconButton.style.borderColor = '#4B5563';
					}

					// Re-render cart items
					renderCartItems(items);
				} else {
					if (cartCountBadge) {
						cartCountBadge.style.display = 'none';
					}

					// Update cart icon styling to default
					if (cartIconButton) {
						const svgIcon = cartIconButton.querySelector('svg');
						if (svgIcon) {
							svgIcon.style.color = '#4B5563';
						}
						cartIconButton.style.borderColor = '#4B5563';
					}

					// Clear cart items
					renderCartItems([]);
				}

				// Update subtotal
				const cartSubtotal = document.getElementById('cart-subtotal');
				if (cartSubtotal) {
					cartSubtotal.textContent = formatPrice(subtotal);
				}

				// Dispatch event for other components
				window.dispatchEvent(new CustomEvent('cartUpdated', { detail: { count, items, subtotal } }));
			}
		} catch (error) {
			console.error('Error updating cart UI:', error);
		}
	};

	const updateCartItemQuantity = async (cartItemId: string, newQuantity: number) => {
		// Optimistic UI update - update immediately
		const cartItemElement = document.querySelector(`[data-cart-item-id="${cartItemId}"]`);
		const quantityElement = cartItemElement?.querySelector('.cart-item-quantity');
		const lineTotalElement = cartItemElement?.querySelector('.cart-item-total');
		const oldQuantity = quantityElement ? parseInt(quantityElement.textContent || '1') : newQuantity;

		// Get unit price from the item
		const unitPriceElement = cartItemElement?.querySelector('.cart-item-unit-price');
		const unitPriceText = unitPriceElement?.textContent || '0';
		const unitPrice = parseFloat(unitPriceText.replace(/[^0-9,]/g, '').replace(',', '.')) || 0;

		// Calculate new line total
		const newLineTotal = unitPrice * newQuantity;
		const oldLineTotal = unitPrice * oldQuantity;

		// Apply optimistic updates
		if (quantityElement) {
			quantityElement.textContent = newQuantity.toString();
		}
		if (lineTotalElement) {
			lineTotalElement.textContent = formatPrice(newLineTotal);
		}

		// Update subtotal optimistically
		const cartSubtotalElement = document.getElementById('cart-subtotal');
		if (cartSubtotalElement) {
			const currentSubtotalText = cartSubtotalElement.textContent || '0';
			const currentSubtotalValue = parseFloat(currentSubtotalText.replace(/[^0-9,]/g, '').replace(',', '.')) || 0;
			const newSubtotalValue = currentSubtotalValue - oldLineTotal + newLineTotal;
			cartSubtotalElement.textContent = formatPrice(newSubtotalValue);
		}

		try {
			const response = await fetch('/api/cart/update', {
				method: 'PUT',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ cartItemId, quantity: newQuantity }),
			});

			const result = await response.json();

			if (result.success) {
				// Update cart UI without page reload to get accurate server data
				await updateCartUI(false);
			} else {
				// Revert optimistic updates on error
				if (quantityElement) {
					quantityElement.textContent = oldQuantity.toString();
				}
				if (lineTotalElement) {
					lineTotalElement.textContent = formatPrice(oldLineTotal);
				}
				if (cartSubtotalElement) {
					const currentSubtotalText = cartSubtotalElement.textContent || '0';
					const currentSubtotalValue = parseFloat(currentSubtotalText.replace(/[^0-9,]/g, '').replace(',', '.')) || 0;
					const revertedSubtotal = currentSubtotalValue - newLineTotal + oldLineTotal;
					cartSubtotalElement.textContent = formatPrice(revertedSubtotal);
				}
				alert(result.error?.message || 'Fehler beim Aktualisieren des Warenkorbs');
			}
		} catch (error) {
			// Revert optimistic updates on error
			if (quantityElement) {
				quantityElement.textContent = oldQuantity.toString();
			}
			if (lineTotalElement) {
				lineTotalElement.textContent = formatPrice(oldLineTotal);
			}
			if (cartSubtotalElement) {
				const currentSubtotalText = cartSubtotalElement.textContent || '0';
				const currentSubtotalValue = parseFloat(currentSubtotalText.replace(/[^0-9,]/g, '').replace(',', '.')) || 0;
				const revertedSubtotal = currentSubtotalValue - newLineTotal + oldLineTotal;
				cartSubtotalElement.textContent = formatPrice(revertedSubtotal);
			}
			console.error('Error updating cart item:', error);
			alert('Fehler beim Aktualisieren des Warenkorbs');
		}
	};

	const removeCartItem = async (cartItemId: string) => {
		if (!confirm('Möchten Sie diesen Artikel wirklich entfernen?')) {
			return;
		}

		try {
			const response = await fetch('/api/cart/remove', {
				method: 'DELETE',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ cartItemId }),
			});

			const result = await response.json();

			if (result.success) {
				// Update cart UI without page reload
				await updateCartUI();
			} else {
				alert(result.error?.message || 'Fehler beim Entfernen des Artikels');
			}
		} catch (error) {
			console.error('Error removing cart item:', error);
			alert('Fehler beim Entfernen des Artikels');
		}
	};

	// Event listeners
	document.addEventListener('DOMContentLoaded', () => {
		// Attach initial event listeners
		attachCartItemListeners();

		// Login prompt for non-authenticated users
		const cartLoginPrompt = document.getElementById('cart-login-prompt');
		if (cartLoginPrompt) {
			cartLoginPrompt.addEventListener('click', () => {
				(window as any).openAuthModal('login');
			});
		}
	});

	// Listen for cart updates from other parts of the app
	window.addEventListener('cartItemAdded', async () => {
		// Update cart UI without page reload with animation
		await updateCartUI(true);
	});

	// Also listen for page load to ensure cart is up to date
	window.addEventListener('load', () => {
		const cartIconButton = document.getElementById('cart-icon-button');
		if (cartIconButton) {
			updateCartUI(false);
		}
	});
</script>
