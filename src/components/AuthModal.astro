---
import { SITE_CONFIG } from '../constants/site';
---

<!-- Auth Modal - Modern German Design -->
<dialog id="auth-modal" class="modal modal-bottom sm:modal-middle">
  <div class="modal-box max-w-sm p-0 bg-base-100 shadow-2xl rounded-xl overflow-hidden">
    <!-- Close Button -->
    <form method="dialog" class="absolute right-4 top-4 z-10">
      <button 
        type="submit"
        class="btn btn-circle btn-ghost hover:bg-base-200/80 w-10 h-10 min-h-10 p-0 transition-all duration-200 hover:scale-110"
        aria-label="Schließen"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </form>

    <!-- Logo & Header -->
    <div class="pt-8 pb-5 px-6 text-center">
      <img
        src={SITE_CONFIG.brand.logo.primary}
        alt={SITE_CONFIG.brand.logo.alt}
        class="h-8 w-auto mx-auto mb-4"
      />
      <h2 class="text-xl font-bold text-base-content mb-1" id="modal-title">Willkommen zurück</h2>
      <p class="text-xs text-base-content/50" id="modal-subtitle">
        Melde dich an oder erstelle ein Konto
      </p>
    </div>

    <!-- Content -->
    <div class="px-6 pb-6">
      <!-- Login Form -->
      <div id="login-form-container">
        <form id="modal-login-form" class="space-y-3">
          <!-- Email -->
          <div>
            <label for="login-email" class="block text-xs font-medium text-base-content/70 mb-1.5">
              E-Mail-Adresse
            </label>
            <input
              id="login-email"
              type="email"
              name="email"
              placeholder="name@beispiel.de"
              class="input input-sm input-bordered w-full text-sm focus:input-primary"
              required
              autocomplete="email"
            />
          </div>

          <!-- Password -->
          <div>
            <div class="flex justify-between items-center mb-1.5">
              <label for="login-password" class="text-xs font-medium text-base-content/70">
                Passwort
              </label>
              <a href="/auth/forgot-password" class="text-xs link link-primary no-underline hover:underline">
                Vergessen?
              </a>
            </div>
            <input
              id="login-password"
              type="password"
              name="password"
              placeholder="••••••••••••"
              class="input input-sm input-bordered w-full text-sm focus:input-primary"
              required
              autocomplete="current-password"
            />
          </div>

          <!-- Error -->
          <div id="modal-login-error" class="alert alert-error alert-sm hidden py-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span class="text-xs"></span>
          </div>

          <!-- Submit -->
          <button
            type="submit"
            class="btn btn-primary btn-sm w-full text-sm font-medium mt-4"
            id="modal-login-button"
          >
            Anmelden
          </button>
        </form>

        <!-- Divider -->
        <div class="flex items-center gap-3 my-4">
          <div class="flex-1 border-t border-base-200"></div>
          <span class="text-xs text-base-content/40 font-medium">ODER</span>
          <div class="flex-1 border-t border-base-200"></div>
        </div>

        <!-- Switch to Signup -->
        <div class="text-center text-sm">
          Noch kein Konto? <button
            type="button"
            class="font-semibold text-primary ml-1 hover:underline cursor-pointer bg-transparent border-none p-0"
            id="switch-to-signup"
          >
            Registrieren
          </button>
        </div>
      </div>

      <!-- Signup Form -->
      <div id="signup-form-container" class="hidden">
        <form id="modal-signup-form" class="space-y-3">
          <!-- Name -->
          <div>
            <label for="signup-name" class="block text-xs font-medium text-base-content/70 mb-1.5">
              Vollständiger Name
            </label>
            <input
              id="signup-name"
              type="text"
              name="name"
              placeholder="Max Mustermann"
              class="input input-sm input-bordered w-full text-sm focus:input-primary"
              required
              autocomplete="name"
            />
          </div>

          <!-- Email -->
          <div>
            <label for="signup-email" class="block text-xs font-medium text-base-content/70 mb-1.5">
              E-Mail-Adresse
            </label>
            <input
              id="signup-email"
              type="email"
              name="email"
              placeholder="name@beispiel.de"
              class="input input-sm input-bordered w-full text-sm focus:input-primary"
              required
              autocomplete="email"
            />
          </div>

          <!-- Password -->
          <div>
            <label for="signup-password" class="block text-xs font-medium text-base-content/70 mb-1.5">
              Passwort
            </label>
            <input
              id="signup-password"
              type="password"
              name="password"
              placeholder="Sicheres Passwort erstellen"
              class="input input-sm input-bordered w-full text-sm focus:input-primary"
              required
              minlength="8"
              autocomplete="new-password"
            />
            <p class="text-xs text-base-content/40 mt-1.5">
              Min. 8 Zeichen
            </p>
          </div>

          <!-- Error -->
          <div id="modal-signup-error" class="alert alert-error alert-sm hidden py-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span class="text-xs"></span>
          </div>

          <!-- Success -->
          <div id="modal-signup-success" class="alert alert-success alert-sm hidden py-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <div class="text-xs">
              <p class="font-semibold mb-1">Konto erstellt!</p>
              <p>Bitte bestätige deine E-Mail-Adresse. Wir haben dir eine Bestätigungs-E-Mail gesendet.</p>
            </div>
          </div>

          <!-- Submit -->
          <button
            type="submit"
            class="btn btn-primary btn-sm w-full text-sm font-medium mt-4"
            id="modal-signup-button"
          >
            Konto erstellen
          </button>
        </form>

        <!-- Divider -->
        <div class="flex items-center gap-3 my-4">
          <div class="flex-1 border-t border-base-200"></div>
          <span class="text-xs text-base-content/40 font-medium">ODER</span>
          <div class="flex-1 border-t border-base-200"></div>
        </div>

        <!-- Switch to Login -->
        <div class="text-center text-sm">
          Bereits registriert? <button
            type="button"
            class="font-semibold text-primary ml-1 hover:underline cursor-pointer bg-transparent border-none p-0"
            id="switch-to-login"
          >
            Anmelden
          </button>
        </div>
      </div>
    </div>

    <!-- Footer - Security Features -->
    <div class="px-6 py-4 bg-base-200/20 border-t border-base-200">
      <div class="flex items-center justify-center gap-6">
        <!-- Secure Session Management -->
        <div class="flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-base-content/70" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
          </svg>
          <span class="text-xs text-base-content/70 font-bold">Sichere Sitzungen</span>
        </div>

        <!-- CSRF Protection -->
        <div class="flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-base-content/70" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
          </svg>
          <span class="text-xs text-base-content/70 font-bold">CSRF-Schutz</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Backdrop -->
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<style>
  /* Modern backdrop animation - smooth fade without sliding */
  #auth-modal::backdrop {
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    animation: backdrop-fade-in 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* DaisyUI modal-backdrop form element */
  #auth-modal + form.modal-backdrop {
    background: rgba(0, 0, 0, 0.5) !important;
    backdrop-filter: blur(8px) !important;
    -webkit-backdrop-filter: blur(8px) !important;
    animation: backdrop-fade-in 0.25s cubic-bezier(0.4, 0, 0.2, 1) !important;
    transform: none !important;
    transition: none !important;
  }

  @keyframes backdrop-fade-in {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  /* Modal animations */
  #auth-modal[open] {
    animation: modal-pop 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  @keyframes modal-pop {
    0% {
      opacity: 0;
      transform: scale(0.95) translateY(8px);
    }
    100% {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  /* Input focus */
  .input:focus {
    outline: none;
    border-color: var(--fallback-p, oklch(var(--p)));
    box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.08);
  }

  /* Compact form transitions */
  #login-form-container,
  #signup-form-container {
    transition: all 0.2s ease;
  }

  #login-form-container.hidden,
  #signup-form-container.hidden {
    opacity: 0;
    transform: translateY(-8px);
    pointer-events: none;
    position: absolute;
    width: 100%;
  }

  /* Tighter button spacing */
  .btn-sm {
    height: 2.25rem;
    min-height: 2.25rem;
    padding-left: 0.875rem;
    padding-right: 0.875rem;
  }

  /* Input sizing */
  .input-sm {
    height: 2.25rem;
    min-height: 2.25rem;
    padding-left: 0.75rem;
    padding-right: 0.75rem;
    font-size: 0.875rem;
  }

  /* Alert compact */
  .alert-sm {
    padding: 0.5rem 0.75rem;
    border-radius: 0.375rem;
  }
</style>

<script>
  import { authClient } from '../lib/auth-client';

  const modal = document.getElementById('auth-modal') as HTMLDialogElement;
  const loginContainer = document.getElementById('login-form-container') as HTMLDivElement;
  const signupContainer = document.getElementById('signup-form-container') as HTMLDivElement;
  const modalTitle = document.getElementById('modal-title') as HTMLHeadingElement;
  const modalSubtitle = document.getElementById('modal-subtitle') as HTMLParagraphElement;

  const switchToSignup = document.getElementById('switch-to-signup') as HTMLButtonElement;
  const switchToLogin = document.getElementById('switch-to-login') as HTMLButtonElement;

  // Function to translate error messages to German
  function translateError(errorMessage: string): string {
    const errorLower = errorMessage.toLowerCase();

    // Rate limiting errors
    if (errorLower.includes('too many requests') || errorLower.includes('rate limit')) {
      return 'Zu viele Anfragen. Bitte versuche es später erneut.';
    }

    // Email verification errors
    if (errorLower.includes('email') && (errorLower.includes('not verified') || errorLower.includes('unverified') || errorLower.includes('verification'))) {
      return 'E-Mail-Adresse nicht verifiziert. Bitte bestätige deine E-Mail-Adresse, bevor du dich anmeldest.';
    }
    if (errorLower.includes('email verification required') || errorLower.includes('please verify')) {
      return 'E-Mail-Verifizierung erforderlich. Bitte bestätige deine E-Mail-Adresse.';
    }

    // Common auth errors
    if (errorLower.includes('invalid credentials') || errorLower.includes('wrong password') || errorLower.includes('incorrect')) {
      return 'Ungültige Anmeldedaten. Bitte überprüfe deine E-Mail-Adresse und dein Passwort.';
    }
    if (errorLower.includes('user not found') || errorLower.includes('no account')) {
      return 'Kein Konto mit dieser E-Mail-Adresse gefunden.';
    }
    if (errorLower.includes('email already exists') || errorLower.includes('already registered') || errorLower.includes('already in use')) {
      return 'Diese E-Mail-Adresse ist bereits registriert.';
    }
    if (errorLower.includes('password') && (errorLower.includes('short') || errorLower.includes('length'))) {
      return 'Passwort zu kurz. Mindestens 8 Zeichen erforderlich.';
    }
    if (errorLower.includes('password') && errorLower.includes('weak')) {
      return 'Passwort zu schwach. Verwende Groß- und Kleinbuchstaben, Zahlen und Sonderzeichen.';
    }

    // Account status errors
    if (errorLower.includes('account locked') || errorLower.includes('account disabled')) {
      return 'Dein Konto wurde gesperrt. Bitte kontaktiere den Support.';
    }
    if (errorLower.includes('account suspended')) {
      return 'Dein Konto wurde vorübergehend gesperrt.';
    }

    // Session errors
    if (errorLower.includes('session expired') || errorLower.includes('session invalid')) {
      return 'Deine Sitzung ist abgelaufen. Bitte melde dich erneut an.';
    }

    // Network errors
    if (errorLower.includes('network error') || errorLower.includes('failed to fetch')) {
      return 'Netzwerkfehler. Bitte überprüfe deine Internetverbindung.';
    }
    if (errorLower.includes('timeout') || errorLower.includes('timed out')) {
      return 'Zeitüberschreitung. Bitte versuche es erneut.';
    }

    // Server errors
    if (errorLower.includes('server error') || errorLower.includes('internal error')) {
      return 'Serverfehler. Bitte versuche es später erneut.';
    }

    // Generic errors
    if (errorLower.includes('something went wrong')) {
      return 'Ein Fehler ist aufgetreten. Bitte versuche es erneut.';
    }

    // Return original message if no translation found
    return errorMessage;
  }

  // View switching
  function showLogin() {
    signupContainer.classList.add('hidden');
    setTimeout(() => {
      loginContainer.classList.remove('hidden');
      modalTitle.textContent = 'Willkommen zurück';
      modalSubtitle.textContent = 'Melde dich an oder erstelle ein Konto';
    }, 150);
  }

  function showSignup() {
    loginContainer.classList.add('hidden');
    setTimeout(() => {
      signupContainer.classList.remove('hidden');
      modalTitle.textContent = 'Konto erstellen';
      modalSubtitle.textContent = 'Starte in wenigen Sekunden';
    }, 150);
  }

  switchToSignup?.addEventListener('click', showSignup);
  switchToLogin?.addEventListener('click', showLogin);

  // Login form
  const loginForm = document.getElementById('modal-login-form') as HTMLFormElement;
  const loginError = document.getElementById('modal-login-error') as HTMLDivElement;
  const loginButton = document.getElementById('modal-login-button') as HTMLButtonElement;

  loginForm?.addEventListener('submit', async (e) => {
    e.preventDefault();

    loginError.classList.add('hidden');
    loginButton.disabled = true;
    loginButton.innerHTML = `
      <span class="loading loading-spinner loading-xs"></span>
      <span class="ml-2">Wird angemeldet...</span>
    `;

    const formData = new FormData(loginForm);
    const email = formData.get('email') as string;
    const password = formData.get('password') as string;

    try {
      const result = await authClient.signIn.email({
        email,
        password,
        rememberMe: true,
      });

      if (result.error) {
        throw new Error(result.error.message || 'Anmeldung fehlgeschlagen');
      }

      modal.close();
      window.location.reload();
    } catch (error) {
      console.error('Login error:', error);
      const errorMsg = error instanceof Error ? error.message : 'Ein Fehler ist aufgetreten';
      loginError.querySelector('span')!.textContent = translateError(errorMsg);
      loginError.classList.remove('hidden');
      loginButton.disabled = false;
      loginButton.textContent = 'Anmelden';
    }
  });

  // Signup form
  const signupForm = document.getElementById('modal-signup-form') as HTMLFormElement;
  const signupError = document.getElementById('modal-signup-error') as HTMLDivElement;
  const signupSuccess = document.getElementById('modal-signup-success') as HTMLDivElement;
  const signupButton = document.getElementById('modal-signup-button') as HTMLButtonElement;

  signupForm?.addEventListener('submit', async (e) => {
    e.preventDefault();

    signupError.classList.add('hidden');
    signupSuccess.classList.add('hidden');
    signupButton.disabled = true;
    signupButton.innerHTML = `
      <span class="loading loading-spinner loading-xs"></span>
      <span class="ml-2">Wird erstellt...</span>
    `;

    const formData = new FormData(signupForm);
    const name = formData.get('name') as string;
    const email = formData.get('email') as string;
    const password = formData.get('password') as string;

    try {
      if (password.length < 8) {
        throw new Error('Passwort muss mindestens 8 Zeichen enthalten');
      }

      const result = await authClient.signUp.email({
        email,
        password,
        name,
      });

      if (result.error) {
        throw new Error(result.error.message || 'Registrierung fehlgeschlagen');
      }

      signupSuccess.classList.remove('hidden');
      signupForm.reset();
      signupButton.innerHTML = `
        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
        </svg>
        <span class="ml-2">Erfolgreich!</span>
      `;

      setTimeout(() => {
        modal.close();
        window.location.reload();
      }, 2000);
    } catch (error) {
      console.error('Signup error:', error);
      const errorMsg = error instanceof Error ? error.message : 'Ein Fehler ist aufgetreten';
      signupError.querySelector('span')!.textContent = translateError(errorMsg);
      signupError.classList.remove('hidden');
      signupButton.disabled = false;
      signupButton.textContent = 'Konto erstellen';
    }
  });

  // Close modal on scroll
  let scrollTimeout: number | null = null;
  const handleScroll = () => {
    if (modal?.open) {
      // Clear any existing timeout
      if (scrollTimeout) {
        clearTimeout(scrollTimeout);
      }
      
      // Close modal after a small delay to prevent accidental closes
      scrollTimeout = window.setTimeout(() => {
        modal.close();
      }, 100);
    }
  };

  // Listen for modal opening to add scroll listener
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.type === 'attributes' && mutation.attributeName === 'open') {
        if (modal?.open) {
          // Add scroll listeners when modal opens
          window.addEventListener('scroll', handleScroll, true);
          window.addEventListener('wheel', handleScroll, true);
          window.addEventListener('touchmove', handleScroll, true);
        } else {
          // Remove scroll listeners when modal closes
          window.removeEventListener('scroll', handleScroll, true);
          window.removeEventListener('wheel', handleScroll, true);
          window.removeEventListener('touchmove', handleScroll, true);
        }
      }
    });
  });

  if (modal) {
    observer.observe(modal, { attributes: true, attributeFilter: ['open'] });
  }

  // Reset on close
  modal?.addEventListener('close', () => {
    // Remove scroll listeners
    window.removeEventListener('scroll', handleScroll, true);
    window.removeEventListener('wheel', handleScroll, true);
    window.removeEventListener('touchmove', handleScroll, true);
    
    if (scrollTimeout) {
      clearTimeout(scrollTimeout);
      scrollTimeout = null;
    }
    
    // Reset form state
    loginForm?.reset();
    signupForm?.reset();
    loginError.classList.add('hidden');
    signupError.classList.add('hidden');
    signupSuccess.classList.add('hidden');
    loginButton.disabled = false;
    loginButton.textContent = 'Anmelden';
    signupButton.disabled = false;
    signupButton.textContent = 'Konto erstellen';
    showLogin();
  });

  // Export open function
  (window as any).openAuthModal = (mode: 'login' | 'signup' = 'login') => {
    if (mode === 'signup') {
      showSignup();
    } else {
      showLogin();
    }
    modal.showModal();
  };
</script>
