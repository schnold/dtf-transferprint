---
interface Props {
  productId?: string;
  existingImages?: Array<{
    id: string;
    url: string;
    altText?: string;
    isPrimary: boolean;
    displayOrder: number;
  }>;
}

const { productId, existingImages = [] } = Astro.props;
---

<div class="card bg-base-100 shadow-xl">
  <div class="card-body">
    <h2 class="card-title">Product Images</h2>

    <!-- Existing Images -->
    {existingImages.length > 0 && (
      <div class="mb-6">
        <h3 class="text-sm font-semibold mb-3">Current Images</h3>
        <div id="existing-images" class="grid grid-cols-2 md:grid-cols-4 gap-4">
          {existingImages
            .sort((a, b) => a.displayOrder - b.displayOrder)
            .map((image) => (
              <div class="image-item relative group" data-image-id={image.id}>
                <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden border-2 border-gray-200">
                  <img
                    src={image.url}
                    alt={image.altText || 'Product image'}
                    class="w-full h-full object-cover"
                  />
                </div>
                {image.isPrimary && (
                  <span class="absolute top-2 left-2 bg-blue-600 text-white text-xs px-2 py-1 rounded">
                    Primary
                  </span>
                )}
                <button
                  type="button"
                  class="delete-image-btn absolute top-2 right-2 bg-red-600 text-white p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"
                  data-image-id={image.id}
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
                {!image.isPrimary && (
                  <button
                    type="button"
                    class="set-primary-btn absolute bottom-2 left-2 bg-blue-600 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity"
                    data-image-id={image.id}
                  >
                    Set as Primary
                  </button>
                )}
              </div>
            ))}
        </div>
      </div>
    )}

    <!-- Upload New Images -->
    <div>
      <h3 class="text-sm font-semibold mb-3">Upload New Images</h3>

      <div class="form-control">
        <label class="label cursor-pointer">
          <span class="label-text">Set first uploaded image as primary</span>
          <input
            type="checkbox"
            id="set-as-primary"
            class="checkbox checkbox-primary"
            checked={existingImages.length === 0}
          />
        </label>
      </div>

      <!-- File Input -->
      <div class="mt-4">
        <input
          type="file"
          id="image-upload-input"
          accept="image/jpeg,image/jpg,image/png,image/webp,image/gif"
          multiple
          class="file-input file-input-bordered w-full"
        />
        <p class="text-xs text-gray-500 mt-2">
          Supported formats: JPEG, PNG, WebP, GIF. Max size: 10MB per image.
        </p>
      </div>

      <!-- Preview Area -->
      <div id="image-preview" class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4 hidden">
      </div>

      <!-- Upload Button -->
      {productId && (
        <button
          type="button"
          id="upload-images-btn"
          class="btn btn-primary mt-4 w-full"
          disabled
        >
          <span class="loading loading-spinner loading-sm hidden"></span>
          <span class="btn-text">Upload Images</span>
        </button>
      )}

      {!productId && (
        <div class="alert alert-info mt-4">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <span>Save the product first to upload images.</span>
        </div>
      )}
    </div>

    <!-- Upload Progress -->
    <div id="upload-progress" class="hidden mt-4">
      <div class="alert alert-info">
        <span class="loading loading-spinner"></span>
        <span id="upload-status">Uploading images...</span>
      </div>
    </div>
  </div>
</div>

<script define:vars={{ productId }}>
  let selectedFiles = [];

  // Handle file selection
  const fileInput = document.getElementById('image-upload-input');
  const previewArea = document.getElementById('image-preview');
  const uploadBtn = document.getElementById('upload-images-btn');

  if (fileInput) {
    fileInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files || []);
      selectedFiles = files;

      // Clear preview
      if (previewArea) {
        previewArea.innerHTML = '';
        previewArea.classList.toggle('hidden', files.length === 0);
      }

      // Show preview
      files.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const preview = document.createElement('div');
          preview.className = 'relative group';
          preview.innerHTML = `
            <div class="aspect-square bg-gray-100 rounded-lg overflow-hidden border-2 border-dashed border-gray-300">
              <img src="${e.target.result}" alt="Preview ${index + 1}" class="w-full h-full object-cover" />
            </div>
            <button
              type="button"
              class="remove-preview absolute top-2 right-2 bg-red-600 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity"
              data-index="${index}"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          `;
          previewArea?.appendChild(preview);
        };
        reader.readAsDataURL(file);
      });

      // Enable/disable upload button
      if (uploadBtn) {
        uploadBtn.disabled = files.length === 0;
      }
    });
  }

  // Remove preview
  if (previewArea) {
    previewArea.addEventListener('click', (e) => {
      const removeBtn = e.target.closest('.remove-preview');
      if (removeBtn) {
        const index = parseInt(removeBtn.dataset.index);
        selectedFiles.splice(index, 1);

        // Update file input
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        if (fileInput) {
          fileInput.files = dt.files;
        }

        // Trigger change to update preview
        fileInput?.dispatchEvent(new Event('change'));
      }
    });
  }

  // Upload images
  if (uploadBtn) {
    uploadBtn.addEventListener('click', async () => {
      if (!productId || selectedFiles.length === 0) return;

      const formData = new FormData();
      formData.append('productId', productId);

      const isPrimary = document.getElementById('set-as-primary')?.checked;
      formData.append('isPrimary', isPrimary ? 'true' : 'false');

      selectedFiles.forEach((file) => {
        formData.append('images', file);
      });

      // Show progress
      const progressDiv = document.getElementById('upload-progress');
      const statusText = document.getElementById('upload-status');
      const btnText = uploadBtn.querySelector('.btn-text');
      const spinner = uploadBtn.querySelector('.loading');

      if (progressDiv) progressDiv.classList.remove('hidden');
      uploadBtn.disabled = true;
      if (spinner) spinner.classList.remove('hidden');
      if (btnText) btnText.textContent = 'Uploading...';

      try {
        const response = await fetch('/api/admin/products/upload-image', {
          method: 'POST',
          body: formData,
        });

        const result = await response.json();

        if (result.success) {
          if (statusText) {
            statusText.textContent = result.data.message;
          }

          // Reload page to show new images
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } else {
          throw new Error(result.error.message);
        }
      } catch (error) {
        alert('Failed to upload images: ' + error.message);
        if (progressDiv) progressDiv.classList.add('hidden');
        uploadBtn.disabled = false;
        if (spinner) spinner.classList.add('hidden');
        if (btnText) btnText.textContent = 'Upload Images';
      }
    });
  }

  // Delete image
  document.addEventListener('click', async (e) => {
    const deleteBtn = e.target.closest('.delete-image-btn');
    if (deleteBtn) {
      const imageId = deleteBtn.dataset.imageId;

      if (!confirm('Are you sure you want to delete this image?')) {
        return;
      }

      try {
        const response = await fetch('/api/admin/products/upload-image', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ imageId }),
        });

        const result = await response.json();

        if (result.success) {
          // Remove image from DOM
          const imageItem = deleteBtn.closest('.image-item');
          imageItem?.remove();

          // Reload if no images left
          const existingImages = document.getElementById('existing-images');
          if (existingImages && existingImages.children.length === 0) {
            window.location.reload();
          }
        } else {
          throw new Error(result.error.message);
        }
      } catch (error) {
        alert('Failed to delete image: ' + error.message);
      }
    }
  });

  // Set as primary
  document.addEventListener('click', async (e) => {
    const primaryBtn = e.target.closest('.set-primary-btn');
    if (primaryBtn && productId) {
      const imageId = primaryBtn.dataset.imageId;

      try {
        const response = await fetch(`/api/admin/products/${productId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ primaryImageId: imageId }),
        });

        if (response.ok) {
          window.location.reload();
        } else {
          throw new Error('Failed to set primary image');
        }
      } catch (error) {
        alert('Failed to set primary image: ' + error.message);
      }
    }
  });
</script>
