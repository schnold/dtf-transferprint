---
interface Props {
  productId?: string;
  existingImages?: Array<{
    id: string;
    url: string;
    altText?: string;
    isPrimary: boolean;
    displayOrder: number;
  }>;
}

const { productId, existingImages = [] } = Astro.props;
---

<div class="space-y-6">
  <!-- Existing Images Gallery -->
  <div>
    <h3 class="text-sm font-semibold mb-4 text-base-content">Produktbilder</h3>
    <div id="existing-images" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
      {existingImages
        .sort((a, b) => a.displayOrder - b.displayOrder)
        .map((image) => (
          <div class="image-item relative group" data-image-id={image.id}>
            <div class="aspect-square bg-base-200 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow">
              <img
                src={image.url}
                alt={image.altText || 'Product image'}
                class="w-full h-full object-cover"
              />
            </div>
            {image.isPrimary && (
              <span class="absolute top-2 left-2 bg-primary text-primary-content text-xs px-2 py-1 rounded-md shadow-sm font-medium">
                Primär
              </span>
            )}
            <button
              type="button"
              class="delete-image-btn absolute top-2 right-2 bg-error text-error-content p-1.5 rounded-full opacity-0 group-hover:opacity-100 transition-opacity shadow-md hover:shadow-lg"
              data-image-id={image.id}
              title="Bild löschen"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
            {!image.isPrimary && (
              <button
                type="button"
                class="set-primary-btn absolute bottom-2 left-2 bg-primary text-primary-content text-xs px-2 py-1 rounded-md opacity-0 group-hover:opacity-100 transition-opacity shadow-sm hover:shadow-md font-medium"
                data-image-id={image.id}
                title="Als primäres Bild setzen"
              >
                Als Primär setzen
              </button>
            )}
          </div>
        ))}
      {existingImages.length === 0 && (
        <div class="col-span-full text-center py-12 text-base-content/50">
          <svg class="w-16 h-16 mx-auto mb-4 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          <p class="text-sm font-medium">Noch keine Bilder hochgeladen</p>
          <p class="text-xs text-base-content/50 mt-1">Laden Sie Bilder unten hoch</p>
        </div>
      )}
    </div>
  </div>

  <!-- Upload New Images -->
  <div class="divider">Neue Bilder hochladen</div>
  
  <div class="space-y-4">
    <div class="form-control">
      <label class="label cursor-pointer justify-start gap-3">
        <input
          type="checkbox"
          id="set-as-primary"
          class="checkbox checkbox-primary"
          checked={existingImages.length === 0}
        />
        <span class="label-text">Erstes hochgeladenes Bild als primäres Bild setzen</span>
      </label>
    </div>

    <!-- File Input -->
    <div>
      <input
        type="file"
        id="image-upload-input"
        accept="image/jpeg,image/jpg,image/png,image/webp,image/gif"
        multiple
        class="file-input file-input-bordered w-full"
      />
      <p class="text-xs text-base-content/60 mt-2">
        Unterstützte Formate: JPEG, PNG, WebP, GIF. Max. Größe: 10MB pro Bild.
      </p>
    </div>

    <!-- Preview Area -->
    <div id="image-preview" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 hidden">
    </div>

    <!-- Upload Button -->
    {productId && (
      <button
        type="button"
        id="upload-images-btn"
        class="btn btn-primary w-full"
        disabled
      >
        <span class="loading loading-spinner loading-sm hidden"></span>
        <span class="btn-text">Bilder hochladen</span>
      </button>
    )}

    {!productId && (
      <div class="alert alert-info">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span>Speichern Sie das Produkt zuerst, um Bilder hochzuladen.</span>
      </div>
    )}
  </div>

  <!-- Upload Progress -->
  <div id="upload-progress" class="hidden">
    <div class="alert alert-info">
      <span class="loading loading-spinner"></span>
      <span id="upload-status">Bilder werden hochgeladen...</span>
    </div>
  </div>
</div>

<script define:vars={{ productId }}>
  let selectedFiles = [];

  // Handle file selection
  const fileInput = document.getElementById('image-upload-input');
  const previewArea = document.getElementById('image-preview');
  const uploadBtn = document.getElementById('upload-images-btn');

  if (fileInput) {
    fileInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files || []);
      selectedFiles = files;

      // Clear preview
      if (previewArea) {
        previewArea.innerHTML = '';
        previewArea.classList.toggle('hidden', files.length === 0);
      }

      // Show preview
      files.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const preview = document.createElement('div');
          preview.className = 'relative group';
          preview.innerHTML = `
            <div class="aspect-square bg-base-200 rounded-lg overflow-hidden shadow-sm border-2 border-dashed border-primary/30">
              <img src="${e.target.result}" alt="Vorschau ${index + 1}" class="w-full h-full object-cover" />
            </div>
            <button
              type="button"
              class="remove-preview absolute top-2 right-2 bg-error text-error-content p-1.5 rounded-full opacity-0 group-hover:opacity-100 transition-opacity shadow-md hover:shadow-lg"
              data-index="${index}"
              title="Aus Vorschau entfernen"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          `;
          previewArea?.appendChild(preview);
        };
        reader.readAsDataURL(file);
      });

      // Enable/disable upload button
      if (uploadBtn) {
        uploadBtn.disabled = files.length === 0;
      }
    });
  }

  // Remove preview
  if (previewArea) {
    previewArea.addEventListener('click', (e) => {
      const removeBtn = e.target.closest('.remove-preview');
      if (removeBtn) {
        const index = parseInt(removeBtn.dataset.index);
        selectedFiles.splice(index, 1);

        // Update file input
        const dt = new DataTransfer();
        selectedFiles.forEach(file => dt.items.add(file));
        if (fileInput) {
          fileInput.files = dt.files;
        }

        // Trigger change to update preview
        fileInput?.dispatchEvent(new Event('change'));
      }
    });
  }

  // Helper function to add image to gallery
  function addImageToGallery(image) {
    const existingImagesContainer = document.getElementById('existing-images');
    if (!existingImagesContainer) return;

    // Remove empty state if it exists
    const emptyState = existingImagesContainer.querySelector('.col-span-full');
    if (emptyState) {
      emptyState.remove();
    }

    // Get current max display order
    const existingItems = existingImagesContainer.querySelectorAll('.image-item');
    let maxOrder = 0;
    existingItems.forEach(item => {
      const order = parseInt(item.dataset.displayOrder) || 0;
      if (order > maxOrder) maxOrder = order;
    });

    // Create image element
    const imageDiv = document.createElement('div');
    imageDiv.className = 'image-item relative group';
    imageDiv.dataset.imageId = image.id;
    imageDiv.dataset.displayOrder = (maxOrder + 1).toString();
    
    const isPrimary = image.isPrimary || false;
    imageDiv.innerHTML = `
      <div class="aspect-square bg-base-200 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow">
        <img
          src="${image.url}"
          alt="${image.altText || 'Product image'}"
          class="w-full h-full object-cover"
        />
      </div>
      ${isPrimary ? `
        <span class="absolute top-2 left-2 bg-primary text-primary-content text-xs px-2 py-1 rounded-md shadow-sm font-medium">
          Primär
        </span>
      ` : ''}
      <button
        type="button"
        class="delete-image-btn absolute top-2 right-2 bg-error text-error-content p-1.5 rounded-full opacity-0 group-hover:opacity-100 transition-opacity shadow-md hover:shadow-lg"
        data-image-id="${image.id}"
        title="Bild löschen"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      ${!isPrimary ? `
        <button
          type="button"
          class="set-primary-btn absolute bottom-2 left-2 bg-primary text-primary-content text-xs px-2 py-1 rounded-md opacity-0 group-hover:opacity-100 transition-opacity shadow-sm hover:shadow-md font-medium"
          data-image-id="${image.id}"
          title="Als primäres Bild setzen"
        >
          Als Primär setzen
        </button>
      ` : ''}
    `;

    existingImagesContainer.appendChild(imageDiv);
  }

  // Upload images
  if (uploadBtn) {
    uploadBtn.addEventListener('click', async () => {
      if (!productId || selectedFiles.length === 0) return;

      const formData = new FormData();
      formData.append('productId', productId);

      const isPrimary = document.getElementById('set-as-primary')?.checked;
      formData.append('isPrimary', isPrimary ? 'true' : 'false');

      selectedFiles.forEach((file) => {
        formData.append('images', file);
      });

      // Show progress
      const progressDiv = document.getElementById('upload-progress');
      const statusText = document.getElementById('upload-status');
      const btnText = uploadBtn.querySelector('.btn-text');
      const spinner = uploadBtn.querySelector('.loading');

      if (progressDiv) progressDiv.classList.remove('hidden');
      uploadBtn.disabled = true;
      if (spinner) spinner.classList.remove('hidden');
      if (btnText) btnText.textContent = 'Wird hochgeladen...';

      try {
        const response = await fetch('/api/admin/products/upload-image', {
          method: 'POST',
          body: formData,
        });

        const result = await response.json();

        if (result.success) {
          if (statusText) {
            statusText.textContent = result.data.message;
          }

          // Add uploaded images to gallery immediately
          if (result.data.images && Array.isArray(result.data.images)) {
            result.data.images.forEach(image => {
              addImageToGallery({
                id: image.id,
                url: image.url,
                altText: '',
                isPrimary: isPrimary && result.data.images.indexOf(image) === 0,
                displayOrder: 0
              });
            });
          }

          // Clear preview and reset file input
          if (previewArea) {
            previewArea.innerHTML = '';
            previewArea.classList.add('hidden');
          }
          if (fileInput) {
            fileInput.value = '';
          }
          selectedFiles = [];

          // Hide progress after a short delay
          setTimeout(() => {
            if (progressDiv) progressDiv.classList.add('hidden');
            uploadBtn.disabled = false;
            if (spinner) spinner.classList.add('hidden');
            if (btnText) btnText.textContent = 'Bilder hochladen';
          }, 1500);
        } else {
          throw new Error(result.error.message);
        }
      } catch (error) {
        alert('Fehler beim Hochladen der Bilder: ' + error.message);
        if (progressDiv) progressDiv.classList.add('hidden');
        uploadBtn.disabled = false;
        if (spinner) spinner.classList.add('hidden');
        if (btnText) btnText.textContent = 'Bilder hochladen';
      }
    });
  }

  // Delete image
  document.addEventListener('click', async (e) => {
    const deleteBtn = e.target.closest('.delete-image-btn');
    if (deleteBtn) {
      const imageId = deleteBtn.dataset.imageId;

      if (!confirm('Sind Sie sicher, dass Sie dieses Bild löschen möchten?')) {
        return;
      }

      try {
        const response = await fetch('/api/admin/products/upload-image', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ imageId }),
        });

        const result = await response.json();

        if (result.success) {
          // Remove image from DOM
          const imageItem = deleteBtn.closest('.image-item');
          imageItem?.remove();

          // Show empty state if no images left
          const existingImages = document.getElementById('existing-images');
          if (existingImages && existingImages.children.length === 0) {
            existingImages.innerHTML = `
              <div class="col-span-full text-center py-12 text-base-content/50">
                <svg class="w-16 h-16 mx-auto mb-4 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <p class="text-sm font-medium">Noch keine Bilder hochgeladen</p>
                <p class="text-xs text-base-content/50 mt-1">Laden Sie Bilder unten hoch</p>
              </div>
            `;
          }
        } else {
          throw new Error(result.error.message);
        }
      } catch (error) {
        alert('Fehler beim Löschen des Bildes: ' + error.message);
      }
    }
  });

  // Set as primary
  document.addEventListener('click', async (e) => {
    const primaryBtn = e.target.closest('.set-primary-btn');
    if (primaryBtn && productId) {
      const imageId = primaryBtn.dataset.imageId;

      try {
        const response = await fetch(`/api/admin/products/${productId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ primaryImageId: imageId }),
        });

        if (response.ok) {
          // Update UI: remove primary badge from all images
          document.querySelectorAll('.image-item').forEach(item => {
            const primaryBadge = item.querySelector('.absolute.top-2.left-2');
            if (primaryBadge && primaryBadge.textContent.includes('Primär')) {
              primaryBadge.remove();
            }
            // Show set-primary button if it was hidden
            const setPrimaryBtn = item.querySelector('.set-primary-btn');
            if (setPrimaryBtn) {
              setPrimaryBtn.classList.remove('hidden');
            }
          });

          // Add primary badge to selected image
          const selectedImage = primaryBtn.closest('.image-item');
          if (selectedImage) {
            const imgContainer = selectedImage.querySelector('.aspect-square');
            if (imgContainer) {
              const primaryBadge = document.createElement('span');
              primaryBadge.className = 'absolute top-2 left-2 bg-primary text-primary-content text-xs px-2 py-1 rounded-md shadow-sm font-medium';
              primaryBadge.textContent = 'Primär';
              imgContainer.appendChild(primaryBadge);
            }
            // Hide set-primary button
            primaryBtn.remove();
          }
        } else {
          throw new Error('Fehler beim Setzen des primären Bildes');
        }
      } catch (error) {
        alert('Fehler beim Setzen des primären Bildes: ' + error.message);
      }
    }
  });
</script>
