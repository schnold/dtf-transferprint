---
import Layout from '../../layouts/Layout.astro';
import { verifyUnsubscribeToken } from '../../lib/email';
import { Pool } from 'pg';

const url = new URL(Astro.request.url);
const token = url.searchParams.get('token');

let status: 'idle' | 'success' | 'error' | 'invalid' = 'idle';
let message = '';

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const unsubToken = formData.get('token') as string;

  if (unsubToken) {
    const tokenData = verifyUnsubscribeToken(unsubToken);

    if (tokenData) {
      try {
        const pool = new Pool({
          connectionString: process.env.NEON_DATABASE,
          ssl: { rejectUnauthorized: false },
        });

        // Update user's email preferences
        await pool.query(
          'UPDATE "user" SET "emailNotifications" = false WHERE id = $1',
          [tokenData.userId]
        );

        await pool.end();

        status = 'success';
        message = 'You have been successfully unsubscribed from all email notifications.';
      } catch (error) {
        console.error('Unsubscribe error:', error);
        status = 'error';
        message = 'An error occurred. Please try again later.';
      }
    } else {
      status = 'invalid';
      message = 'Invalid or expired unsubscribe link.';
    }
  }
}

const tokenData = token ? verifyUnsubscribeToken(token) : null;
---

<Layout title="Unsubscribe - DTF Transfer Print">
  <div class="min-h-screen flex items-center justify-center bg-base-200 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
      <div class="bg-base-100 shadow-xl rounded-lg p-8">
        <div class="text-center mb-6">
          <h1 class="text-3xl font-bold">Email Preferences</h1>
        </div>

        {status === 'idle' && tokenData && (
          <div>
            <p class="text-center mb-6">
              Are you sure you want to unsubscribe from all email notifications?
            </p>

            <div class="alert alert-warning mb-6">
              <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              <span>You'll no longer receive marketing emails, but will still receive important account-related messages.</span>
            </div>

            <form method="POST">
              <input type="hidden" name="token" value={token} />
              <button type="submit" class="btn btn-error w-full mb-3">
                Unsubscribe
              </button>
              <a href="/" class="btn btn-ghost w-full">
                Keep Subscribed
              </a>
            </form>
          </div>
        )}

        {status === 'success' && (
          <div>
            <div class="alert alert-success mb-6">
              <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span>{message}</span>
            </div>

            <p class="text-center text-sm text-base-content/70 mb-6">
              You can always update your email preferences by logging into your account.
            </p>

            <a href="/" class="btn btn-primary w-full">
              Return to Home
            </a>
          </div>
        )}

        {(status === 'error' || status === 'invalid') && (
          <div>
            <div class="alert alert-error mb-6">
              <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span>{message}</span>
            </div>

            <a href="/" class="btn btn-primary w-full">
              Return to Home
            </a>
          </div>
        )}

        {!token && status === 'idle' && (
          <div>
            <div class="alert alert-info mb-6">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <span>Invalid unsubscribe link. Please use the link from your email.</span>
            </div>

            <a href="/" class="btn btn-primary w-full">
              Return to Home
            </a>
          </div>
        )}
      </div>

      <div class="text-center text-sm text-base-content/70">
        <p>Need help? <a href="/rechtliches/datenschutz" class="link link-primary">Privacy Policy</a></p>
      </div>
    </div>
  </div>
</Layout>
