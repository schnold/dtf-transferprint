---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import { pool } from '../lib/db';

const user = Astro.locals.user;

if (!user) {
  return Astro.redirect('/');
}

const title = 'Kasse - DTF Transfer Print';
const description = 'SchlieÃŸen Sie Ihre Bestellung ab';

// Get PayPal Client ID from environment
const paypalClientId = import.meta.env.PAYPAL_CLIENT_ID;
const paypalMode = import.meta.env.PAYPAL_MODE || 'sandbox';

// Fetch user discount
const client = await pool.connect();
let userDiscountPercent = 0;

try {
  const userResult = await client.query(
    'SELECT "discountPercent" FROM "user" WHERE id = $1',
    [user.id]
  );
  userDiscountPercent = parseFloat(userResult.rows[0]?.discountPercent || 0);
} finally {
  client.release();
}

// Fetch cart
let cartItems: any[] = [];
let subtotal = 0;

const response = await fetch(`${Astro.url.origin}/api/cart/get`, {
  headers: {
    'Cookie': Astro.request.headers.get('Cookie') || '',
  },
});

if (response.ok) {
  const result = await response.json();
  if (result.success) {
    cartItems = result.data.items || [];
    subtotal = result.data.subtotal || 0;
  }
}

// Fetch user addresses
const addressClient = await pool.connect();
let userAddresses: any[] = [];
let hasAddresses = false;

try {
  const addressResult = await addressClient.query(
    'SELECT * FROM "userAddresses" WHERE "userId" = $1 ORDER BY "isDefault" DESC, "createdAt" DESC',
    [user.id]
  );
  userAddresses = addressResult.rows;
  hasAddresses = userAddresses.length > 0;
} finally {
  addressClient.release();
}

// Fetch available zusatzleistungen per cart item
const cartItemServicesMap: Record<string, { available: any[]; selectedIds: string[] }> = {};

if (cartItems.length > 0) {
  const servicesClient = await pool.connect();
  try {
    for (const item of cartItems) {
      const availableResult = await servicesClient.query(
        `SELECT z.id, z.name, z.description, z.price
         FROM "zusatzleistungen" z
         INNER JOIN "productZusatzleistungen" pz ON z.id = pz."zusatzleistungId"
         WHERE pz."productId" = $1
           AND z."isActive" = true
           AND pz."isEnabled" = true
         ORDER BY z."displayOrder" ASC, z."createdAt" ASC`,
        [item.productId]
      );

      const selectedResult = await servicesClient.query(
        'SELECT "zusatzleistungId" FROM "cartItemZusatzleistungen" WHERE "cartItemId" = $1',
        [item.id]
      );

      cartItemServicesMap[item.id] = {
        available: availableResult.rows.map((row) => ({
          ...row,
          price: parseFloat(row.price),
        })),
        selectedIds: selectedResult.rows.map((row) => row.zusatzleistungId),
      };
    }
  } finally {
    servicesClient.release();
  }
}

// Fetch active shipping profiles
const shippingClient = await pool.connect();
let shippingProfiles: any[] = [];
let selectedShippingId: string | null = null;

try {
  const profilesResult = await shippingClient.query(
    'SELECT * FROM "shippingProfiles" WHERE "isActive" = true ORDER BY "displayOrder"'
  );
  shippingProfiles = profilesResult.rows;

  // Get user's selected shipping profile
  const selectionResult = await shippingClient.query(
    'SELECT "shippingProfileId" FROM "userCartShipping" WHERE "userId" = $1',
    [user.id]
  );

  if (selectionResult.rows.length > 0) {
    selectedShippingId = selectionResult.rows[0].shippingProfileId;
  } else {
    // Use default
    const defaultProfile = shippingProfiles.find((p) => p.isDefault);
    selectedShippingId = defaultProfile?.id || shippingProfiles[0]?.id;
  }
} finally {
  shippingClient.release();
}

const formatPrice = (price: number) => {
  return new Intl.NumberFormat('de-DE', {
    style: 'currency',
    currency: 'EUR',
  }).format(price);
};
---

<Layout title={title} description={description}>
  <script
    src={`https://www.paypal.com/sdk/js?client-id=${paypalClientId}&currency=EUR&intent=capture`}
    data-sdk-integration-source="button-factory"
  ></script>

  <Navbar />

  <div class="min-h-screen bg-gradient-to-br from-primary/10 via-base-100 to-secondary/10">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 max-w-6xl">
      {
        cartItems.length === 0 ? (
          <div class="min-h-[60vh] flex items-center justify-center">
            <div class="text-center max-w-md space-y-4">
              <h2 class="text-2xl font-semibold text-neutral">Ihr Warenkorb ist leer</h2>
              <p class="text-neutral/60">FÃ¼gen Sie Produkte hinzu, um zur Kasse zu gehen.</p>
              <a href="/products" class="btn btn-primary mt-4">
                Produkte ansehen
              </a>
            </div>
          </div>
        ) : (
          <div class="space-y-8">
            <div class="flex items-baseline justify-between border-b border-base-300/50 pb-6">
              <div>
                <h1 class="text-3xl font-semibold text-neutral mb-1">Kasse</h1>
                <p class="text-sm text-neutral/60">SchlieÃŸen Sie Ihre Bestellung ab</p>
              </div>
              <a
                href="/cart"
                class="text-sm text-primary hover:text-primary-focus transition-colors"
              >
                ZurÃ¼ck zum Warenkorb
              </a>
            </div>

            {/* Address Warning Banner */}
            {!hasAddresses && (
              <div class="alert alert-warning">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="stroke-current shrink-0 h-6 w-6"
                  fill="none"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                  />
                </svg>
                <span>Bitte fÃ¼gen Sie eine Lieferadresse hinzu, um die Bestellung abzuschlieÃŸen.</span>
              </div>
            )}

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
              {/* Order Summary */}
              <div class="lg:col-span-2 space-y-6">
                {/* Cart Items */}
                <div class="bg-base-100 border border-base-300/50 rounded-lg p-6">
                  <h2 class="text-lg font-semibold mb-4">BestellÃ¼bersicht</h2>
                  <div class="space-y-3">
                    {cartItems.map((item) => (
                      <div class="flex gap-4 py-3 border-b border-base-300/30 last:border-0" data-checkout-item-id={item.id}>
                        {item.productImage && (
                          <img
                            src={item.productImage}
                            alt={item.productName}
                            class="w-16 h-16 object-cover rounded flex-shrink-0"
                          />
                        )}
                        <div class="flex-1 min-w-0">
                          <h3 class="font-medium text-sm">{item.productName}</h3>
                          <p class="text-xs text-neutral/60">Menge: {item.quantity}</p>

                          {/* Zusatzleistungen checkboxes */}
                          {cartItemServicesMap[item.id]?.available.length > 0 && (
                            <div class="mt-2 pt-2 border-t border-base-300/20 space-y-1.5">
                              <p class="text-xs font-semibold text-neutral/50 uppercase tracking-wide">Zusatzleistungen</p>
                              {cartItemServicesMap[item.id].available.map((service) => (
                                <label class="flex items-center justify-between gap-2 cursor-pointer group">
                                  <div class="flex items-center gap-2">
                                    <input
                                      type="checkbox"
                                      class="checkbox checkbox-primary checkbox-xs service-checkbox"
                                      data-cart-item-id={item.id}
                                      data-service-id={service.id}
                                      checked={cartItemServicesMap[item.id].selectedIds.includes(service.id)}
                                    />
                                    <span class="text-xs text-neutral/70 group-hover:text-neutral transition-colors">{service.name}</span>
                                  </div>
                                  <span class="text-xs font-medium text-neutral/60 whitespace-nowrap">+{formatPrice(service.price)}</span>
                                </label>
                              ))}
                            </div>
                          )}
                        </div>
                        <div class="text-right flex-shrink-0">
                          <p class="font-medium checkout-item-total" data-checkout-item-id={item.id}>{formatPrice(item.totalWithServices)}</p>
                          {item.currentSavings > 0 && (
                            <p class="text-xs text-success">
                              -{formatPrice(item.currentSavings)} gespart
                            </p>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Shipping Address */}
                <div class="bg-base-100 border border-base-300/50 rounded-lg p-6">
                  <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold">Lieferadresse</h2>
                    <button
                      id="add-address-btn"
                      class="btn btn-sm btn-primary"
                      onclick="document.getElementById('address-modal').showModal()"
                    >
                      + Neue Adresse
                    </button>
                  </div>

                  <div id="address-list" class="space-y-3">
                    {
                      hasAddresses ? (
                        userAddresses.map((address, index) => (
                          <label class="flex items-start gap-3 p-4 border border-base-300 rounded-lg cursor-pointer hover:bg-base-200/50 transition-colors">
                            <input
                              type="radio"
                              name="address"
                              value={address.id}
                              checked={index === 0}
                              class="radio radio-primary radio-sm mt-1"
                            />
                            <div class="flex-1">
                              <p class="font-medium">
                                {address.firstName} {address.lastName}
                                {address.isDefault && (
                                  <span class="badge badge-sm badge-primary ml-2">Standard</span>
                                )}
                              </p>
                              {address.company && (
                                <p class="text-sm text-neutral/60">{address.company}</p>
                              )}
                              <p class="text-sm">{address.addressLine1}</p>
                              {address.addressLine2 && (
                                <p class="text-sm">{address.addressLine2}</p>
                              )}
                              <p class="text-sm">
                                {address.postalCode} {address.city}
                              </p>
                              <p class="text-sm text-neutral/60">{address.country}</p>
                            </div>
                          </label>
                        ))
                      ) : (
                        <p class="text-sm text-neutral/60 text-center py-4">
                          Keine Adressen vorhanden. Bitte fÃ¼gen Sie eine Adresse hinzu.
                        </p>
                      )
                    }
                  </div>
                </div>

                {/* Shipping Method */}
                <div class="bg-base-100 border border-base-300/50 rounded-lg p-6" id="shipping-profiles-list">
                  <h2 class="text-lg font-semibold mb-4">Versandart</h2>
                  <div class="space-y-2">
                    {shippingProfiles.map((profile) => (
                      <label class="flex items-center justify-between p-3 border border-base-300 rounded-lg cursor-pointer hover:bg-base-200/50 transition-colors">
                        <div class="flex items-center gap-3">
                          <input
                            type="radio"
                            name="shipping"
                            value={profile.id}
                            checked={profile.id === selectedShippingId}
                            class="radio radio-primary radio-sm"
                          />
                          <div>
                            <p class="font-medium text-sm">{profile.name}</p>
                            {profile.description && (
                              <p class="text-xs text-neutral/60">{profile.description}</p>
                            )}
                            {profile.estimatedDays && (
                              <p class="text-xs text-neutral/60">
                                Lieferung in ca. {profile.estimatedDays} Werktagen
                              </p>
                            )}
                          </div>
                        </div>
                        <div class="text-right">
                          <p class="font-medium">{formatPrice(profile.basePrice)}</p>
                          {profile.freeShippingThreshold && (
                            <p class="text-xs text-neutral/60">
                              Kostenlos ab {formatPrice(profile.freeShippingThreshold)}
                            </p>
                          )}
                        </div>
                      </label>
                    ))}
                  </div>
                </div>

                {/* Discount Code */}
                <div class="bg-base-100 border border-base-300/50 rounded-lg p-6">
                  <h2 class="text-lg font-semibold mb-4">Rabattcode</h2>
                  <div class="flex gap-2">
                    <input
                      type="text"
                      id="discount-code-input"
                      placeholder="Rabattcode eingeben"
                      class="input input-bordered flex-1"
                    />
                    <button id="apply-discount-btn" class="btn btn-secondary">
                      Anwenden
                    </button>
                  </div>
                  <div id="discount-message" class="mt-2 text-sm"></div>
                </div>
              </div>

              {/* Payment Section */}
              <div class="lg:col-span-1">
                <div class="bg-base-100 border border-base-300/50 rounded-lg p-6 sticky top-4">
                  <h2 class="text-lg font-semibold mb-4">Zusammenfassung</h2>

                  <div id="order-summary" class="space-y-2 mb-4">
                    <div class="flex justify-between text-sm">
                      <span class="text-neutral/60">Zwischensumme</span>
                      <span id="summary-subtotal">{formatPrice(subtotal)}</span>
                    </div>

                    {userDiscountPercent > 0 && (
                      <div class="flex justify-between text-sm text-success">
                        <span>Ihr Rabatt ({userDiscountPercent}%)</span>
                        <span id="summary-user-discount">
                          -{formatPrice(subtotal * (userDiscountPercent / 100))}
                        </span>
                      </div>
                    )}

                    <div id="campaign-discount-row" class="hidden flex justify-between text-sm text-success">
                      <span id="campaign-discount-label">Kampagnenrabatt</span>
                      <span id="summary-campaign-discount">-â‚¬0.00</span>
                    </div>

                    <div class="flex justify-between text-sm">
                      <span class="text-neutral/60">Versand</span>
                      <span id="summary-shipping">{formatPrice(0)}</span>
                    </div>

                    <div class="flex justify-between text-sm">
                      <span class="text-neutral/60">MwSt. (19%)</span>
                      <span id="summary-tax">{formatPrice(0)}</span>
                    </div>

                    <div class="border-t border-base-300 pt-2 mt-2">
                      <div class="flex justify-between font-semibold text-lg">
                        <span>Gesamt</span>
                        <span id="summary-total">{formatPrice(subtotal)}</span>
                      </div>
                    </div>
                  </div>

                  <div id="paypal-button-container" class="mt-6"></div>
                  <!-- PayPal Logo -->
                  <div class="flex justify-center py-4">
                    <a
                      href="https://ad.doubleclick.net/ddm/trackclk/N426203.3410571DEPAYPALLOGOCENTE/B21619412.227908863;dc_trk_aid=425874235;dc_trk_cid=105266791;dc_lat=;dc_rdid=;tag_for_child_directed_treatment=;tfua="
                      title="So funktioniert PayPal"
                      target="_blank"
                      rel="noopener noreferrer"
                      onclick="javascript:window.open('https://ad.doubleclick.net/ddm/trackclk/N426203.3410571DEPAYPALLOGOCENTE/B21619412.227908863;dc_trk_aid=425874235;dc_trk_cid=105266791;dc_lat=;dc_rdid=;tag_for_child_directed_treatment=;tfua=','WIPaypal','toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=yes, resizable=yes, width=715, height=539'); return false;"
                    >
                      <img
                        src="https://www.paypalobjects.com/webstatic/de_DE/i/de-pp-logo-200px.png"
                        width="200"
                        height="60"
                        alt="PayPal Logo"
                        class="h-10 w-auto object-contain"
                      />
                    </a>
                  </div>
                  <!-- PayPal Logo -->
                  <div id="payment-error" class="mt-4 text-sm text-error hidden"></div>
                  <div id="payment-loading" class="hidden">
                    <div class="flex items-center justify-center py-4">
                      <span class="loading loading-spinner loading-md"></span>
                      <span class="ml-2 text-sm">Verarbeite Zahlung...</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )
      }
    </div>
  </div>

  {/* Address Modal */}
  <dialog id="address-modal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box max-w-3xl shadow-2xl border border-base-300/50">
      <!-- Modal Header -->
      <div class="flex items-center justify-between pb-5 mb-7 border-b border-base-300/20">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-primary">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
            </svg>
          </div>
          <div>
            <h3 class="font-bold text-xl text-base-content">Neue Adresse hinzufÃ¼gen</h3>
            <p class="text-sm text-base-content/60 mt-0.5">FÃ¼gen Sie eine neue Liefer- oder Rechnungsadresse hinzu</p>
          </div>
        </div>
        <form method="dialog">
          <button class="btn btn-sm btn-circle btn-ghost hover:bg-base-300 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </form>
      </div>

      <form id="address-form" class="space-y-7">
        <!-- Personal Information Section -->
        <div>
          <div class="mb-5">
            <h4 class="text-sm font-semibold text-base-content uppercase tracking-wide mb-1">PersÃ¶nliche Daten</h4>
            <p class="text-xs text-base-content/60">Geben Sie Ihre persÃ¶nlichen Informationen ein</p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-4">
            <div class="form-control">
              <div class="mb-2">
                <label class="text-sm font-medium text-base-content">Vorname <span class="text-error">*</span></label>
              </div>
              <input type="text" name="firstName" class="input input-bordered focus:input-primary transition-all" placeholder="Max" required />
            </div>
            <div class="form-control">
              <div class="mb-2">
                <label class="text-sm font-medium text-base-content">Nachname <span class="text-error">*</span></label>
              </div>
              <input type="text" name="lastName" class="input input-bordered focus:input-primary transition-all" placeholder="Mustermann" required />
            </div>
          </div>

          <div class="form-control mt-4">
            <div class="mb-2">
              <label class="text-sm font-medium text-base-content">Firma <span class="text-xs text-base-content/50">(Optional)</span></label>
            </div>
            <input type="text" name="company" class="input input-bordered focus:input-primary transition-all" placeholder="Firma GmbH" />
          </div>
        </div>

        <!-- Address Information Section -->
        <div>
          <div class="mb-5">
            <h4 class="text-sm font-semibold text-base-content uppercase tracking-wide mb-1">Adressinformationen</h4>
            <p class="text-xs text-base-content/60">Geben Sie Ihre vollstÃ¤ndige Lieferadresse ein</p>
          </div>

          <div class="space-y-4">
            <div class="form-control">
              <div class="mb-2">
                <label class="text-sm font-medium text-base-content">StraÃŸe und Hausnummer <span class="text-error">*</span></label>
              </div>
              <input type="text" name="addressLine1" class="input input-bordered focus:input-primary transition-all" placeholder="MusterstraÃŸe 123" required />
            </div>

            <div class="form-control">
              <div class="mb-2">
                <label class="text-sm font-medium text-base-content">Adresszusatz <span class="text-xs text-base-content/50">(Optional)</span></label>
                <p class="text-xs text-base-content/50 mt-0.5">z.B. Stockwerk, Appartment</p>
              </div>
              <input type="text" name="addressLine2" class="input input-bordered focus:input-primary transition-all" placeholder="2. Stock, Wohnung 5" />
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-4">
              <div class="form-control">
                <div class="mb-2">
                  <label class="text-sm font-medium text-base-content">Postleitzahl <span class="text-error">*</span></label>
                </div>
                <input type="text" name="postalCode" class="input input-bordered focus:input-primary transition-all" placeholder="12345" required />
              </div>
              <div class="form-control">
                <div class="mb-2">
                  <label class="text-sm font-medium text-base-content">Stadt <span class="text-error">*</span></label>
                </div>
                <input type="text" name="city" class="input input-bordered focus:input-primary transition-all" placeholder="Berlin" required />
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-4">
              <div class="form-control">
                <div class="mb-2">
                  <label class="text-sm font-medium text-base-content">Bundesland <span class="text-xs text-base-content/50">(Optional)</span></label>
                </div>
                <input type="text" name="stateProvince" class="input input-bordered focus:input-primary transition-all" placeholder="Berlin" />
              </div>
              <div class="form-control">
                <div class="mb-2">
                  <label class="text-sm font-medium text-base-content">Land <span class="text-error">*</span></label>
                </div>
                <select name="country" class="select select-bordered focus:select-primary transition-all" required>
                  <option value="DE">ðŸ‡©ðŸ‡ª Deutschland</option>
                  <option value="AT">ðŸ‡¦ðŸ‡¹ Ã–sterreich</option>
                  <option value="CH">ðŸ‡¨ðŸ‡­ Schweiz</option>
                </select>
              </div>
            </div>
          </div>
        </div>

        <!-- Contact Information Section -->
        <div>
          <div class="mb-5">
            <h4 class="text-sm font-semibold text-base-content uppercase tracking-wide mb-1">Kontaktinformationen</h4>
            <p class="text-xs text-base-content/60">FÃ¼r RÃ¼ckfragen zur Lieferung</p>
          </div>

          <div class="form-control">
            <div class="mb-2">
              <label class="text-sm font-medium text-base-content">Telefon <span class="text-xs text-base-content/50">(Optional)</span></label>
              <p class="text-xs text-base-content/50 mt-0.5">FÃ¼r Lieferbenachrichtigungen</p>
            </div>
            <input type="tel" name="phone" class="input input-bordered focus:input-primary transition-all" placeholder="+49 123 456789" />
          </div>
        </div>

        <!-- Options Section -->
        <div>
          <div class="mb-5">
            <h4 class="text-sm font-semibold text-base-content uppercase tracking-wide mb-1">Einstellungen</h4>
            <p class="text-xs text-base-content/60">Legen Sie die Standardoptionen fest</p>
          </div>

          <div class="bg-base-200/30 rounded-lg p-4 border border-base-300/30 space-y-3">
            <label class="label cursor-pointer justify-start gap-3 py-1">
              <input type="checkbox" name="isDefault" class="checkbox checkbox-primary" />
              <div>
                <span class="text-sm font-medium text-base-content">Als Standardadresse festlegen</span>
                <p class="text-xs text-base-content/50 mt-1">Diese Adresse wird automatisch beim Checkout ausgewÃ¤hlt</p>
              </div>
            </label>
            <label class="label cursor-pointer justify-start gap-3 py-1">
              <input type="checkbox" name="useBothAddresses" class="checkbox checkbox-primary" checked />
              <div>
                <span class="text-sm font-medium text-base-content">Auch als Rechnungsadresse verwenden</span>
                <p class="text-xs text-base-content/50 mt-1">Die Lieferadresse wird ebenfalls als Rechnungsadresse gespeichert</p>
              </div>
            </label>
          </div>
        </div>

        <div id="address-form-error" class="text-error text-sm hidden"></div>

        <!-- Modal Footer -->
        <div class="flex gap-3 pt-6 border-t border-base-300/30">
          <button type="button" class="btn btn-ghost flex-1" onclick="document.getElementById('address-modal').close()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
            Abbrechen
          </button>
          <button type="submit" class="btn btn-primary flex-1 gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
            </svg>
            Adresse speichern
          </button>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <script define:vars={{ userDiscountPercent, subtotal, selectedShippingId }}>
    let appliedDiscountCode = null;
    let currentShippingCost = 0;
    let currentShippingProfile = null;

    // Mutable subtotal â€” updated when zusatzleistungen change
    let liveSubtotal = subtotal;

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Calculate shipping cost based on profile and subtotal
    function calculateShippingCost(profile, subtotalAmount) {
      if (!profile) return 0;

      const userDiscount = subtotalAmount * (userDiscountPercent / 100);
      const subtotalAfterDiscount = subtotalAmount - userDiscount;

      // Parse numeric values safely
      const basePrice = parseFloat(profile.basePrice) || 0;
      const freeShippingThreshold = profile.freeShippingThreshold ? parseFloat(profile.freeShippingThreshold) : null;

      if (freeShippingThreshold && subtotalAfterDiscount >= freeShippingThreshold) {
        return 0;
      }
      return basePrice;
    }

    // Update the subtotal and user-discount line in the summary sidebar
    function updateSubtotalDisplay() {
      const subtotalEl = document.getElementById('summary-subtotal');
      if (subtotalEl) subtotalEl.textContent = formatPrice(liveSubtotal);

      const userDiscountEl = document.getElementById('summary-user-discount');
      if (userDiscountEl) {
        userDiscountEl.textContent = '-' + formatPrice(liveSubtotal * (userDiscountPercent / 100));
      }
    }

    // Calculate and update summary
    function updateSummary() {
      const userDiscount = liveSubtotal * (userDiscountPercent / 100);
      const subtotalAfterUserDiscount = liveSubtotal - userDiscount;

      // Campaign discount will be validated server-side
      const taxableAmount = subtotalAfterUserDiscount + currentShippingCost;
      const tax = taxableAmount * 0.19;
      const total = taxableAmount + tax;

      const shippingEl = document.getElementById('summary-shipping');
      if (shippingEl) {
        if (currentShippingCost === 0 && currentShippingProfile?.freeShippingThreshold) {
          shippingEl.innerHTML = '<span class="text-success font-semibold">Kostenlos</span>';
        } else {
          shippingEl.textContent = formatPrice(currentShippingCost);
        }
      }

      const taxEl = document.getElementById('summary-tax');
      const totalEl = document.getElementById('summary-total');

      if (taxEl) taxEl.textContent = formatPrice(tax);
      if (totalEl) totalEl.textContent = formatPrice(total);
    }

    function formatPrice(price) {
      // Ensure price is a valid number
      const numPrice = parseFloat(price) || 0;
      return new Intl.NumberFormat('de-DE', {
        style: 'currency',
        currency: 'EUR',
      }).format(numPrice);
    }

    // Load selected shipping profile and calculate cost
    async function loadShippingCost() {
      try {
        const response = await fetch('/api/cart/shipping/select');
        const result = await response.json();

        if (result.success && result.data) {
          currentShippingProfile = result.data;
          currentShippingCost = calculateShippingCost(currentShippingProfile, liveSubtotal);
          updateSummary();
        }
      } catch (error) {
        console.error('Error loading shipping cost:', error);
      }
    }

    // Handle shipping method change
    async function handleShippingChange(shippingId) {
      // Validate UUID format
      const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
      if (!uuidRegex.test(shippingId)) {
        console.error('Invalid shipping profile ID format');
        return;
      }

      try {
        // Save selection to database
        const response = await fetch('/api/cart/shipping/select', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ shippingProfileId: shippingId }),
        });

        const result = await response.json();

        if (result.success) {
          // Reload shipping cost
          await loadShippingCost();
        } else {
          console.error('Failed to update shipping selection:', result.error?.message);
        }
      } catch (error) {
        console.error('Error updating shipping selection:', error);
      }
    }

    // Initialize shipping cost on page load
    loadShippingCost();

    // Add event listeners to shipping radio buttons
    document.querySelectorAll('input[name="shipping"]').forEach((radio) => {
      radio.addEventListener('change', (e) => {
        const shippingId = e.target.value;
        handleShippingChange(shippingId);
      });
    });

    // Handle address form submission
    document.getElementById('address-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      const errorEl = document.getElementById('address-form-error');

      const addressData = {
        firstName: formData.get('firstName'),
        lastName: formData.get('lastName'),
        company: formData.get('company') || null,
        addressLine1: formData.get('addressLine1'),
        addressLine2: formData.get('addressLine2') || null,
        city: formData.get('city'),
        postalCode: formData.get('postalCode'),
        stateProvince: formData.get('stateProvince') || null,
        country: formData.get('country') || 'DE',
        phone: formData.get('phone') || null,
        isDefault: formData.get('isDefault') === 'on',
        addressType: formData.get('useBothAddresses') === 'on' ? 'both' : 'shipping',
      };

      try {
        const response = await fetch('/api/addresses/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(addressData),
        });

        const result = await response.json();

        if (result.success) {
          // Close modal and reload page to show new address
          document.getElementById('address-modal').close();
          window.location.reload();
        } else {
          errorEl.textContent = result.error?.message || 'Fehler beim Speichern der Adresse';
          errorEl.classList.remove('hidden');
        }
      } catch (error) {
        errorEl.textContent = 'Fehler beim Speichern der Adresse';
        errorEl.classList.remove('hidden');
      }
    });

    // Apply discount code
    document.getElementById('apply-discount-btn')?.addEventListener('click', async () => {
      const input = document.getElementById('discount-code-input');
      const code = input.value.trim();
      const messageEl = document.getElementById('discount-message');

      if (!code) {
        messageEl.textContent = 'Bitte geben Sie einen Rabattcode ein.';
        messageEl.className = 'mt-2 text-sm text-error';
        return;
      }

      // Validate code format (alphanumeric, hyphens, underscores only)
      if (!/^[a-zA-Z0-9_-]+$/.test(code)) {
        messageEl.textContent = 'UngÃ¼ltiges Format. Nur Buchstaben, Zahlen, - und _ erlaubt.';
        messageEl.className = 'mt-2 text-sm text-error';
        return;
      }

      // Limit code length to prevent abuse
      if (code.length > 50) {
        messageEl.textContent = 'Rabattcode ist zu lang.';
        messageEl.className = 'mt-2 text-sm text-error';
        return;
      }

      appliedDiscountCode = code;
      messageEl.textContent = 'Code wird beim Checkout validiert.';
      messageEl.className = 'mt-2 text-sm text-info';
    });

    // PayPal Checkout
    async function createPayPalOrder() {
      const loadingEl = document.getElementById('payment-loading');
      const errorEl = document.getElementById('payment-error');

      // Get selected address
      const selectedAddressInput = document.querySelector('input[name="address"]:checked');
      if (!selectedAddressInput) {
        errorEl.textContent = 'Bitte wÃ¤hlen Sie eine Lieferadresse aus.';
        errorEl.classList.remove('hidden');
        throw new Error('No address selected');
      }

      const addressId = selectedAddressInput.value;

      // Validate UUID format
      const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
      if (!uuidRegex.test(addressId)) {
        errorEl.textContent = 'UngÃ¼ltige Adress-ID.';
        errorEl.classList.remove('hidden');
        throw new Error('Invalid address ID');
      }

      loadingEl.classList.remove('hidden');
      errorEl.classList.add('hidden');

      try {
        const response = await fetch('/api/checkout/create-paypal-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            discountCode: appliedDiscountCode,
            addressId: addressId,
          }),
        });

        const result = await response.json();

        if (!result.success) {
          throw new Error(result.error?.message || 'Failed to create PayPal order');
        }

        return result.data.paypalOrderId;
      } catch (error) {
        errorEl.textContent = error.message;
        errorEl.classList.remove('hidden');
        throw error;
      } finally {
        loadingEl.classList.add('hidden');
      }
    }

    function onPayPalApprove(data) {
      window.location.href = `/checkout/success?token=${data.orderID}`;
    }

    // Handle zusatzleistungen checkbox changes at checkout
    document.querySelectorAll('.service-checkbox').forEach((checkbox) => {
      checkbox.addEventListener('change', async (e) => {
        const target = e.target;
        const cartItemId = target.dataset.cartItemId;
        if (!cartItemId) return;

        // Disable all checkboxes for this item while updating
        const itemCheckboxes = document.querySelectorAll(`.service-checkbox[data-cart-item-id="${cartItemId}"]`);
        itemCheckboxes.forEach((cb) => { cb.disabled = true; });

        // Collect all currently selected service IDs for this cart item
        const selectedIds = Array.from(itemCheckboxes)
          .filter((cb) => cb.checked)
          .map((cb) => cb.dataset.serviceId);

        try {
          const response = await fetch('/api/cart/update-services', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ cartItemId, zusatzleistungIds: selectedIds }),
          });

          const result = await response.json();

          if (result.success) {
            // Update item total in the order summary list
            const itemTotalEl = document.querySelector(`.checkout-item-total[data-checkout-item-id="${cartItemId}"]`);
            if (itemTotalEl) itemTotalEl.textContent = formatPrice(result.data.itemTotal);

            // Update the live subtotal and recalculate everything
            liveSubtotal = result.data.newSubtotal;
            updateSubtotalDisplay();
            // Recalculate shipping with new subtotal
            if (currentShippingProfile) {
              currentShippingCost = calculateShippingCost(currentShippingProfile, liveSubtotal);
            }
            updateSummary();
          } else {
            // Revert the checkbox on failure
            target.checked = !target.checked;
            console.error('Failed to update service:', result.error?.message);
          }
        } catch (error) {
          target.checked = !target.checked;
          console.error('Error updating service:', error);
        } finally {
          itemCheckboxes.forEach((cb) => { cb.disabled = false; });
        }
      });
    });

    // Initialize summary
    updateSummary();

    // Initialize PayPal Buttons
    if (window.paypal) {
      window.paypal
        .Buttons({
          style: {
            layout: 'vertical',
            color: 'gold',
            shape: 'rect',
            label: 'paypal',
          },
          createOrder: async function () {
            try {
              return await createPayPalOrder();
            } catch (error) {
              console.error('Error creating PayPal order:', error);
              const errorEl = document.getElementById('payment-error');
              errorEl.textContent = error.message || 'Fehler beim Erstellen der PayPal-Bestellung';
              errorEl.classList.remove('hidden');
              throw error;
            }
          },
          onApprove: function (data, actions) {
            onPayPalApprove(data);
          },
          onCancel: function (data) {
            window.location.href = '/checkout/cancel';
          },
          onError: function (err) {
            console.error('PayPal error:', err);
            const errorEl = document.getElementById('payment-error');
            errorEl.textContent =
              'Ein Fehler ist bei der PayPal-Zahlung aufgetreten. Bitte versuchen Sie es erneut.';
            errorEl.classList.remove('hidden');
          },
        })
        .render('#paypal-button-container');
    } else {
      // Fallback if PayPal SDK fails to load
      const paypalContainer = document.getElementById('paypal-button-container');
      paypalContainer.innerHTML = `
        <div class="alert alert-error">
          <span>PayPal konnte nicht geladen werden. Bitte laden Sie die Seite neu.</span>
        </div>
      `;
    }
  </script>
</Layout>
