---
import Layout from '../../layouts/Layout.astro';
import Navbar from '../../components/Navbar.astro';
import { pool } from '../../lib/db';

const user = Astro.locals.user;
const { orderNumber } = Astro.params;

if (!user) {
  return Astro.redirect('/');
}

if (!orderNumber) {
  return Astro.redirect('/');
}

const title = `Bestellung ${orderNumber} - DTF Transfer Print`;
const description = 'Ihre Bestellbestätigung';

// Fetch order details
const client = await pool.connect();
let order: any = null;
let orderItems: any[] = [];
let shippingAddress: any = null;
let billingAddress: any = null;

try {
  const orderResult = await client.query(
    `
    SELECT o.* FROM orders o
    WHERE o."orderNumber" = $1 AND o."userId" = $2
  `,
    [orderNumber, user.id]
  );

  if (orderResult.rows.length === 0) {
    return Astro.redirect('/');
  }

  order = orderResult.rows[0];

  // Fetch order items
  const itemsResult = await client.query(
    `
    SELECT * FROM "orderItems"
    WHERE "orderId" = $1
  `,
    [order.id]
  );
  orderItems = itemsResult.rows;

  // Fetch addresses
  if (order.shippingAddressId) {
    const shippingResult = await client.query(
      'SELECT * FROM "userAddresses" WHERE id = $1',
      [order.shippingAddressId]
    );
    shippingAddress = shippingResult.rows[0];
  }

  if (order.billingAddressId) {
    const billingResult = await client.query(
      'SELECT * FROM "userAddresses" WHERE id = $1',
      [order.billingAddressId]
    );
    billingAddress = billingResult.rows[0];
  }
} finally {
  client.release();
}

const formatPrice = (price: number | string) => {
  const numPrice = typeof price === 'string' ? parseFloat(price) : price;
  return new Intl.NumberFormat('de-DE', {
    style: 'currency',
    currency: 'EUR',
  }).format(numPrice);
};

const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('de-DE', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  }).format(new Date(date));
};
---

<Layout title={title} description={description}>
  <Navbar />

  <div class="min-h-screen bg-gradient-to-br from-primary/10 via-base-100 to-secondary/10">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 max-w-4xl">
      {/* Success Header */}
      <div class="bg-base-100 border border-base-300/50 rounded-lg p-8 mb-6">
        <div class="text-center">
          <div
            class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-success/10 mb-4"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-8 w-8 text-success"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
            </svg>
          </div>
          <h1 class="text-3xl font-semibold text-neutral mb-2">Vielen Dank für Ihre Bestellung!</h1>
          <p class="text-neutral/60">
            Ihre Bestellung wurde erfolgreich aufgegeben und wird bearbeitet.
          </p>
          <div class="mt-4 inline-flex items-center gap-2 px-4 py-2 bg-base-200 rounded-lg">
            <span class="text-sm text-neutral/60">Bestellnummer:</span>
            <span class="font-mono font-semibold text-primary">{order.orderNumber}</span>
          </div>
        </div>
      </div>

      {/* Order Details */}
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        {/* Order Information */}
        <div class="bg-base-100 border border-base-300/50 rounded-lg p-6">
          <h2 class="text-lg font-semibold mb-4">Bestellinformationen</h2>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-neutral/60">Bestelldatum:</span>
              <span>{formatDate(order.createdAt)}</span>
            </div>
            <div class="flex justify-between">
              <span class="text-neutral/60">Zahlungsstatus:</span>
              <span
                class={`badge ${
                  order.paymentStatus === 'paid' ? 'badge-success' : 'badge-warning'
                }`}
              >
                {order.paymentStatus === 'paid' ? 'Bezahlt' : 'Ausstehend'}
              </span>
            </div>
            <div class="flex justify-between">
              <span class="text-neutral/60">Bestellstatus:</span>
              <span class="badge badge-info">
                {order.status === 'pending'
                  ? 'In Bearbeitung'
                  : order.status === 'processing'
                    ? 'Wird bearbeitet'
                    : order.status === 'shipped'
                      ? 'Versandt'
                      : 'Geliefert'}
              </span>
            </div>
            {order.paypalCaptureId && (
              <div class="flex justify-between">
                <span class="text-neutral/60">PayPal Transaktions-ID:</span>
                <span class="font-mono text-xs">{order.paypalCaptureId.substring(0, 20)}...</span>
              </div>
            )}
          </div>
        </div>

        {/* Shipping Address */}
        {
          shippingAddress && (
            <div class="bg-base-100 border border-base-300/50 rounded-lg p-6">
              <h2 class="text-lg font-semibold mb-4">Lieferadresse</h2>
              <div class="text-sm space-y-1">
                <p class="font-medium">
                  {shippingAddress.firstName} {shippingAddress.lastName}
                </p>
                {shippingAddress.company && <p class="text-neutral/60">{shippingAddress.company}</p>}
                <p>{shippingAddress.addressLine1}</p>
                {shippingAddress.addressLine2 && <p>{shippingAddress.addressLine2}</p>}
                <p>
                  {shippingAddress.postalCode} {shippingAddress.city}
                </p>
                <p>{shippingAddress.country}</p>
                {shippingAddress.phone && <p class="text-neutral/60">{shippingAddress.phone}</p>}
              </div>
            </div>
          )
        }
      </div>

      {/* Order Items */}
      <div class="bg-base-100 border border-base-300/50 rounded-lg p-6 mb-6">
        <h2 class="text-lg font-semibold mb-4">Bestellte Artikel</h2>
        <div class="space-y-4">
          {
            orderItems.map((item) => (
              <div class="flex justify-between items-start pb-4 border-b border-base-300/30 last:border-0">
                <div class="flex-1">
                  <h3 class="font-medium">{item.productName}</h3>
                  {item.sku && <p class="text-xs text-neutral/60">SKU: {item.sku}</p>}
                  <p class="text-sm text-neutral/60">Menge: {item.quantity}</p>
                  {item.customOptions && (
                    <div class="text-xs text-neutral/60 mt-1">
                      {item.customOptions.widthMm && (
                        <span>Breite: {item.customOptions.widthMm}mm</span>
                      )}
                      {item.customOptions.heightMm && (
                        <span class="ml-2">Höhe: {item.customOptions.heightMm}mm</span>
                      )}
                    </div>
                  )}
                </div>
                <div class="text-right">
                  <p class="font-medium">{formatPrice(item.totalPrice)}</p>
                  <p class="text-xs text-neutral/60">{formatPrice(item.unitPrice)} / Stück</p>
                </div>
              </div>
            ))
          }
        </div>
      </div>

      {/* Order Summary */}
      <div class="bg-base-100 border border-base-300/50 rounded-lg p-6">
        <h2 class="text-lg font-semibold mb-4">Zusammenfassung</h2>
        <div class="space-y-2">
          <div class="flex justify-between text-sm">
            <span class="text-neutral/60">Zwischensumme</span>
            <span>{formatPrice(order.subtotal)}</span>
          </div>

          {
            parseFloat(order.userDiscountPercent) > 0 && (
              <div class="flex justify-between text-sm text-success">
                <span>Ihr Rabatt ({order.userDiscountPercent}%)</span>
                <span>
                  -
                  {formatPrice(
                    parseFloat(order.subtotal) * (parseFloat(order.userDiscountPercent) / 100)
                  )}
                </span>
              </div>
            )
          }

          {
            parseFloat(order.discountAmount) > 0 && (
              <div class="flex justify-between text-sm text-success">
                <span>
                  Rabatt {order.discountCode ? `(${order.discountCode})` : ''}
                </span>
                <span>-{formatPrice(order.discountAmount)}</span>
              </div>
            )
          }

          <div class="flex justify-between text-sm">
            <span class="text-neutral/60">Versand</span>
            <span>{formatPrice(order.shippingCost)}</span>
          </div>

          <div class="flex justify-between text-sm">
            <span class="text-neutral/60">MwSt. (19%)</span>
            <span>{formatPrice(order.taxAmount)}</span>
          </div>

          <div class="border-t border-base-300 pt-2 mt-2">
            <div class="flex justify-between font-semibold text-lg">
              <span>Gesamt</span>
              <span class="text-primary">{formatPrice(order.total)}</span>
            </div>
          </div>
        </div>
      </div>

      {/* Actions */}
      <div class="mt-6 flex justify-center gap-4">
        <a href="/products" class="btn btn-primary">Weiter einkaufen</a>
        <button onclick="window.print()" class="btn btn-ghost">Bestellung drucken</button>
      </div>
    </div>
  </div>
</Layout>
