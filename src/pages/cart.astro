---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import { pool } from '../lib/db';

const user = Astro.locals.user;

const title = 'Warenkorb - DTF Transfer Print';
const description = 'Überprüfen Sie Ihren Warenkorb und schließen Sie Ihre Bestellung ab.';

// Fetch cart with price tier information
let cartItems: any[] = [];
let subtotal = 0;
let totalSavings = 0;

if (user) {
	const response = await fetch(`${Astro.url.origin}/api/cart/get`, {
		headers: {
			'Cookie': Astro.request.headers.get('Cookie') || '',
		},
	});

	if (response.ok) {
		const result = await response.json();
		if (result.success) {
			cartItems = result.data.items || [];
			subtotal = result.data.subtotal || 0;
			totalSavings = cartItems.reduce((sum, item) => sum + (item.currentSavings || 0), 0);
		}
	}
}

const formatPrice = (price: number) => {
	return new Intl.NumberFormat('de-DE', {
		style: 'currency',
		currency: 'EUR'
	}).format(price);
};
---

<Layout title={title} description={description}>
	<Navbar />

	<div class="min-h-screen bg-gradient-to-br from-primary/10 via-base-100 to-secondary/10">
		<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 max-w-6xl">
			{!user ? (
				<!-- Not logged in state -->
				<div class="min-h-[60vh] flex items-center justify-center">
					<div class="text-center max-w-md space-y-4">
						<div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-base-200 mb-2">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-neutral/40" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
								<path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
							</svg>
						</div>
						<h2 class="text-2xl font-semibold text-neutral">Anmeldung erforderlich</h2>
						<p class="text-neutral/60">Melden Sie sich an, um auf Ihren Warenkorb zuzugreifen.</p>
						<button class="btn btn-primary mt-4" id="login-prompt-btn">
							Anmelden
						</button>
					</div>
				</div>
			) : cartItems.length === 0 ? (
				<!-- Empty cart state -->
				<div class="min-h-[60vh] flex items-center justify-center">
					<div class="text-center max-w-md space-y-4">
						<div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-base-200 mb-2">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-neutral/40" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
								<path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
							</svg>
						</div>
						<h2 class="text-2xl font-semibold text-neutral">Ihr Warenkorb ist leer</h2>
						<p class="text-neutral/60">Beginnen Sie mit dem Einkaufen und fügen Sie Produkte hinzu.</p>
						<a href="/products" class="btn btn-primary mt-4">
							Produkte ansehen
						</a>
					</div>
				</div>
			) : (
				<!-- Cart with items -->
				<div class="space-y-8">
					<!-- Header -->
					<div class="flex items-baseline justify-between border-b border-base-300/50 pb-6">
						<div>
							<h1 class="text-3xl font-semibold text-neutral mb-1">Warenkorb</h1>
							<p class="text-sm text-neutral/60">{cartItems.length} {cartItems.length === 1 ? 'Artikel' : 'Artikel'}</p>
						</div>
						<a href="/products" class="text-sm text-primary hover:text-primary-focus transition-colors">
							Weiter einkaufen
						</a>
					</div>

					<!-- Main Grid -->
					<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
						<!-- Cart Items -->
						<div class="lg:col-span-2 space-y-4">
							<div id="cart-items-list" class="space-y-3">
								{cartItems.map((item) => (
									<div class="bg-base-100 border border-base-300/50 rounded-lg hover:border-base-300 transition-all" data-cart-item-id={item.id}>
										<div class="p-4">
											<div class="flex gap-4">
												<!-- Image -->
												<div class="flex-shrink-0">
													<div class="w-20 h-20 bg-base-200 rounded-md overflow-hidden">
														{item.productImage ? (
															<img src={item.productImage} alt={item.productName} class="w-full h-full object-cover" />
														) : (
															<div class="w-full h-full flex items-center justify-center text-neutral/20">
																<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
																	<path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
																</svg>
															</div>
														)}
													</div>
												</div>

												<!-- Info -->
												<div class="flex-1 min-w-0">
													<a href={`/product/${item.productSlug}`} class="text-base font-medium text-neutral line-clamp-2 mb-2 block">
														{item.productName}
													</a>

													<div class="flex items-center gap-2 mb-3">
														<span class="text-sm text-neutral/50">Stückpreis:</span>
														<span class="text-base font-semibold text-neutral cart-item-unit-price" data-cart-item-id={item.id}>
															{formatPrice(item.unitPrice)}
														</span>
													</div>

													{item.currentSavings > 0 && (
														<div class="inline-flex items-center gap-1.5 text-xs text-success bg-success/10 px-2 py-1 rounded">
															<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
																<path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
															</svg>
															Sie sparen {formatPrice(item.currentSavings)}
														</div>
													)}

													<!-- Zusatzleistungen -->
													{item.zusatzleistungen && item.zusatzleistungen.length > 0 && (
														<div class="mt-3 pt-3 border-t border-base-200">
															<div class="text-xs font-medium text-neutral/50 mb-2">Zusatzleistungen:</div>
															<div class="space-y-1">
																{item.zusatzleistungen.map((service: any) => (
																	<div class="flex items-center justify-between text-xs">
																		<span class="text-neutral/70">{service.name}</span>
																		<span class="font-medium text-neutral">+{formatPrice(service.price)}</span>
																	</div>
																))}
															</div>
														</div>
													)}

													<!-- Quantity -->
													<div class="flex items-center gap-3 mt-3">
														<span class="text-xs text-neutral/50">Menge:</span>
														<div class="flex items-center gap-2 bg-base-200 rounded-md">
															<button
																class="quantity-decrease w-8 h-8 flex items-center justify-center hover:bg-base-300 rounded-l-md transition-colors"
																data-cart-item-id={item.id}
																aria-label="Menge verringern"
															>
																<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-neutral" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
																	<path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4" />
																</svg>
															</button>
															<span class="cart-item-quantity text-sm font-medium text-neutral px-3">{item.quantity}</span>
															<button
																class="quantity-increase w-8 h-8 flex items-center justify-center hover:bg-base-300 rounded-r-md transition-colors"
																data-cart-item-id={item.id}
																aria-label="Menge erhöhen"
															>
																<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-neutral" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
																	<path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
																</svg>
															</button>
														</div>
													</div>
												</div>

												<!-- Price & Remove -->
												<div class="flex flex-col items-end justify-between text-right">
													<div class="text-lg font-semibold text-neutral cart-item-total">
														{formatPrice(item.totalWithServices || (item.unitPrice * item.quantity))}
													</div>
													<button
														class="remove-item text-xs text-error/70 hover:text-error transition-colors mt-2"
														data-cart-item-id={item.id}
														aria-label="Entfernen"
													>
														Entfernen
													</button>
												</div>
											</div>
										</div>
									</div>
								))}
							</div>
						</div>

						<!-- Summary Sidebar -->
						<div class="lg:col-span-1">
							<div class="sticky top-24">
								<div class="bg-base-100 border border-base-300/50 rounded-lg p-6">
									<h2 class="text-lg font-semibold text-neutral mb-5">Zusammenfassung</h2>

									<div class="space-y-5">
										<!-- Order Summary Section -->
										<div class="space-y-3">
											<div class="text-xs font-medium text-neutral/50 uppercase tracking-wide mb-2">Bestellübersicht</div>
											<!-- Subtotal -->
											<div class="flex justify-between text-sm">
												<span class="text-neutral/60">Zwischensumme</span>
												<span class="font-medium text-neutral" id="cart-subtotal">{formatPrice(subtotal)}</span>
											</div>

											{totalSavings > 0 && (
												<div class="flex justify-between items-center text-sm bg-success/5 -mx-6 px-6 py-3 rounded">
													<span class="text-success font-medium">Sie sparen</span>
													<span class="text-success font-semibold" id="total-savings">{formatPrice(totalSavings)}</span>
												</div>
											)}
										</div>

										<!-- Shipping Section -->
										<div class="space-y-3 pt-3 border-t border-base-300/30">
											<div class="text-xs font-medium text-neutral/50 uppercase tracking-wide mb-2">Versand</div>
											<!-- Shipping Method Selector -->
											<div id="shipping-profiles-container" class="space-y-1">
												<!-- Shipping profiles will be loaded here -->
											</div>

											<!-- Shipping Cost -->
											<div class="flex justify-between text-sm pt-2">
												<span class="text-neutral/60">Versandkosten</span>
												<span class="font-medium text-neutral" id="shipping-cost">-</span>
											</div>
										</div>

										<!-- Total Section -->
										<div class="border-t border-base-300/30 pt-4 mt-4">
											<div class="flex justify-between items-baseline">
												<span class="text-base font-semibold text-neutral">Gesamt</span>
												<span class="text-2xl font-semibold text-neutral" id="cart-total">{formatPrice(subtotal)}</span>
											</div>
										</div>
									</div>

									<!-- Checkout Button -->
									<a href="/checkout" class="btn btn-primary w-full mt-6">
										Zur Kasse
									</a>

									<!-- Trust Signals -->
									<div class="mt-6 pt-6 border-t border-base-300/50 space-y-3">
										<div class="flex items-start gap-2">
											<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-success flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
												<path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
											</svg>
											<div>
												<div class="text-xs font-medium text-neutral">Sichere Zahlung</div>
												<div class="text-xs text-neutral/50">SSL-verschlüsselt</div>
											</div>
										</div>
										<div class="flex items-start gap-2">
											<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
												<path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
											</svg>
											<div>
												<div class="text-xs font-medium text-neutral">Schnelle Lieferung</div>
												<div class="text-xs text-neutral/50">2-3 Werktage</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			)}
		</div>
	</div>
</Layout>

<style>
	/* Clean transitions */
	.cart-item-total,
	.cart-item-unit-price,
	.cart-item-quantity {
		transition: all 0.2s ease;
	}

	/* Radio buttons in accent orange */
	.radio:checked {
		border-color: var(--color-accent);
		background-color: var(--color-accent);
	}

	.radio:checked::before {
		background-color: white;
	}

	.radio:focus {
		outline-color: var(--color-accent);
	}
</style>

<script>
	const formatPrice = (price: number) => {
		return new Intl.NumberFormat('de-DE', {
			style: 'currency',
			currency: 'EUR'
		}).format(price);
	};

	const escapeHtml = (text: string) => {
		const div = document.createElement('div');
		div.textContent = text;
		return div.innerHTML;
	};

	const renderCartItem = (item: any) => {
		const savingsHtml = item.currentSavings > 0
			? `<div class="inline-flex items-center gap-1.5 text-xs text-success bg-success/10 px-2 py-1 rounded">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
							<path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
						</svg>
						Sie sparen ${formatPrice(item.currentSavings)}
					</div>`
			: '';

		const imageHtml = item.productImage
			? `<img src="${escapeHtml(item.productImage)}" alt="${escapeHtml(item.productName)}" class="w-full h-full object-cover" />`
			: `<div class="w-full h-full flex items-center justify-center text-neutral/20">
						<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
							<path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
						</svg>
					</div>`;

		return `
			<div class="bg-base-100 border border-base-300/50 rounded-lg hover:border-base-300 transition-all" data-cart-item-id="${escapeHtml(item.id)}">
				<div class="p-4">
					<div class="flex gap-4">
						<!-- Image -->
						<div class="flex-shrink-0">
							<div class="w-20 h-20 bg-base-200 rounded-md overflow-hidden">
								${imageHtml}
							</div>
						</div>

						<!-- Info -->
						<div class="flex-1 min-w-0">
							<a href="/product/${escapeHtml(item.productSlug)}" class="text-base font-medium text-neutral line-clamp-2 mb-2 block">
								${escapeHtml(item.productName)}
							</a>

							<div class="flex items-center gap-2 mb-3">
								<span class="text-sm text-neutral/50">Stückpreis:</span>
								<span class="text-base font-semibold text-neutral cart-item-unit-price" data-cart-item-id="${escapeHtml(item.id)}">
									${formatPrice(item.unitPrice)}
								</span>
							</div>

							${savingsHtml}

							<!-- Quantity -->
							<div class="flex items-center gap-3 mt-3">
								<span class="text-xs text-neutral/50">Menge:</span>
								<div class="flex items-center gap-2 bg-base-200 rounded-md">
									<button
										class="quantity-decrease w-8 h-8 flex items-center justify-center hover:bg-base-300 rounded-l-md transition-colors"
										data-cart-item-id="${escapeHtml(item.id)}"
										aria-label="Menge verringern"
									>
										<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-neutral" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
											<path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4" />
										</svg>
									</button>
									<span class="cart-item-quantity text-sm font-medium text-neutral px-3">${item.quantity}</span>
									<button
										class="quantity-increase w-8 h-8 flex items-center justify-center hover:bg-base-300 rounded-r-md transition-colors"
										data-cart-item-id="${escapeHtml(item.id)}"
										aria-label="Menge erhöhen"
									>
										<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-neutral" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
											<path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
										</svg>
									</button>
								</div>
							</div>
						</div>

						<!-- Price & Remove -->
						<div class="flex flex-col items-end justify-between text-right">
							<div class="text-lg font-semibold text-neutral cart-item-total">
								${formatPrice(item.unitPrice * item.quantity)}
							</div>
							<button
								class="remove-item text-xs text-error/70 hover:text-error transition-colors mt-2"
								data-cart-item-id="${escapeHtml(item.id)}"
								aria-label="Entfernen"
							>
								Entfernen
							</button>
						</div>
					</div>
				</div>
			</div>
		`;
	};

	const renderCartItems = (items: any[]) => {
		const container = document.getElementById('cart-items-list');
		if (!container) return;

		if (items.length === 0) {
			window.location.reload();
			return;
		}

		container.innerHTML = items.map(item => renderCartItem(item)).join('');
		attachCartItemListeners();
	};

	const attachCartItemListeners = () => {
		document.querySelectorAll('.quantity-decrease').forEach((button) => {
			button.addEventListener('click', (e) => {
				e.preventDefault();
				const cartItemId = (e.currentTarget as HTMLElement).getAttribute('data-cart-item-id');
				if (!cartItemId) return;

				const quantityElement = document.querySelector(`[data-cart-item-id="${cartItemId}"] .cart-item-quantity`);
				const currentQuantity = parseInt(quantityElement?.textContent || '1');

				if (currentQuantity > 1) {
					updateCartItemQuantity(cartItemId, currentQuantity - 1);
				}
			});
		});

		document.querySelectorAll('.quantity-increase').forEach((button) => {
			button.addEventListener('click', (e) => {
				e.preventDefault();
				const cartItemId = (e.currentTarget as HTMLElement).getAttribute('data-cart-item-id');
				if (!cartItemId) return;

				const quantityElement = document.querySelector(`[data-cart-item-id="${cartItemId}"] .cart-item-quantity`);
				const currentQuantity = parseInt(quantityElement?.textContent || '1');

				updateCartItemQuantity(cartItemId, currentQuantity + 1);
			});
		});

		document.querySelectorAll('.remove-item').forEach((button) => {
			button.addEventListener('click', (e) => {
				e.preventDefault();
				e.stopPropagation();
				const cartItemId = (e.currentTarget as HTMLElement).getAttribute('data-cart-item-id');
				if (!cartItemId) return;

				removeCartItem(cartItemId);
			});
		});
	};

	const updateCartUI = async () => {
		try {
			const response = await fetch('/api/cart/get');
			const result = await response.json();

			if (result.success) {
				const { items, subtotal } = result.data;

				renderCartItems(items);

				const cartSubtotal = document.getElementById('cart-subtotal');
				if (cartSubtotal) {
					cartSubtotal.textContent = formatPrice(subtotal);
				}

				// Update current subtotal for shipping calculation
				currentSubtotal = subtotal;

				const totalSavings = items.reduce((sum: number, item: any) => sum + (item.currentSavings || 0), 0);
				const totalSavingsElement = document.getElementById('total-savings');
				if (totalSavingsElement) {
					totalSavingsElement.textContent = formatPrice(totalSavings);
				}

				// Recalculate total with updated subtotal
				updateTotal();

				window.dispatchEvent(new CustomEvent('cartUpdated', { detail: { count: items.length, items, subtotal } }));
			}
		} catch (error) {
			console.error('Error updating cart UI:', error);
		}
	};

	const updateCartItemQuantity = async (cartItemId: string, newQuantity: number) => {
		try {
			const response = await fetch('/api/cart/update', {
				method: 'PUT',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ cartItemId, quantity: newQuantity }),
			});

			const result = await response.json();

			if (result.success) {
				await updateCartUI();
			} else {
				alert(result.error?.message || 'Fehler beim Aktualisieren des Warenkorbs');
			}
		} catch (error) {
			console.error('Error updating cart item:', error);
			alert('Fehler beim Aktualisieren des Warenkorbs');
		}
	};

	const removeCartItem = async (cartItemId: string) => {
		if (!confirm('Möchten Sie diesen Artikel wirklich entfernen?')) {
			return;
		}

		try {
			const response = await fetch('/api/cart/remove', {
				method: 'DELETE',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ cartItemId }),
			});

			const result = await response.json();

			if (result.success) {
				await updateCartUI();
			} else {
				alert(result.error?.message || 'Fehler beim Entfernen des Artikels');
			}
		} catch (error) {
			console.error('Error removing cart item:', error);
			alert('Fehler beim Entfernen des Artikels');
		}
	};

	// Shipping profile management
	let currentShippingProfile: any = null;
	let currentSubtotal = 0;

	const calculateShippingCost = (profile: any, subtotal: number): number => {
		if (profile.freeShippingThreshold && subtotal >= profile.freeShippingThreshold) {
			return 0;
		}
		return profile.basePrice;
	};

	const updateTotal = () => {
		const shippingCost = currentShippingProfile ? calculateShippingCost(currentShippingProfile, currentSubtotal) : 0;
		const total = currentSubtotal + shippingCost;

		const shippingCostEl = document.getElementById('shipping-cost');
		const totalEl = document.getElementById('cart-total');

		if (shippingCostEl) {
			if (shippingCost === 0 && currentShippingProfile?.freeShippingThreshold) {
				shippingCostEl.innerHTML = `<span class="text-success font-semibold">Kostenlos</span>`;
			} else {
				shippingCostEl.textContent = formatPrice(shippingCost);
			}
		}

		if (totalEl) {
			totalEl.textContent = formatPrice(total);
		}
	};

	const loadShippingProfiles = async () => {
		try {
			// Fetch all active shipping profiles
			const profilesResponse = await fetch('/api/shipping/active');
			const profilesResult = await profilesResponse.json();

			if (!profilesResult.success) {
				console.error('Failed to fetch shipping profiles');
				return;
			}

			const profiles = profilesResult.data;

			// Fetch user's selected profile
			const selectedResponse = await fetch('/api/cart/shipping/select');
			const selectedResult = await selectedResponse.json();

			let selectedProfileId = null;
			if (selectedResult.success && selectedResult.data) {
				selectedProfileId = selectedResult.data.id;
				currentShippingProfile = selectedResult.data;
			} else if (profiles.length > 0) {
				// Use first profile as default
				currentShippingProfile = profiles[0];
				selectedProfileId = profiles[0].id;
			}

			// Render shipping profiles
			const container = document.getElementById('shipping-profiles-container');
			if (!container) return;

			container.innerHTML = profiles.map((profile: any) => {
				const isSelected = profile.id === selectedProfileId;
				const shippingCost = calculateShippingCost(profile, currentSubtotal);
				const isFree = shippingCost === 0 && profile.freeShippingThreshold;

				return `
					<label class="flex items-center justify-between py-2.5 px-3 -mx-3 rounded-md cursor-pointer hover:bg-base-200/50 transition-colors ${isSelected ? 'bg-base-200/30' : ''}">
						<div class="flex items-center gap-3 flex-1 min-w-0">
							<input
								type="radio"
								name="shipping-profile"
								value="${profile.id}"
								class="radio radio-xs"
								${isSelected ? 'checked' : ''}
								onchange="selectShippingProfile('${profile.id}')"
							/>
							<div class="flex-1 min-w-0">
								<div class="flex items-baseline gap-2">
									<span class="text-sm font-medium text-neutral">${escapeHtml(profile.name)}</span>
									${profile.estimatedDays ? `<span class="text-xs text-neutral/50">${profile.estimatedDays} ${profile.estimatedDays === 1 ? 'Tag' : 'Tage'}</span>` : ''}
								</div>
								${profile.freeShippingThreshold && currentSubtotal < profile.freeShippingThreshold
									? `<p class="text-xs text-neutral/50 mt-0.5">Kostenlos ab ${formatPrice(profile.freeShippingThreshold)}</p>`
									: ''
								}
							</div>
						</div>
						<span class="text-sm font-medium ${isFree ? 'text-success' : 'text-neutral'} ml-3">
							${isFree ? 'Kostenlos' : formatPrice(profile.basePrice)}
						</span>
					</label>
				`;
			}).join('');

			// Update total with shipping
			updateTotal();
		} catch (error) {
			console.error('Error loading shipping profiles:', error);
		}
	};

	(window as any).selectShippingProfile = async (profileId: string) => {
		try {
			const response = await fetch('/api/cart/shipping/select', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ shippingProfileId: profileId }),
			});

			const result = await response.json();

			if (result.success) {
				// Fetch the selected profile details
				const profilesResponse = await fetch('/api/shipping/active');
				const profilesResult = await profilesResponse.json();

				if (profilesResult.success) {
					currentShippingProfile = profilesResult.data.find((p: any) => p.id === profileId);
					updateTotal();
				}
			} else {
				alert(result.error?.message || 'Fehler beim Auswählen der Versandart');
			}
		} catch (error) {
			console.error('Error selecting shipping profile:', error);
			alert('Fehler beim Auswählen der Versandart');
		}
	};

	document.addEventListener('DOMContentLoaded', () => {
		attachCartItemListeners();

		const loginPromptBtn = document.getElementById('login-prompt-btn');
		if (loginPromptBtn) {
			loginPromptBtn.addEventListener('click', () => {
				(window as any).openAuthModal('login');
			});
		}

		// Load shipping profiles if cart has items
		const cartSubtotalEl = document.getElementById('cart-subtotal');
		if (cartSubtotalEl) {
			// Parse subtotal from the page
			const subtotalText = cartSubtotalEl.textContent || '0';
			currentSubtotal = parseFloat(subtotalText.replace(/[^0-9,]/g, '').replace(',', '.'));
			loadShippingProfiles();
		}
	});
</script>
