---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import { pool } from '../lib/db';

const user = Astro.locals.user;

const title = 'Warenkorb - DTF Transfer Print';
const description = 'Überprüfen Sie Ihren Warenkorb und schließen Sie Ihre Bestellung ab.';

// Fetch cart with price tier information
let cartItems: any[] = [];
let subtotal = 0;
let totalSavings = 0;
let userDiscountPercent = 0;
let hasAddresses = false;

if (user) {
	const response = await fetch(`${Astro.url.origin}/api/cart/get`, {
		headers: {
			'Cookie': Astro.request.headers.get('Cookie') || '',
		},
	});

	if (response.ok) {
		const result = await response.json();
		if (result.success) {
			cartItems = result.data.items || [];
			subtotal = result.data.subtotal || 0;
			totalSavings = cartItems.reduce((sum, item) => sum + (item.currentSavings || 0), 0);
		}
	}

	// Fetch user discount percentage and check for addresses
	const client = await pool.connect();
	try {
		const userResult = await client.query(
			'SELECT "discountPercent" FROM "user" WHERE id = $1',
			[user.id]
		);
		userDiscountPercent = parseFloat(userResult.rows[0]?.discountPercent || 0);

		// Check if user has any addresses
		const addressResult = await client.query(
			'SELECT COUNT(*) as count FROM "userAddresses" WHERE "userId" = $1',
			[user.id]
		);
		hasAddresses = parseInt(addressResult.rows[0]?.count || 0) > 0;
	} finally {
		client.release();
	}
}

const formatPrice = (price: number) => {
	return new Intl.NumberFormat('de-DE', {
		style: 'currency',
		currency: 'EUR'
	}).format(price);
};
---

<Layout title={title} description={description}>
	<Navbar />

	<div class="min-h-screen bg-gradient-to-br from-primary/10 via-base-100 to-secondary/10">
		<div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 max-w-6xl">
			{!user ? (
				<!-- Not logged in state -->
				<div class="min-h-[60vh] flex items-center justify-center">
					<div class="text-center max-w-md space-y-4">
						<div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-base-200 mb-2">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-neutral/40" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
								<path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
							</svg>
						</div>
						<h2 class="text-2xl font-semibold text-neutral">Anmeldung erforderlich</h2>
						<p class="text-neutral/60">Melden Sie sich an, um auf Ihren Warenkorb zuzugreifen.</p>
						<button class="btn btn-primary mt-4" id="login-prompt-btn">
							Anmelden
						</button>
					</div>
				</div>
			) : cartItems.length === 0 ? (
				<!-- Empty cart state -->
				<div class="min-h-[60vh] flex items-center justify-center">
					<div class="text-center max-w-md space-y-4">
						<div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-base-200 mb-2">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-neutral/40" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
								<path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
							</svg>
						</div>
						<h2 class="text-2xl font-semibold text-neutral">Ihr Warenkorb ist leer</h2>
						<p class="text-neutral/60">Beginnen Sie mit dem Einkaufen und fügen Sie Produkte hinzu.</p>
						<a href="/products" class="btn btn-primary mt-4">
							Produkte ansehen
						</a>
					</div>
				</div>
			) : (
				<!-- Cart with items -->
				<div class="space-y-8">
					<!-- Header -->
					<div class="flex items-baseline justify-between border-b border-base-300/50 pb-6">
						<div>
							<h1 class="text-3xl font-semibold text-neutral mb-1">Warenkorb</h1>
							<p class="text-sm text-neutral/60">{cartItems.length} {cartItems.length === 1 ? 'Artikel' : 'Artikel'}</p>
						</div>
						<a href="/products" class="text-sm text-primary hover:text-primary-focus transition-colors">
							Weiter einkaufen
						</a>
					</div>

					<!-- Address Warning Banner -->
					{!hasAddresses && (
						<div class="alert alert-warning shadow-lg">
							<svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
							</svg>
							<div>
								<h3 class="font-bold">Keine Lieferadresse hinterlegt</h3>
								<div class="text-sm">Bitte fügen Sie eine Lieferadresse hinzu, um Ihre Bestellung abzuschließen.</div>
							</div>
							<div class="flex-none">
								<a href="/auth/account" class="btn btn-sm btn-warning">Adresse hinzufügen</a>
							</div>
						</div>
					)}

					<!-- Main Grid -->
					<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
						<!-- Cart Items -->
						<div class="lg:col-span-2 space-y-4">
							<div id="cart-items-list" class="space-y-3">
								{cartItems.map((item) => (
									<div class="bg-base-100 border border-base-300/50 rounded-lg hover:border-base-300 transition-all" data-cart-item-id={item.id}>
										<div class="p-4">
											<div class="flex gap-4">
												<!-- Image -->
												<div class="flex-shrink-0">
													<div class="w-20 h-20 bg-base-200 rounded-md overflow-hidden">
														{item.productImage ? (
															<img src={item.productImage} alt={item.productName} class="w-full h-full object-cover" />
														) : (
															<div class="w-full h-full flex items-center justify-center text-neutral/20">
																<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
																	<path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
																</svg>
															</div>
														)}
													</div>
												</div>

												<!-- Info -->
												<div class="flex-1 min-w-0">
													<a href={`/product/${item.productSlug}`} class="text-base font-medium text-neutral line-clamp-2 mb-2 block">
														{item.productName}
													</a>

													<div class="flex items-center gap-2 mb-3">
														<span class="text-sm text-neutral/50">Stückpreis:</span>
														<span class="text-base font-semibold text-neutral cart-item-unit-price" data-cart-item-id={item.id}>
															{formatPrice(item.unitPrice)}
														</span>
													</div>

													{item.currentSavings > 0 && (
														<div class="inline-flex items-center gap-1.5 text-xs text-success bg-success/10 px-2 py-1 rounded">
															<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
																<path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
															</svg>
															Sie sparen {formatPrice(item.currentSavings)}
														</div>
													)}

													<!-- Zusatzleistungen -->
													{item.zusatzleistungen && item.zusatzleistungen.length > 0 && (
														<div class="mt-3 pt-3 border-t border-base-200">
															<div class="text-xs font-medium text-neutral/50 mb-2">Zusatzleistungen:</div>
															<div class="space-y-1">
																{item.zusatzleistungen.map((service: any) => (
																	<div class="flex items-center justify-between text-xs">
																		<span class="text-neutral/70">{service.name}</span>
																		<span class="font-medium text-neutral">+{formatPrice(service.price)}</span>
																	</div>
																))}
															</div>
														</div>
													)}

													<!-- Quantity -->
													<div class="flex items-center gap-3 mt-3">
														<span class="text-xs text-neutral/50">Menge:</span>
														<div class="flex items-center gap-2 bg-base-200 rounded-md">
															<button
																class="quantity-decrease w-8 h-8 flex items-center justify-center hover:bg-base-300 rounded-l-md transition-colors"
																data-cart-item-id={item.id}
																aria-label="Menge verringern"
															>
																<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-neutral" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
																	<path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4" />
																</svg>
															</button>
															<span class="cart-item-quantity text-sm font-medium text-neutral px-3">{item.quantity}</span>
															<button
																class="quantity-increase w-8 h-8 flex items-center justify-center hover:bg-base-300 rounded-r-md transition-colors"
																data-cart-item-id={item.id}
																aria-label="Menge erhöhen"
															>
																<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-neutral" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
																	<path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
																</svg>
															</button>
														</div>
													</div>
												</div>

												<!-- Price & Remove -->
												<div class="flex flex-col items-end justify-between text-right">
													<div class="text-lg font-semibold text-neutral cart-item-total">
														{formatPrice(item.totalWithServices || (item.unitPrice * item.quantity))}
													</div>
													<button
														class="remove-item text-xs text-error/70 hover:text-error transition-colors mt-2"
														data-cart-item-id={item.id}
														aria-label="Entfernen"
													>
														Entfernen
													</button>
												</div>
											</div>
										</div>
									</div>
								))}
							</div>
						</div>

						<!-- Summary Sidebar -->
						<div class="lg:col-span-1">
							<div class="sticky top-24">
								<div class="bg-base-100 border border-base-300/50 rounded-lg p-6">
									<h2 class="text-lg font-semibold text-neutral mb-5">Zusammenfassung</h2>

									<div class="space-y-5">
										<!-- Order Summary Section -->
										<div class="space-y-3">
											<div class="text-xs font-medium text-neutral/50 uppercase tracking-wide mb-2">Bestellübersicht</div>
											<!-- Subtotal -->
											<div class="flex justify-between text-sm">
												<span class="text-neutral/60">Zwischensumme</span>
												<span class="font-medium text-neutral" id="cart-subtotal">{formatPrice(subtotal)}</span>
											</div>

											{totalSavings > 0 && (
												<div class="flex justify-between items-center text-sm bg-success/5 -mx-6 px-6 py-3 rounded">
													<span class="text-success font-medium">Sie sparen</span>
													<span class="text-success font-semibold" id="total-savings">{formatPrice(totalSavings)}</span>
												</div>
											)}

											{userDiscountPercent > 0 && (
												<div class="flex justify-between items-center text-sm bg-primary/5 -mx-6 px-6 py-3 rounded">
													<div class="flex items-center gap-2">
														<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
															<path stroke-linecap="round" stroke-linejoin="round" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
														</svg>
														<span class="text-primary font-medium">Ihr Rabatt ({userDiscountPercent}%)</span>
													</div>
													<span class="text-primary font-semibold">-{formatPrice(subtotal * (userDiscountPercent / 100))}</span>
												</div>
											)}
										</div>

										<!-- Shipping Section -->
										<div class="space-y-3 pt-3 border-t border-base-300/30">
											<div class="text-xs font-medium text-neutral/50 uppercase tracking-wide mb-2">Versand</div>
											<!-- Shipping Method Selector -->
											<div id="shipping-profiles-container" class="space-y-1">
												<!-- Shipping profiles will be loaded here -->
											</div>

											<!-- Shipping Cost -->
											<div class="flex justify-between text-sm pt-2">
												<span class="text-neutral/60">Versandkosten</span>
												<span class="font-medium text-neutral" id="shipping-cost">-</span>
											</div>
										</div>

										<!-- Total Section -->
										<div class="border-t border-base-300/30 pt-4 mt-4">
											<div class="flex justify-between items-baseline">
												<span class="text-base font-semibold text-neutral">Gesamt</span>
												<span class="text-2xl font-semibold text-neutral" id="cart-total">{formatPrice(subtotal)}</span>
											</div>
										</div>
									</div>

									<!-- Checkout Button -->
									<a href="/checkout" class="btn btn-primary w-full mt-6">
										Zur Kasse
									</a>

									<!-- PayPal Logo -->
									<div class="flex justify-center py-4">
										<a
											href="https://ad.doubleclick.net/ddm/trackclk/N426203.3410571DEPAYPALLOGOCENTE/B21619412.227908863;dc_trk_aid=425874235;dc_trk_cid=105266791;dc_lat=;dc_rdid=;tag_for_child_directed_treatment=;tfua="
											title="So funktioniert PayPal"
											target="_blank"
											rel="noopener noreferrer"
											onclick="javascript:window.open('https://ad.doubleclick.net/ddm/trackclk/N426203.3410571DEPAYPALLOGOCENTE/B21619412.227908863;dc_trk_aid=425874235;dc_trk_cid=105266791;dc_lat=;dc_rdid=;tag_for_child_directed_treatment=;tfua=','WIPaypal','toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=yes, resizable=yes, width=715, height=539'); return false;"
										>
											<img
												src="https://www.paypalobjects.com/webstatic/de_DE/i/de-pp-logo-200px.png"
												width="200"
												height="60"
												alt="PayPal Logo"
												class="h-10 w-auto object-contain"
											/>
										</a>
									</div>
									<!-- PayPal Logo -->

									<!-- Trust Signals -->
									<div class="mt-6 pt-6 border-t border-base-300/50 space-y-3">
										<div class="flex items-start gap-2">
											<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-success flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
												<path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
											</svg>
											<div>
												<div class="text-xs font-medium text-neutral">Sichere Zahlung</div>
												<div class="text-xs text-neutral/50">SSL-verschlüsselt</div>
											</div>
										</div>
										<div class="flex items-start gap-2">
											<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-primary flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
												<path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
											</svg>
											<div>
												<div class="text-xs font-medium text-neutral">Schnelle Lieferung</div>
												<div class="text-xs text-neutral/50">2-3 Werktage</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			)}
		</div>
	</div>
</Layout>

<style>
	/* Clean transitions with highlight effect */
	.cart-item-total,
	.cart-item-unit-price,
	.cart-item-quantity {
		transition: all 0.2s ease;
	}

	/* Highlight animation for updated values */
	@keyframes highlightUpdate {
		0% {
			background-color: rgba(var(--color-success-rgb, 34, 197, 94), 0.2);
		}
		100% {
			background-color: transparent;
		}
	}

	.cart-item-total.updating,
	.cart-item-quantity.updating,
	#cart-subtotal.updating,
	#cart-total.updating {
		animation: highlightUpdate 0.6s ease-out;
		border-radius: 0.25rem;
		padding: 0.125rem 0.25rem;
	}

	/* Radio buttons in light green accent */
	.radio:checked:not(.radio-success):not(.radio-warning):not(.radio-error):not(.radio-info) {
		border-color: var(--color-accent) !important;
		background-color: var(--color-accent) !important;
	}

	.radio:checked:not(.radio-success):not(.radio-warning):not(.radio-error):not(.radio-info)::before {
		background-color: white !important;
	}

	.radio:checked:not(.radio-success):not(.radio-warning):not(.radio-error):not(.radio-info):hover {
		border-color: var(--color-accent-dark) !important;
		background-color: var(--color-accent-dark) !important;
	}

	.radio-primary:checked {
		border-color: var(--color-accent) !important;
		background-color: var(--color-accent) !important;
	}

	.radio-primary:checked::before {
		background-color: white !important;
	}

	.radio-primary:checked:hover {
		border-color: var(--color-accent-dark) !important;
		background-color: var(--color-accent-dark) !important;
	}

	.radio:focus,
	.radio-primary:focus {
		outline-color: var(--color-accent) !important;
	}

	/* Shipping profile radio buttons - dark gray fill with green click animation */
	#shipping-profiles-container .radio:checked,
	#shipping-profiles-container .radio-primary:checked {
		border-color: var(--color-secondary) !important;
		background-color: var(--color-secondary) !important;
		transition: border-color 0.3s ease, background-color 0.3s ease;
	}

	#shipping-profiles-container .radio:checked::before,
	#shipping-profiles-container .radio-primary:checked::before {
		background-color: var(--color-secondary) !important;
		transition: background-color 0.3s ease;
	}

	#shipping-profiles-container .radio:checked:hover,
	#shipping-profiles-container .radio-primary:checked:hover {
		border-color: var(--color-secondary-dark) !important;
		background-color: var(--color-secondary-dark) !important;
	}

	#shipping-profiles-container .radio:checked:hover::before,
	#shipping-profiles-container .radio-primary:checked:hover::before {
		background-color: var(--color-secondary-dark) !important;
	}

	/* Green animation on click/active state */
	#shipping-profiles-container .radio:active,
	#shipping-profiles-container .radio-primary:active {
		border-color: var(--color-accent) !important;
		background-color: var(--color-accent) !important;
		transition: border-color 0.15s ease, background-color 0.15s ease;
	}

	#shipping-profiles-container .radio:active::before,
	#shipping-profiles-container .radio-primary:active::before {
		background-color: white !important;
		transition: background-color 0.15s ease;
	}

	/* Smooth transition from green to dark gray after click */
	#shipping-profiles-container .radio {
		transition: border-color 0.3s ease, background-color 0.3s ease;
	}

	#shipping-profiles-container .radio::before {
		transition: background-color 0.3s ease;
	}
</style>

<script define:vars={{ subtotal: subtotal, userDiscountPercent: userDiscountPercent }}>
	const formatPrice = (price) => {
		return new Intl.NumberFormat('de-DE', {
			style: 'currency',
			currency: 'EUR'
		}).format(price);
	};

	const escapeHtml = (text) => {
		const div = document.createElement('div');
		div.textContent = text;
		return div.innerHTML;
	};

	const renderCartItem = (item) => {
		const savingsHtml = item.currentSavings > 0
			? `<div class="inline-flex items-center gap-1.5 text-xs text-success bg-success/10 px-2 py-1 rounded">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
							<path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
						</svg>
						Sie sparen ${formatPrice(item.currentSavings)}
					</div>`
			: '';

		const imageHtml = item.productImage
			? `<img src="${escapeHtml(item.productImage)}" alt="${escapeHtml(item.productName)}" class="w-full h-full object-cover" />`
			: `<div class="w-full h-full flex items-center justify-center text-neutral/20">
						<svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
							<path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
						</svg>
					</div>`;

		// Calculate line total properly
		const lineTotal = item.totalWithServices || (item.unitPrice * item.quantity);

		return `
			<div class="bg-base-100 border border-base-300/50 rounded-lg hover:border-base-300 transition-all" data-cart-item-id="${escapeHtml(item.id)}">
				<div class="p-4">
					<div class="flex gap-4">
						<!-- Image -->
						<div class="flex-shrink-0">
							<div class="w-20 h-20 bg-base-200 rounded-md overflow-hidden">
								${imageHtml}
							</div>
						</div>

						<!-- Info -->
						<div class="flex-1 min-w-0">
							<a href="/product/${escapeHtml(item.productSlug)}" class="text-base font-medium text-neutral line-clamp-2 mb-2 block">
								${escapeHtml(item.productName)}
							</a>

							<div class="flex items-center gap-2 mb-3">
								<span class="text-sm text-neutral/50">Stückpreis:</span>
								<span class="text-base font-semibold text-neutral cart-item-unit-price" data-cart-item-id="${escapeHtml(item.id)}">
									${formatPrice(item.unitPrice)}
								</span>
							</div>

							${savingsHtml}

							<!-- Quantity -->
							<div class="flex items-center gap-3 mt-3">
								<span class="text-xs text-neutral/50">Menge:</span>
								<div class="flex items-center gap-2 bg-base-200 rounded-md">
									<button
										class="quantity-decrease w-8 h-8 flex items-center justify-center hover:bg-base-300 rounded-l-md transition-colors"
										data-cart-item-id="${escapeHtml(item.id)}"
										aria-label="Menge verringern"
									>
										<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-neutral" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
											<path stroke-linecap="round" stroke-linejoin="round" d="M20 12H4" />
										</svg>
									</button>
									<span class="cart-item-quantity text-sm font-medium text-neutral px-3">${item.quantity}</span>
									<button
										class="quantity-increase w-8 h-8 flex items-center justify-center hover:bg-base-300 rounded-r-md transition-colors"
										data-cart-item-id="${escapeHtml(item.id)}"
										aria-label="Menge erhöhen"
									>
										<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-neutral" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
											<path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
										</svg>
									</button>
								</div>
							</div>
						</div>

						<!-- Price & Remove -->
						<div class="flex flex-col items-end justify-between text-right">
							<div class="text-lg font-semibold text-neutral cart-item-total">
								${formatPrice(lineTotal)}
							</div>
							<button
								class="remove-item text-xs text-error/70 hover:text-error transition-colors mt-2"
								data-cart-item-id="${escapeHtml(item.id)}"
								aria-label="Entfernen"
							>
								Entfernen
							</button>
						</div>
					</div>
				</div>
			</div>
		`;
	};

	const renderCartItems = (items) => {
		const container = document.getElementById('cart-items-list');
		if (!container) return;

		if (items.length === 0) {
			window.location.reload();
			return;
		}

		container.innerHTML = items.map(item => renderCartItem(item)).join('');
		attachCartItemListeners();
	};

	const attachCartItemListeners = () => {
		document.querySelectorAll('.quantity-decrease').forEach((button) => {
			button.addEventListener('click', async (e) => {
				e.preventDefault();
				const buttonElement = e.currentTarget as HTMLElement;
				const cartItemId = buttonElement.getAttribute('data-cart-item-id');
				if (!cartItemId) return;

				const quantityElement = document.querySelector(`[data-cart-item-id="${cartItemId}"] .cart-item-quantity`);
				const currentQuantity = parseInt(quantityElement?.textContent || '1');

				if (currentQuantity > 1) {
					// Disable buttons during update
					const cartItemElement = document.querySelector(`[data-cart-item-id="${cartItemId}"]`);
					const buttons = cartItemElement?.querySelectorAll('button');
					buttons?.forEach(btn => (btn as HTMLButtonElement).disabled = true);

					await updateCartItemQuantity(cartItemId, currentQuantity - 1);

					// Re-enable buttons after update
					buttons?.forEach(btn => (btn as HTMLButtonElement).disabled = false);
				}
			});
		});

		document.querySelectorAll('.quantity-increase').forEach((button) => {
			button.addEventListener('click', async (e) => {
				e.preventDefault();
				const buttonElement = e.currentTarget as HTMLElement;
				const cartItemId = buttonElement.getAttribute('data-cart-item-id');
				if (!cartItemId) return;

				const quantityElement = document.querySelector(`[data-cart-item-id="${cartItemId}"] .cart-item-quantity`);
				const currentQuantity = parseInt(quantityElement?.textContent || '1');

				// Disable buttons during update
				const cartItemElement = document.querySelector(`[data-cart-item-id="${cartItemId}"]`);
				const buttons = cartItemElement?.querySelectorAll('button');
				buttons?.forEach(btn => (btn as HTMLButtonElement).disabled = true);

				await updateCartItemQuantity(cartItemId, currentQuantity + 1);

				// Re-enable buttons after update
				buttons?.forEach(btn => (btn as HTMLButtonElement).disabled = false);
			});
		});

		document.querySelectorAll('.remove-item').forEach((button) => {
			button.addEventListener('click', (e) => {
				e.preventDefault();
				e.stopPropagation();
				const cartItemId = (e.currentTarget as HTMLElement).getAttribute('data-cart-item-id');
				if (!cartItemId) return;

				removeCartItem(cartItemId);
			});
		});
	};

	const updateCartUI = async () => {
		try {
			const response = await fetch('/api/cart/get');
			const result = await response.json();

			if (result.success) {
				const { items, subtotal: newSubtotal } = result.data;

				renderCartItems(items);

				const cartSubtotal = document.getElementById('cart-subtotal');
				if (cartSubtotal) {
					cartSubtotal.textContent = formatPrice(newSubtotal);
				}

				// Update current subtotal for shipping calculation
				currentSubtotal = newSubtotal;

				const totalSavings = items.reduce((sum, item) => sum + (item.currentSavings || 0), 0);
				const totalSavingsElement = document.getElementById('total-savings');
				if (totalSavingsElement) {
					totalSavingsElement.textContent = formatPrice(totalSavings);
				}

				// Recalculate total with updated subtotal
				updateTotal();

				window.dispatchEvent(new CustomEvent('cartUpdated', { detail: { count: items.length, items, subtotal: newSubtotal } }));
			}
		} catch (error) {
			console.error('Error updating cart UI:', error);
		}
	};

	const updateCartItemQuantity = async (cartItemId, newQuantity) => {
		// Optimistic UI update - update quantity and totals immediately
		const cartItemElement = document.querySelector(`[data-cart-item-id="${cartItemId}"]`);
		const quantityElement = cartItemElement?.querySelector('.cart-item-quantity');
		const lineTotalElement = cartItemElement?.querySelector('.cart-item-total');
		const oldQuantity = quantityElement ? parseInt(quantityElement.textContent || '1') : newQuantity;

		// Get unit price from the item
		const unitPriceElement = cartItemElement?.querySelector('.cart-item-unit-price');
		const unitPriceText = unitPriceElement?.textContent || '0';
		const unitPrice = parseFloat(unitPriceText.replace(/[^0-9,]/g, '').replace(',', '.')) || 0;

		// Calculate new line total
		const newLineTotal = unitPrice * newQuantity;
		const oldLineTotal = unitPrice * oldQuantity;

		// Apply optimistic updates with visual feedback
		if (quantityElement) {
			quantityElement.textContent = newQuantity.toString();
			quantityElement.classList.add('updating');
			setTimeout(() => quantityElement.classList.remove('updating'), 600);
		}
		if (lineTotalElement) {
			lineTotalElement.textContent = formatPrice(newLineTotal);
			lineTotalElement.classList.add('updating');
			setTimeout(() => lineTotalElement.classList.remove('updating'), 600);
		}

		// Update subtotal optimistically
		const cartSubtotalElement = document.getElementById('cart-subtotal');
		const cartTotalElement = document.getElementById('cart-total');
		if (cartSubtotalElement) {
			const currentSubtotalText = cartSubtotalElement.textContent || '0';
			const currentSubtotalValue = parseFloat(currentSubtotalText.replace(/[^0-9,]/g, '').replace(',', '.')) || 0;
			const newSubtotalValue = currentSubtotalValue - oldLineTotal + newLineTotal;
			cartSubtotalElement.textContent = formatPrice(newSubtotalValue);
			cartSubtotalElement.classList.add('updating');
			setTimeout(() => cartSubtotalElement.classList.remove('updating'), 600);

			// Update current subtotal for shipping calculation
			currentSubtotal = newSubtotalValue;
		}

		// Update total with shipping
		updateTotal();

		// Highlight total as well
		if (cartTotalElement) {
			cartTotalElement.classList.add('updating');
			setTimeout(() => cartTotalElement.classList.remove('updating'), 600);
		}

		try {
			const response = await fetch('/api/cart/update', {
				method: 'PUT',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ cartItemId, quantity: newQuantity }),
			});

			const result = await response.json();

			if (result.success) {
				// Update the full cart UI with the actual data from the server
				await updateCartUI();
			} else {
				// Revert the optimistic updates on error
				if (quantityElement) {
					quantityElement.textContent = oldQuantity.toString();
				}
				if (lineTotalElement) {
					lineTotalElement.textContent = formatPrice(oldLineTotal);
				}
				if (cartSubtotalElement) {
					const currentSubtotalText = cartSubtotalElement.textContent || '0';
					const currentSubtotalValue = parseFloat(currentSubtotalText.replace(/[^0-9,]/g, '').replace(',', '.')) || 0;
					const revertedSubtotal = currentSubtotalValue - newLineTotal + oldLineTotal;
					cartSubtotalElement.textContent = formatPrice(revertedSubtotal);
					currentSubtotal = revertedSubtotal;
				}
				updateTotal();
				alert(result.error?.message || 'Fehler beim Aktualisieren des Warenkorbs');
			}
		} catch (error) {
			// Revert the optimistic updates on error
			if (quantityElement) {
				quantityElement.textContent = oldQuantity.toString();
			}
			if (lineTotalElement) {
				lineTotalElement.textContent = formatPrice(oldLineTotal);
			}
			if (cartSubtotalElement) {
				const currentSubtotalText = cartSubtotalElement.textContent || '0';
				const currentSubtotalValue = parseFloat(currentSubtotalText.replace(/[^0-9,]/g, '').replace(',', '.')) || 0;
				const revertedSubtotal = currentSubtotalValue - newLineTotal + oldLineTotal;
				cartSubtotalElement.textContent = formatPrice(revertedSubtotal);
				currentSubtotal = revertedSubtotal;
			}
			updateTotal();
			console.error('Error updating cart item:', error);
			alert('Fehler beim Aktualisieren des Warenkorbs');
		}
	};

	const removeCartItem = async (cartItemId) => {
		try {
			const response = await fetch('/api/cart/remove', {
				method: 'DELETE',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ cartItemId }),
			});

			const result = await response.json();

			if (result.success) {
				await updateCartUI();
			} else {
				alert(result.error?.message || 'Fehler beim Entfernen des Artikels');
			}
		} catch (error) {
			console.error('Error removing cart item:', error);
			alert('Fehler beim Entfernen des Artikels');
		}
	};

	// Shipping profile management
	let currentShippingProfile = null;
	let currentSubtotal = subtotal; // Use the subtotal passed from the server

	const calculateShippingCost = (profile, currentSubtotalValue) => {
		if (!profile) return 0;

		// Apply user discount before checking free shipping threshold
		const userDiscount = currentSubtotalValue * (userDiscountPercent / 100);
		const subtotalAfterDiscount = currentSubtotalValue - userDiscount;

		if (profile.freeShippingThreshold && subtotalAfterDiscount >= profile.freeShippingThreshold) {
			return 0;
		}
		return profile.basePrice;
	};

	const updateTotal = () => {
		const shippingCost = currentShippingProfile ? calculateShippingCost(currentShippingProfile, currentSubtotal) : 0;
		const total = currentSubtotal + shippingCost;

		const shippingCostEl = document.getElementById('shipping-cost');
		const totalEl = document.getElementById('cart-total');

		if (shippingCostEl) {
			if (shippingCost === 0 && currentShippingProfile?.freeShippingThreshold) {
				shippingCostEl.innerHTML = `<span class="text-success font-semibold">Kostenlos</span>`;
			} else {
				shippingCostEl.textContent = formatPrice(shippingCost);
			}
		}

		if (totalEl) {
			totalEl.textContent = formatPrice(total);
		}
	};

	const loadShippingProfiles = async () => {
		try {
			// Fetch all active shipping profiles
			const profilesResponse = await fetch('/api/shipping/active');
			const profilesResult = await profilesResponse.json();

			if (!profilesResult.success) {
				console.error('Failed to fetch shipping profiles');
				return;
			}

			const profiles = profilesResult.data;

			// Fetch user's selected profile
			const selectedResponse = await fetch('/api/cart/shipping/select');
			const selectedResult = await selectedResponse.json();

			let selectedProfileId = null;
			if (selectedResult.success && selectedResult.data) {
				selectedProfileId = selectedResult.data.id;
				currentShippingProfile = selectedResult.data;
			} else if (profiles.length > 0) {
				// Use first profile as default
				currentShippingProfile = profiles[0];
				selectedProfileId = profiles[0].id;
			}

			// Render shipping profiles
			const container = document.getElementById('shipping-profiles-container');
			if (!container) return;

			container.innerHTML = profiles.map((profile) => {
				const isSelected = profile.id === selectedProfileId;
				const shippingCost = calculateShippingCost(profile, currentSubtotal);
				const isFree = shippingCost === 0 && profile.freeShippingThreshold;

				return `
					<label class="flex items-center justify-between py-2.5 px-3 -mx-3 rounded-md cursor-pointer hover:bg-base-200/50 transition-colors ${isSelected ? 'bg-base-200/30' : ''}">
						<div class="flex items-center gap-3 flex-1 min-w-0">
							<input
								type="radio"
								name="shipping-profile"
								value="${profile.id}"
								class="radio radio-xs shipping-profile-radio"
								${isSelected ? 'checked' : ''}
								data-profile-id="${profile.id}"
							/>
							<div class="flex-1 min-w-0">
								<div class="flex items-baseline gap-2">
									<span class="text-sm font-medium text-neutral">${escapeHtml(profile.name)}</span>
									${profile.estimatedDays ? `<span class="text-xs text-neutral/50">${profile.estimatedDays} ${profile.estimatedDays === 1 ? 'Tag' : 'Tage'}</span>` : ''}
								</div>
								${profile.freeShippingThreshold && currentSubtotal < profile.freeShippingThreshold
									? `<p class="text-xs text-neutral/50 mt-0.5">Kostenlos ab ${formatPrice(profile.freeShippingThreshold)}</p>`
									: ''
								}
							</div>
						</div>
						<span class="text-sm font-medium ${isFree ? 'text-success' : 'text-neutral'} ml-3">
							${isFree ? 'Kostenlos' : formatPrice(profile.basePrice)}
						</span>
					</label>
				`;
			}).join('');

			// Attach event listeners to shipping profile radio buttons
			attachShippingProfileListeners();

			// Update total with shipping
			updateTotal();
		} catch (error) {
			console.error('Error loading shipping profiles:', error);
		}
	};

	const attachShippingProfileListeners = () => {
		document.querySelectorAll('.shipping-profile-radio').forEach((radio) => {
			radio.addEventListener('change', async (e) => {
				const profileId = (e.target as HTMLInputElement).getAttribute('data-profile-id');
				if (!profileId) return;

				try {
					const response = await fetch('/api/cart/shipping/select', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ shippingProfileId: profileId }),
					});

					const result = await response.json();

					if (result.success) {
						// Fetch the selected profile details
						const profilesResponse = await fetch('/api/shipping/active');
						const profilesResult = await profilesResponse.json();

						if (profilesResult.success) {
							currentShippingProfile = profilesResult.data.find((p) => p.id === profileId);
							updateTotal();
						}
					} else {
						alert(result.error?.message || 'Fehler beim Auswählen der Versandart');
					}
				} catch (error) {
					console.error('Error selecting shipping profile:', error);
					alert('Fehler beim Auswählen der Versandart');
				}
			});
		});
	};

	document.addEventListener('DOMContentLoaded', () => {
		attachCartItemListeners();

		const loginPromptBtn = document.getElementById('login-prompt-btn');
		if (loginPromptBtn) {
			loginPromptBtn.addEventListener('click', () => {
				window.openAuthModal('login');
			});
		}

		// Load shipping profiles if cart has items
		if (currentSubtotal > 0) {
			loadShippingProfiles();
		}

		// Listen for cart item added event from other pages
		window.addEventListener('cartItemAdded', async () => {
			await updateCartUI();
		});
	});
</script>
