---
import Layout from '../../layouts/Layout.astro';
import Navbar from '../../components/Navbar.astro';
import ProductGallery from '../../components/product/ProductGallery.astro';
import ProductInfo from '../../components/product/ProductInfo.astro';
import ProductSpecs from '../../components/product/ProductSpecs.astro';
import ProductActions from '../../components/product/ProductActions.astro';
import ProductInquiryForm from '../../components/product/ProductInquiryForm.astro';
import ProductReviews from '../../components/product/ProductReviews.astro';
import { pool } from '@/lib/db';

const { slug } = Astro.params;

// Fetch product from database
const client = await pool.connect();
try {
	const productResult = await client.query(`
		SELECT
			p.*,
			c.name as "categoryName",
			c.slug as "categorySlug"
		FROM products p
		LEFT JOIN categories c ON p."categoryId" = c.id
		WHERE p.slug = $1 AND p."isActive" = true
	`, [slug]);

	if (productResult.rows.length === 0) {
		return Astro.redirect('/404');
	}

	var product = productResult.rows[0];

	// Fetch product images from R2
	var productImages = await client.query(`
		SELECT url, "altText", "isPrimary", "displayOrder"
		FROM "productImages"
		WHERE "productId" = $1
		ORDER BY "isPrimary" DESC, "displayOrder"
	`, [product.id]);

	// Fetch price tiers
	var priceTiers = await client.query(`
		SELECT *
		FROM "priceTiers"
		WHERE "productId" = $1
		ORDER BY "displayOrder"
	`, [product.id]);

	// Fetch related products
	var relatedProductsResult = await client.query(`
		SELECT
			p.id, p.name, p.slug, p."basePrice", p."shortDescription",
			c.name as "categoryName",
			pi.url as "imageUrl"
		FROM products p
		LEFT JOIN categories c ON p."categoryId" = c.id
		LEFT JOIN LATERAL (
			SELECT url FROM "productImages"
			WHERE "productId" = p.id AND "isPrimary" = true
			LIMIT 1
		) pi ON true
		WHERE p."categoryId" = $1
			AND p.slug != $2
			AND p."isActive" = true
		ORDER BY p."isFeatured" DESC, RANDOM()
		LIMIT 3
	`, [product.categoryId, slug]);

	// Fetch custom specifications from database
	var customSpecs = await client.query(`
		SELECT "specKey", "specLabel", "specValue", "displayOrder"
		FROM "productSpecifications"
		WHERE "productId" = $1
		ORDER BY "displayOrder"
	`, [product.id]);

	// Fetch public product files (design files uploaded by customers)
	var productFiles = await client.query(`
		SELECT id, "fileName", "originalFileName", "fileUrl", "fileSize", "mimeType", "displayOrder", "createdAt"
		FROM "productFiles"
		WHERE "productId" = $1 AND "isPublic" = true
		ORDER BY "displayOrder", "createdAt" DESC
	`, [product.id]);

} finally {
	client.release();
}

// Map database data to component props
const images = productImages.rows.map(img => img.url);
const basePrice = parseFloat(product.basePrice);
const inStock = product.trackInventory ? (product.inventoryQuantity > 0) : true;

// Build specifications from custom database specs first
const specifications = [];

// Add custom specifications from productSpecifications table
customSpecs.rows.forEach(spec => {
	specifications.push({
		label: spec.specLabel,
		value: spec.specValue
	});
});

// Add auto-generated specs from product fields (if not already in custom specs)
const customKeys = customSpecs.rows.map(s => s.specKey);

if (product.printTechnology && !customKeys.includes('printTechnology')) {
	specifications.push({ label: 'Drucktechnologie', value: product.printTechnology });
}

if (product.isBlockout && !customKeys.includes('isBlockout')) {
	specifications.push({ label: 'Typ', value: 'Blockout DTF' });
}

if (product.maxWidthMm && !customKeys.includes('maxWidthMm')) {
	specifications.push({ label: 'Maximale Breite', value: `${product.maxWidthMm}mm` });
}

if (product.minHeightMm && product.maxHeightMm && !customKeys.includes('heightRange')) {
	specifications.push({ label: 'Höhenbereich', value: `${product.minHeightMm} - ${product.maxHeightMm}mm` });
}

if (product.acceptsFileUpload && !customKeys.includes('fileUpload')) {
	specifications.push({ label: 'Datei-Upload', value: 'Möglich' });
	specifications.push({ label: 'Erlaubte Formate', value: product.allowedFileTypes || 'PDF' });
	specifications.push({ label: 'Max. Dateigröße', value: `${product.maxFileSizeMb || 255}MB` });
}

if (product.priceCalculationMethod && !customKeys.includes('priceCalculationMethod')) {
	const methodMap = {
		'per_piece': 'Pro Stück',
		'per_meter': 'Pro Laufmeter',
		'per_area': 'Pro m²'
	};
	specifications.push({ label: 'Preisberechnung', value: methodMap[product.priceCalculationMethod] || 'Pro Stück' });
}

if (product.requiresShipping && !customKeys.includes('requiresShipping')) {
	specifications.push({ label: 'Versand', value: 'Erforderlich' });
}

if (product.sku && !customKeys.includes('sku')) {
	specifications.push({ label: 'SKU', value: product.sku });
}

// Add price tiers to description if available
let enrichedDescription = product.description;
if (priceTiers.rows.length > 0) {
	enrichedDescription += '\n\nMengenrabatte verfügbar: Je mehr Sie bestellen, desto günstiger wird der Stückpreis!';
}

const pageTitle = product.metaTitle || `${product.name} - DTF Transfer Print`;
const pageDescription = product.metaDescription || product.shortDescription;

// Map related products
const relatedProducts = relatedProductsResult.rows.map(p => ({
	id: p.id,
	slug: p.slug,
	name: p.name,
	shortDescription: p.shortDescription,
	price: parseFloat(p.basePrice),
	category: p.categoryName || 'DTF Transfer',
	images: p.imageUrl ? [p.imageUrl] : [],
	inStock: true,
	tags: []
}));
---

<Layout title={pageTitle} description={pageDescription}>
	<Navbar />

	<!-- Breadcrumbs -->
	<div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl lg:max-w-7xl-extended pt-8 pb-6">
		<nav class="flex items-center gap-2 text-sm text-neutral/60">
			<a href="/" class="hover:text-primary transition-colors">Startseite</a>
			<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
			</svg>
			<a href="/products" class="hover:text-primary transition-colors">Produkte</a>
			<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
			</svg>
			<span class="text-neutral font-medium">{product.name}</span>
		</nav>
	</div>

	<!-- Main Product Section -->
	<div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl lg:max-w-7xl-extended pb-32">
		<div class="grid grid-cols-1 lg:grid-cols-2 gap-12 lg:gap-20 mb-32">
			<!-- Left Column: Product Gallery -->
			<div class="lg:sticky lg:top-24 lg:self-start">
				<ProductGallery images={images} name={product.name} />

				<!-- Product Badges -->
				{(product.isFeatured || product.isBlockout || product.acceptsFileUpload) && (
					<div class="flex gap-2 flex-wrap mt-6">
						{product.isFeatured && (
							<span class="badge badge-warning gap-2 py-3 px-4">
								<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
									<path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
								</svg>
								Featured
							</span>
						)}
						{product.isBlockout && (
							<span class="badge badge-secondary py-3 px-4">Blockout DTF</span>
						)}
						{product.acceptsFileUpload && (
							<span class="badge badge-info gap-2 py-3 px-4">
								<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
								</svg>
								File Upload
							</span>
						)}
					</div>
				)}
			</div>

			<!-- Right Column: Product Info & Actions -->
			<div class="space-y-5">
				<ProductInfo
					name={product.name}
					shortDescription={product.shortDescription}
					price={basePrice}
					category={product.categoryName || 'DTF Transfer'}
					tags={product.isBlockout ? ['Blockout'] : []}
					inStock={inStock}
				/>

				<!-- Price Tiers Table (if available) - Moved up -->
				{priceTiers.rows.length > 0 && (
					<div class="product-container rounded-xl p-4">
						<div class="mb-3">
							<h3 class="text-base font-bold text-neutral mb-1 flex items-center gap-2">
								<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
								</svg>
								Mehr kaufen, mehr sparen
							</h3>
							<p class="text-xs text-neutral/60">
								Mengenrabatte sind automatisch im Warenkorb verfügbar
							</p>
						</div>
						<div class="overflow-x-auto">
							<table class="table table-xs w-full">
								<thead class="bg-base-100/50">
									<tr>
										<th class="text-neutral font-semibold text-xs py-2">Anzahl</th>
										<th class="text-neutral font-semibold text-xs py-2">Mengenrabatt</th>
										<th class="text-neutral font-semibold text-right text-xs py-2">Preis</th>
									</tr>
								</thead>
								<tbody id="price-tier-tbody">
									{priceTiers.rows.map((tier, index) => (
										<tr 
											class="price-tier-row hover:bg-base-100/30 transition-colors"
											data-min-quantity={tier.minQuantity}
											data-max-quantity={tier.maxQuantity || '999999'}
										>
											<td class="font-medium text-sm py-1.5">
												{tier.minQuantity} - {tier.maxQuantity || '∞'}
											</td>
											<td class="py-1.5">
												{parseFloat(tier.discountPercent) > 0 ? (
													<span class="badge badge-success badge-xs gap-1">
														{parseFloat(tier.discountPercent)}%
													</span>
												) : (
													<span class="text-neutral/40 text-xs">0%</span>
												)}
											</td>
											<td class="text-right py-1.5">
												<span class="font-bold text-success text-sm">
													{parseFloat(tier.pricePerUnit).toFixed(2)} €
												</span>
											</td>
										</tr>
									))}
								</tbody>
							</table>
						</div>
						{priceTiers.rows.length > 0 && parseFloat(priceTiers.rows[priceTiers.rows.length - 1].discountPercent) > 0 && (
							<div class="mt-3 text-center text-xs text-success font-medium">
								Spare bis zu {parseFloat(priceTiers.rows[priceTiers.rows.length - 1].discountPercent)}% bei größeren Mengen!
							</div>
						)}
					</div>
				)}

				<!-- File Upload Section (only for non-inquiry products) -->
			{!product.requiresInquiry && (
				<div class="product-container rounded-xl p-4 space-y-3">
					<h3 class="text-base font-bold text-neutral flex items-center gap-2">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
						</svg>
						Design hochladen
					</h3>
					<p class="text-xs text-neutral/60">
						Laden Sie Ihre Designdatei (PDF oder PNG) für individuelle Anfertigung hoch. Die Datei wird beim Hinzufügen zum Warenkorb gespeichert.
					</p>

					<!-- File Upload Input -->
					<input
						type="file"
						id="designFileUpload"
						accept=".pdf,.png,application/pdf,image/png"
						class="file-input file-input-bordered file-input-primary w-full file-input-sm"
					/>

					<!-- Upload Progress -->
					<div id="upload-progress" class="hidden">
						<div class="alert alert-info py-2">
							<span class="loading loading-spinner loading-xs"></span>
							<span class="text-xs">Datei wird hochgeladen und analysiert...</span>
						</div>
					</div>

					<!-- Upload Error -->
					<div id="upload-error" class="hidden">
						<div class="alert alert-error py-2">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
							</svg>
							<span class="text-xs" id="upload-error-message"></span>
						</div>
					</div>

					<!-- Quality Warnings -->
					<div id="quality-warnings" class="hidden space-y-2">
					</div>

					<!-- File Preview -->
					<div id="file-preview" class="hidden bg-base-100 rounded-lg p-3 border border-base-300">
						<!-- Image Preview (for PNG) -->
						<div id="image-preview-container" class="hidden mb-3">
							<div class="relative aspect-video bg-base-200 rounded-lg overflow-hidden">
								<img id="image-preview" src="" alt="Preview" class="w-full h-full object-contain" />
							</div>
						</div>

						<!-- PDF Preview (for PDF) -->
						<div id="pdf-preview-container" class="hidden mb-3">
							<div class="relative aspect-video bg-base-200 rounded-lg overflow-hidden flex items-center justify-center">
								<canvas id="pdf-canvas" class="max-w-full max-h-full"></canvas>
								<div id="pdf-loading" class="absolute inset-0 flex items-center justify-center bg-base-200/80">
									<span class="loading loading-spinner loading-lg"></span>
								</div>
							</div>
						</div>

						<!-- File Info -->
						<div class="flex items-center gap-3">
							<div class="flex-shrink-0 w-10 h-10 rounded-lg flex items-center justify-center" id="file-icon">
								<!-- Icon will be set by script -->
							</div>
							<div class="flex-1 min-w-0">
								<p class="text-sm font-medium text-neutral truncate" id="file-name">
									Keine Datei hochgeladen
								</p>
								<p class="text-xs text-neutral/60" id="file-info">0 MB</p>
							</div>
							<button
								type="button"
								id="remove-file-btn"
								class="btn btn-ghost btn-xs btn-circle"
								title="Datei entfernen"
							>
								<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
								</svg>
							</button>
						</div>
					</div>

					<p class="text-xs text-neutral/50">
						<strong>PDF oder PNG</strong> • Max: 255MB • Empfohlen: 300 DPI<br/>
						Die Datei wird beim Hinzufügen zum Warenkorb automatisch mit Ihrer Bestellung verknüpft.
					</p>
				</div>

				)}

		{/* Conditional: Show inquiry form or normal cart/checkout actions */}
				{product.requiresInquiry ? (
					<ProductInquiryForm
						productId={product.id}
						productName={product.name}
						productSlug={product.slug}
					/>
				) : (
					<ProductActions
						productId={product.id}
						productName={product.name}
						productSlug={product.slug}
						price={basePrice}
						inStock={inStock}
					/>
				)}

				<!-- Product Files (if public files available) -->
				{productFiles.rows.length > 0 && (
					<div class="product-container rounded-xl p-4">
						<h3 class="text-base font-bold text-neutral mb-3 flex items-center gap-2">
							<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-info" fill="none" viewBox="0 0 24 24" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
							</svg>
							Verfügbare Dateien
						</h3>
						<p class="text-xs text-neutral/60 mb-3">
							Referenzdateien und Downloads für dieses Produkt
						</p>
						<div class="space-y-2">
							{productFiles.rows.map((file) => {
								const fileSize = (file.fileSize / 1024 / 1024).toFixed(2);
								const fileExt = file.originalFileName.split('.').pop().toUpperCase();
								return (
									<a
										href={file.fileUrl}
										target="_blank"
										rel="noopener noreferrer"
										class="flex items-center justify-between p-3 bg-base-100 rounded-lg border border-base-300 hover:border-primary hover:shadow-md transition-all group"
									>
										<div class="flex items-center gap-3 flex-1 min-w-0">
											<div class="flex-shrink-0 w-9 h-9 bg-primary/10 rounded-lg flex items-center justify-center">
												<span class="text-xs font-bold text-primary">{fileExt}</span>
											</div>
											<div class="flex-1 min-w-0">
												<p class="text-sm font-medium text-neutral truncate group-hover:text-primary transition-colors">
													{file.originalFileName}
												</p>
												<p class="text-xs text-neutral/60">{fileSize} MB</p>
											</div>
										</div>
										<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-neutral/40 group-hover:text-primary transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
										</svg>
									</a>
								);
							})}
						</div>
					</div>
				)}

				<!-- Custom Dimensions (if applicable) -->
				
			</div>
		</div>

		<!-- Product Description Section -->
		<section class="mb-32">
			<div class="max-w-4xl">
				<h2 class="text-3xl md:text-4xl font-bold text-neutral mb-8">Über dieses Produkt</h2>
				<div class="text-neutral/70 leading-relaxed text-lg md:text-xl prose max-w-none">
					<div set:html={enrichedDescription.replace(/\n/g, '<br>')} />
				</div>
			</div>
		</section>

		<!-- Product Specifications -->
		{specifications.length > 0 && (
			<section class="mb-32">
				<ProductSpecs specifications={specifications} />
			</section>
		)}

		<!-- Related Products -->
		{relatedProducts.length > 0 && (
			<section>
				<h2 class="text-3xl md:text-4xl font-bold text-neutral mb-12">Ähnliche Produkte</h2>
				<div class="grid grid-cols-1 md:grid-cols-3 gap-8">
					{relatedProducts.map((related) => (
						<a
							href={`/product/${related.slug}`}
							class="group block bg-base-100 rounded-3xl overflow-hidden hover:shadow-2xl transition-all duration-300 border border-base-300/20"
						>
							<figure class="relative overflow-hidden aspect-square bg-base-200/30">
								{related.images.length > 0 ? (
									<img
										src={related.images[0]}
										alt={related.name}
										class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
										loading="lazy"
									/>
								) : (
									<div class="flex items-center justify-center h-full text-neutral/20">
										<svg class="w-24 h-24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
										</svg>
									</div>
								)}
							</figure>
							<div class="p-6 space-y-3">
								<p class="text-sm text-primary font-semibold uppercase tracking-wide">
									{related.category}
								</p>
								<h3 class="text-xl font-bold text-neutral group-hover:text-primary transition-colors">
									{related.name}
								</h3>
								<p class="text-neutral/60 text-sm line-clamp-2">
									{related.shortDescription}
								</p>
								<div class="pt-2">
									<span class="text-2xl font-bold text-neutral">
										{new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(related.price)}
									</span>
									<span class="text-neutral/50 text-sm ml-1">pro Stück</span>
								</div>
							</div>
						</a>
					))}
				</div>
			</section>
		)}
	</div>

	<!-- CTA Section -->
	<section class="bg-gradient-to-br from-primary/5 via-base-100 to-secondary/5 py-24">
		<div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-4xl text-center">
			<h2 class="text-3xl md:text-5xl font-bold text-neutral mb-6">
				Bereit für Ihre Bestellung?
			</h2>
			<p class="text-lg md:text-xl text-neutral/60 mb-12 max-w-2xl mx-auto">
				Kontaktieren Sie uns für ein individuelles Angebot oder starten Sie direkt mit Ihrer Bestellung.
			</p>
			<div class="flex flex-col sm:flex-row gap-4 justify-center">
				<a href="#contact" class="btn btn-primary btn-lg text-lg px-8">
					Angebot anfordern
				</a>
				<a href="/products" class="btn btn-ghost btn-lg text-lg text-neutral px-8">
					Weitere Produkte
				</a>
			</div>
		</div>
	</section>

	<!-- PDF.js Library -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
	<script>
		// Set PDF.js worker
		(window as any).pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
	</script>

	<!-- Design File Upload Script -->
	<script define:vars={{ productId: product.id }}>
		// Track uploaded file info
		let uploadedFileInfo: {
			fileUrl: string;
			fileName: string;
			fileSize: number;
			fileType: string;
			metadata?: any;
		} | null = null;

		const fileInput = document.getElementById('designFileUpload') as HTMLInputElement;
		const uploadProgress = document.getElementById('upload-progress');
		const uploadError = document.getElementById('upload-error');
		const uploadErrorMessage = document.getElementById('upload-error-message');
		const qualityWarnings = document.getElementById('quality-warnings');
		const filePreview = document.getElementById('file-preview');
		const imagePreviewContainer = document.getElementById('image-preview-container');
		const imagePreview = document.getElementById('image-preview') as HTMLImageElement;
		const pdfPreviewContainer = document.getElementById('pdf-preview-container');
		const pdfCanvas = document.getElementById('pdf-canvas') as HTMLCanvasElement;
		const pdfLoading = document.getElementById('pdf-loading');
		const fileIcon = document.getElementById('file-icon');
		const fileName = document.getElementById('file-name');
		const fileInfo = document.getElementById('file-info');
		const removeFileBtn = document.getElementById('remove-file-btn');

		// Handle file selection
		if (fileInput) {
			fileInput.addEventListener('change', async (e) => {
				const target = e.target as HTMLInputElement;
				const file = target.files?.[0];

				if (!file) return;

				// Validate file type (PDF or PNG)
				const fileType = file.type.toLowerCase();
				const fileName = file.name.toLowerCase();
				if (!((fileType === 'application/pdf' || fileName.endsWith('.pdf')) ||
				      (fileType === 'image/png' || fileName.endsWith('.png')))) {
					showError('Nur PDF oder PNG-Dateien sind erlaubt.');
					target.value = '';
					return;
				}

				// Validate file size (255MB max)
				const maxSizeMB = 255;
				const maxSizeBytes = maxSizeMB * 1024 * 1024;
				if (file.size > maxSizeBytes) {
					showError(`Die Datei ist zu groß. Maximal ${maxSizeMB}MB erlaubt.`);
					target.value = '';
					return;
				}

				// Upload file
				await uploadDesignFile(file);
			});
		}

		// Upload design file to R2
		async function uploadDesignFile(file: File) {
			// Hide previous errors and warnings
			if (uploadError) uploadError.classList.add('hidden');
			if (qualityWarnings) {
				qualityWarnings.classList.add('hidden');
				qualityWarnings.innerHTML = '';
			}

			// Show progress
			if (uploadProgress) uploadProgress.classList.remove('hidden');

			try {
				const formData = new FormData();
				formData.append('file', file);
				formData.append('productId', productId);

				const response = await fetch('/api/upload/design-file', {
					method: 'POST',
					body: formData,
				});

				const result = await response.json();

				if (result.success) {
					// Store uploaded file info
					uploadedFileInfo = {
						fileUrl: result.data.fileUrl,
						fileName: result.data.fileName,
						fileSize: result.data.fileSize,
						fileType: result.data.fileType,
						metadata: result.data.metadata,
					};

					// Show preview
					await showPreview(file, result.data);

					// Show quality warnings
					if (result.data.metadata?.warnings && result.data.metadata.warnings.length > 0) {
						showQualityWarnings(result.data.metadata.warnings, result.data.metadata.meetsRequirements);
					}

					// Store in sessionStorage so it persists across page navigations
					sessionStorage.setItem('uploadedDesignFile', JSON.stringify(uploadedFileInfo));
				} else {
					throw new Error(result.error.message);
				}
			} catch (error: any) {
				console.error('Upload error:', error);
				showError(error.message || 'Fehler beim Hochladen der Datei');
				if (fileInput) fileInput.value = '';
			} finally {
				// Hide progress
				if (uploadProgress) uploadProgress.classList.add('hidden');
			}
		}

		// Show preview
		async function showPreview(file: File, data: any) {
			if (!filePreview) return;

			// Show preview container
			filePreview.classList.remove('hidden');

			// Determine file type
			const isImage = data.fileType === 'png';
			const isPdf = data.fileType === 'pdf';

			// Show appropriate preview
			if (isImage) {
				if (imagePreviewContainer && imagePreview) {
					imagePreviewContainer.classList.remove('hidden');
					pdfPreviewContainer?.classList.add('hidden');

					// Load image preview
					const reader = new FileReader();
					reader.onload = (e) => {
						imagePreview.src = e.target?.result as string;
					};
					reader.readAsDataURL(file);

					// Set icon
					if (fileIcon) {
						fileIcon.className = 'flex-shrink-0 w-10 h-10 bg-success/10 rounded-lg flex items-center justify-center';
						fileIcon.innerHTML = `
							<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
							</svg>
						`;
					}
				}
			} else if (isPdf) {
				if (pdfPreviewContainer && pdfCanvas) {
					pdfPreviewContainer.classList.remove('hidden');
					imagePreviewContainer?.classList.add('hidden');

					// Load PDF preview
					const fileReader = new FileReader();
					fileReader.onload = async function(e) {
						const typedarray = new Uint8Array(e.target?.result as ArrayBuffer);

						try {
							const pdf = await (window as any).pdfjsLib.getDocument(typedarray).promise;
							const page = await pdf.getPage(1);

							const viewport = page.getViewport({ scale: 1.5 });
							pdfCanvas.height = viewport.height;
							pdfCanvas.width = viewport.width;

							const renderContext = {
								canvasContext: pdfCanvas.getContext('2d'),
								viewport: viewport
							};

							await page.render(renderContext).promise;
							if (pdfLoading) pdfLoading.classList.add('hidden');
						} catch (error) {
							console.error('Error rendering PDF:', error);
							if (pdfLoading) pdfLoading.classList.add('hidden');
						}
					};
					fileReader.readAsArrayBuffer(file);

					// Set icon
					if (fileIcon) {
						fileIcon.className = 'flex-shrink-0 w-10 h-10 bg-error/10 rounded-lg flex items-center justify-center';
						fileIcon.innerHTML = `
							<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-error" fill="none" viewBox="0 0 24 24" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
							</svg>
						`;
					}
				}
			}

			// Update file info
			if (fileName) fileName.textContent = data.fileName;
			if (fileInfo) {
				const sizeMB = (data.fileSize / 1024 / 1024).toFixed(2);
				let infoText = `${sizeMB} MB`;

				if (data.metadata?.width && data.metadata?.height) {
					infoText += ` • ${data.metadata.width}x${data.metadata.height}px`;
				}
				if (data.metadata?.dpi) {
					infoText += ` • ${data.metadata.dpi} DPI`;
				}

				fileInfo.textContent = infoText;
			}
		}

		// Show quality warnings
		function showQualityWarnings(warnings: string[], meetsRequirements: boolean) {
			if (!qualityWarnings) return;

			qualityWarnings.innerHTML = '';
			qualityWarnings.classList.remove('hidden');

			warnings.forEach((warning) => {
				const isSuccess = warning.startsWith('✓');
				const alertClass = isSuccess ? 'alert-success' : (meetsRequirements ? 'alert-warning' : 'alert-error');

				const alertDiv = document.createElement('div');
				alertDiv.className = `alert ${alertClass} py-2`;
				alertDiv.innerHTML = `
					<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
						${isSuccess
							? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />'
							: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />'
						}
					</svg>
					<span class="text-xs">${warning}</span>
				`;
				qualityWarnings.appendChild(alertDiv);
			});
		}

		// Show error
		function showError(message: string) {
			if (uploadError) uploadError.classList.remove('hidden');
			if (uploadErrorMessage) uploadErrorMessage.textContent = message;

			// Auto-hide after 5 seconds
			setTimeout(() => {
				if (uploadError) uploadError.classList.add('hidden');
			}, 5000);
		}

		// Remove uploaded file
		if (removeFileBtn) {
			removeFileBtn.addEventListener('click', () => {
				// Clear uploaded file info
				uploadedFileInfo = null;
				sessionStorage.removeItem('uploadedDesignFile');

				// Hide preview and warnings
				if (filePreview) filePreview.classList.add('hidden');
				if (qualityWarnings) {
					qualityWarnings.classList.add('hidden');
					qualityWarnings.innerHTML = '';
				}

				// Clear file input
				if (fileInput) fileInput.value = '';
			});
		}

		// Restore uploaded file from sessionStorage on page load
		document.addEventListener('DOMContentLoaded', () => {
			const storedFile = sessionStorage.getItem('uploadedDesignFile');
			if (storedFile) {
				try {
					uploadedFileInfo = JSON.parse(storedFile);
					if (uploadedFileInfo) {
						// Can't fully restore preview without original file, but show info
						if (filePreview && fileName && fileInfo) {
							filePreview.classList.remove('hidden');
							fileName.textContent = uploadedFileInfo.fileName;
							const sizeMB = (uploadedFileInfo.fileSize / 1024 / 1024).toFixed(2);
							fileInfo.textContent = `${sizeMB} MB`;

							// Set appropriate icon
							if (fileIcon) {
								if (uploadedFileInfo.fileType === 'png') {
									fileIcon.className = 'flex-shrink-0 w-10 h-10 bg-success/10 rounded-lg flex items-center justify-center';
									fileIcon.innerHTML = `
										<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
										</svg>
									`;
								} else {
									fileIcon.className = 'flex-shrink-0 w-10 h-10 bg-error/10 rounded-lg flex items-center justify-center';
									fileIcon.innerHTML = `
										<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-error" fill="none" viewBox="0 0 24 24" stroke="currentColor">
											<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
										</svg>
									`;
								}
							}
						}
					}
				} catch (error) {
					console.error('Error restoring uploaded file:', error);
					sessionStorage.removeItem('uploadedDesignFile');
				}
			}
		});

		// Make uploadedFileInfo available to ProductActions component
		(window as any).getUploadedFileInfo = () => uploadedFileInfo;

		// Listen for cart add event to clear the upload UI
		window.addEventListener('designFileAddedToCart', () => {
			uploadedFileInfo = null;
			if (filePreview) filePreview.classList.add('hidden');
			if (qualityWarnings) {
				qualityWarnings.classList.add('hidden');
				qualityWarnings.innerHTML = '';
			}
			if (fileInput) fileInput.value = '';
		});
	</script>
</Layout>
