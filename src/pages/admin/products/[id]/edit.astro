---
import AdminLayout from '@/layouts/AdminLayout.astro';
import { pool } from '@/lib/db';
import ProductImageUpload from '@/components/ProductImageUpload.astro';
import ProductFileUpload from '@/components/ProductFileUpload.astro';

// Note: Admin check is handled by middleware.ts
const { id } = Astro.params;

// Fetch product
const client = await pool.connect();
try {
  var productResult = await client.query('SELECT * FROM products WHERE id = $1', [id]);

  if (productResult.rows.length === 0) {
    return Astro.redirect('/admin/products');
  }

  var product = productResult.rows[0];

  // Fetch categories for dropdown
  var categories = await client.query(`
    SELECT * FROM categories
    WHERE "isActive" = true
    ORDER BY "displayOrder"
  `);

  // Fetch price tiers
  var priceTiers = await client.query(`
    SELECT * FROM "priceTiers"
    WHERE "productId" = $1
    ORDER BY "displayOrder"
  `, [id]);

  // Fetch product images
  var productImages = await client.query(`
    SELECT id, url, "altText", "isPrimary", "displayOrder"
    FROM "productImages"
    WHERE "productId" = $1
    ORDER BY "displayOrder"
  `, [id]);

  // Fetch product specifications
  var productSpecs = await client.query(`
    SELECT id, "specKey", "specLabel", "specValue", "displayOrder"
    FROM "productSpecifications"
    WHERE "productId" = $1
    ORDER BY "displayOrder"
  `, [id]);

  // Fetch product files
  var productFiles = await client.query(`
    SELECT id, "fileName", "originalFileName", "fileUrl", "fileSize", "mimeType", "isPublic", "displayOrder", "createdAt"
    FROM "productFiles"
    WHERE "productId" = $1
    ORDER BY "displayOrder", "createdAt" DESC
  `, [id]);
} finally {
  client.release();
}
---

<style>
  /* Modern Tab Radio Buttons */
  .tab-radio-modern {
    @apply cursor-pointer;
  }

  .tab-label-modern {
    @apply px-5 py-3 rounded-xl flex items-center gap-2 font-semibold text-sm
           border-2 border-transparent
           transition-all duration-300 hover:border-base-300
           select-none whitespace-nowrap;
    background-color: rgba(229, 229, 229, 0.5);
    color: rgba(89, 89, 89, 0.7);
  }

  .tab-label-modern:hover {
    background-color: rgba(166, 166, 166, 0.6);
  }

  /* Modern Input Fields with Better Visibility */
  .input-modern {
    @apply input input-bordered w-full border-2
           focus:border-primary focus:bg-base-100 focus:outline-none focus:ring-4
           transition-all duration-200 font-medium text-base;
    background-color: rgba(229, 229, 229, 0.8);
    border-color: rgba(166, 166, 166, 0.5);
  }

  .input-modern::placeholder {
    color: rgba(89, 89, 89, 0.4);
  }

  .input-modern:focus {
    --tw-ring-color: rgba(217, 88, 41, 0.2);
  }

  .textarea-modern {
    @apply textarea textarea-bordered w-full border-2
           focus:border-primary focus:bg-base-100 focus:outline-none focus:ring-4
           transition-all duration-200 font-medium;
    background-color: rgba(229, 229, 229, 0.8);
    border-color: rgba(166, 166, 166, 0.5);
  }

  .textarea-modern::placeholder {
    color: rgba(89, 89, 89, 0.4);
  }

  .textarea-modern:focus {
    --tw-ring-color: rgba(217, 88, 41, 0.2);
  }

  .select-modern {
    @apply select select-bordered w-full border-2
           focus:border-primary focus:bg-base-100 focus:outline-none focus:ring-4
           transition-all duration-200 font-medium;
    background-color: rgba(229, 229, 229, 0.8);
    border-color: rgba(166, 166, 166, 0.5);
  }

  .select-modern:focus {
    --tw-ring-color: rgba(217, 88, 41, 0.2);
  }

  /* Modern Card Design */
  .card-modern {
    @apply bg-base-100 rounded-2xl shadow-md border
           hover:shadow-xl transition-all duration-300 overflow-hidden;
    border-color: rgba(166, 166, 166, 0.3);
  }
</style>

<AdminLayout title={`Edit: ${product.name}`} currentPage="products">
  <!-- Breadcrumbs -->
  <div class="breadcrumbs text-sm mb-4">
    <ul>
      <li><a href="/admin" class="link link-hover">Admin</a></li>
      <li><a href="/admin/products" class="link link-hover">Produkte</a></li>
      <li class="font-semibold">{product.name}</li>
    </ul>
  </div>

  <!-- Page Header with Actions -->
  <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-6">
    <div>
      <div class="flex items-center gap-3 mb-2">
        <h1 class="text-3xl font-bold text-base-content">{product.name}</h1>
        {product.isActive ? (
          <span class="badge badge-success badge-lg gap-2">
            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            Aktiv
          </span>
        ) : (
          <span class="badge badge-ghost badge-lg">Inaktiv</span>
        )}
        {product.isFeatured && (
          <span class="badge badge-primary badge-lg gap-2">
            <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
            </svg>
            Empfohlen
          </span>
        )}
      </div>
      <p class="text-sm text-base-content/70">Aktualisiert: {new Date(product.updatedAt).toLocaleString('de-DE')}</p>
    </div>
    <div class="flex gap-2">
      <a href="/admin/products" class="btn btn-ghost gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Zurück
      </a>
      <a href={`/product/${product.slug}`} target="_blank" class="btn btn-outline btn-primary gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
        </svg>
        Ansehen
      </a>
      <button id="deleteBtn" class="btn btn-error btn-outline gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
        </svg>
        Löschen
      </button>
    </div>
  </div>

  <!-- Stats Overview -->
  <div class="stats stats-vertical lg:stats-horizontal shadow-lg w-full mb-6 border border-base-300/50">
    <div class="stat place-items-center">
      <div class="stat-title">Grundpreis</div>
      <div class="stat-value text-primary">{parseFloat(product.basePrice).toFixed(2)}€</div>
      <div class="stat-desc">{product.priceCalculationMethod === 'per_piece' ? 'Pro Stück' : product.priceCalculationMethod === 'per_meter' ? 'Pro Meter' : 'Pro m²'}</div>
    </div>

    <div class="stat place-items-center">
      <div class="stat-title">Kategorie</div>
      <div class="stat-value text-2xl">{categories.rows.find(cat => cat.id === product.categoryId)?.name || 'N/A'}</div>
      <div class="stat-desc">{product.sku || 'Keine SKU'}</div>
    </div>

    <div class="stat place-items-center">
      <div class="stat-title">Preisstaffeln</div>
      <div class="stat-value text-secondary">{priceTiers.rows.length}</div>
      <div class="stat-desc">Staffeln konfiguriert</div>
    </div>

    <div class="stat place-items-center">
      <div class="stat-title">Bilder</div>
      <div class="stat-value text-accent">{productImages.rows.length}</div>
      <div class="stat-desc">{productImages.rows.filter(img => img.isPrimary).length} Primärbild</div>
    </div>
  </div>

  <!-- Tabbed Interface -->
  <div class="bg-base-100/50 backdrop-blur-sm rounded-3xl shadow-2xl border border-base-300/20 overflow-hidden">
    <!-- Ultra Modern Tab Navigation -->
    <div class="bg-gradient-to-r from-base-200/40 via-base-100/40 to-base-200/40 p-3 border-b border-base-300/20">
      <div role="tablist" class="flex gap-2 flex-wrap">
        <label class="tab-radio-modern">
          <input type="radio" name="product_tabs" value="basic" class="hidden peer" checked />
          <span class="tab-label-modern peer-checked:bg-primary peer-checked:text-primary-content peer-checked:shadow-lg">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/>
            </svg>
            Grundinformationen
          </span>
        </label>
        <label class="tab-radio-modern">
          <input type="radio" name="product_tabs" value="pricing" class="hidden peer" />
          <span class="tab-label-modern peer-checked:bg-secondary peer-checked:text-secondary-content peer-checked:shadow-lg">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path d="M8.433 7.418c.155-.103.346-.196.567-.267v1.698a2.305 2.305 0 01-.567-.267C8.07 8.34 8 8.114 8 8c0-.114.07-.34.433-.582zM11 12.849v-1.698c.22.071.412.164.567.267.364.243.433.468.433.582 0 .114-.07.34-.433.582a2.305 2.305 0 01-.567.267z"/>
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.535 4.535 0 00-1.676.662C6.602 6.234 6 7.009 6 8c0 .99.602 1.765 1.324 2.246.48.32 1.054.545 1.676.662v1.941c-.391-.127-.68-.317-.843-.504a1 1 0 10-1.51 1.31c.562.649 1.413 1.076 2.353 1.253V15a1 1 0 102 0v-.092a4.535 4.535 0 001.676-.662C13.398 13.766 14 12.991 14 12c0-.99-.602-1.765-1.324-2.246A4.535 4.535 0 0011 9.092V7.151c.391.127.68.317.843.504a1 1 0 101.511-1.31c-.563-.649-1.413-1.076-2.354-1.253V5z" clip-rule="evenodd"/>
            </svg>
            Preise
          </span>
        </label>
        <label class="tab-radio-modern">
          <input type="radio" name="product_tabs" value="images" class="hidden peer" />
          <span class="tab-label-modern peer-checked:bg-accent peer-checked:text-accent-content peer-checked:shadow-lg">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
            </svg>
            Bilder
          </span>
        </label>
        <label class="tab-radio-modern">
          <input type="radio" name="product_tabs" value="files" class="hidden peer" />
          <span class="tab-label-modern peer-checked:bg-info peer-checked:text-info-content peer-checked:shadow-lg">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M8 4a3 3 0 00-3 3v4a5 5 0 0010 0V7a1 1 0 112 0v4a7 7 0 11-14 0V7a5 5 0 0110 0v4a3 3 0 11-6 0V7a1 1 0 012 0v4a1 1 0 102 0V7a3 3 0 00-3-3z" clip-rule="evenodd"/>
            </svg>
            Dateien
          </span>
        </label>
        <label class="tab-radio-modern">
          <input type="radio" name="product_tabs" value="dtf" class="hidden peer" />
          <span class="tab-label-modern peer-checked:bg-success peer-checked:text-success-content peer-checked:shadow-lg">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"/>
            </svg>
            DTF
          </span>
        </label>
        <label class="tab-radio-modern">
          <input type="radio" name="product_tabs" value="seo" class="hidden peer" />
          <span class="tab-label-modern peer-checked:bg-warning peer-checked:text-warning-content peer-checked:shadow-lg">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/>
            </svg>
            SEO
          </span>
        </label>
        <label class="tab-radio-modern">
          <input type="radio" name="product_tabs" value="specs" class="hidden peer" />
          <span class="tab-label-modern peer-checked:bg-error peer-checked:text-error-content peer-checked:shadow-lg">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
              <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
            </svg>
            Technische Daten
          </span>
        </label>
      </div>
    </div>

    <!-- Tab Panels -->
    <div id="basic-panel" class="tab-panel p-6">
        <form id="productForm" class="max-w-7xl mx-auto space-y-6">
          <!-- Basic Information Card -->
          <div class="card-modern">
            <div class="card-body p-6">
              <h3 class="text-xl font-bold text-base-content mb-6 flex items-center gap-2">
                <div class="w-1 h-6 bg-primary rounded-full"></div>
                Grundinformationen
              </h3>
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
                <!-- Product Name -->
                <div class="form-control">
                  <label class="label pb-2">
                    <span class="label-text font-bold text-base flex items-center gap-2">
                      Produktname
                      <span class="badge badge-error badge-xs">Pflicht</span>
                    </span>
                  </label>
                  <input type="text" name="name" required class="input-modern h-12 text-base" value={product.name} placeholder="z.B. DTF Transfer Premium" />
                </div>

                <!-- Slug -->
                <div class="form-control">
                  <label class="label pb-2">
                    <span class="label-text font-bold text-base flex items-center gap-2">
                      URL-Slug
                      <span class="badge badge-error badge-xs">Pflicht</span>
                    </span>
                  </label>
                  <input type="text" name="slug" required class="input-modern h-12 text-base font-mono" value={product.slug} placeholder="dtf-transfer-premium" />
                </div>

                <!-- Category -->
                <div class="form-control">
                  <label class="label pb-2">
                    <span class="label-text font-bold text-base flex items-center gap-2">
                      Kategorie
                      <span class="badge badge-error badge-xs">Pflicht</span>
                    </span>
                  </label>
                  <select name="categoryId" required class="select-modern h-12 text-base">
                    <option value="">Kategorie auswählen...</option>
                    {categories.rows.map((cat) => (
                      <option value={cat.id} selected={cat.id === product.categoryId}>{cat.name}</option>
                    ))}
                  </select>
                </div>

                <!-- SKU -->
                <div class="form-control">
                  <label class="label pb-2">
                    <span class="label-text font-bold text-base flex items-center gap-2">
                      Artikelnummer (SKU)
                      <span class="badge badge-ghost badge-xs">Optional</span>
                    </span>
                  </label>
                  <input type="text" name="sku" class="input-modern h-12 text-base" value={product.sku || ''} placeholder="SKU-12345" />
                </div>
              </div>
            </div>
          </div>

          <!-- Description Card -->
          <div class="card-modern">
            <div class="card-body p-6">
              <h3 class="text-xl font-bold text-base-content mb-6 flex items-center gap-2">
                <div class="w-1 h-6 bg-secondary rounded-full"></div>
                Beschreibung
              </h3>
              <div class="space-y-5">
                <!-- Short Description -->
                <div class="form-control">
                  <label class="label pb-2">
                    <span class="label-text font-bold text-base flex items-center gap-2">
                      Kurzbeschreibung
                      <span class="badge badge-error badge-xs">Pflicht</span>
                    </span>
                    <span class="label-text-alt badge badge-info badge-sm">Für Karten</span>
                  </label>
                  <textarea name="shortDescription" required class="textarea-modern h-24 text-base resize-none" placeholder="Kurze, prägnante Beschreibung für Produktkarten...">{product.shortDescription}</textarea>
                </div>

                <!-- Full Description -->
                <div class="form-control">
                  <label class="label pb-2">
                    <span class="label-text font-bold text-base flex items-center gap-2">
                      Vollständige Beschreibung
                      <span class="badge badge-error badge-xs">Pflicht</span>
                    </span>
                    <span class="label-text-alt badge badge-info badge-sm">Für Detailseite</span>
                  </label>
                  <textarea name="description" required class="textarea-modern h-36 text-base resize-none" placeholder="Detaillierte Produktbeschreibung...">{product.description}</textarea>
                </div>
              </div>
            </div>
          </div>

          <!-- Status Settings Card -->
          <div class="card-modern">
            <div class="card-body p-6">
              <h3 class="text-xl font-bold text-base-content mb-6 flex items-center gap-2">
                <div class="w-1 h-6 bg-accent rounded-full"></div>
                Status & Einstellungen
              </h3>
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <label class="flex items-center gap-4 p-4 rounded-xl bg-base-200/60 border-2 border-base-300/40 hover:bg-base-200 hover:border-base-300 cursor-pointer transition-all">
                  <input type="checkbox" name="isActive" class="toggle toggle-success toggle-lg" checked={product.isActive} />
                  <div class="flex-1">
                    <div class="font-bold text-base">Aktiv</div>
                    <div class="text-xs text-base-content/60 mt-0.5">Sichtbar für Kunden</div>
                  </div>
                </label>
                <label class="flex items-center gap-4 p-4 rounded-xl bg-base-200/60 border-2 border-base-300/40 hover:bg-base-200 hover:border-base-300 cursor-pointer transition-all">
                  <input type="checkbox" name="isFeatured" class="toggle toggle-primary toggle-lg" checked={product.isFeatured} />
                  <div class="flex-1">
                    <div class="font-bold text-base">Empfohlen</div>
                    <div class="text-xs text-base-content/60 mt-0.5">Als Featured anzeigen</div>
                  </div>
                </label>
                <label class="flex items-center gap-4 p-4 rounded-xl bg-base-200/60 border-2 border-base-300/40 hover:bg-base-200 hover:border-base-300 cursor-pointer transition-all">
                  <input type="checkbox" name="trackInventory" class="toggle toggle-warning toggle-lg" checked={product.trackInventory} />
                  <div class="flex-1">
                    <div class="font-bold text-base">Lagerbestand</div>
                    <div class="text-xs text-base-content/60 mt-0.5">Bestand verfolgen</div>
                  </div>
                </label>
                <label class="flex items-center gap-4 p-4 rounded-xl bg-base-200/60 border-2 border-base-300/40 hover:bg-base-200 hover:border-base-300 cursor-pointer transition-all">
                  <input type="checkbox" name="requiresShipping" class="toggle toggle-lg" checked={product.requiresShipping} />
                  <div class="flex-1">
                    <div class="font-bold text-base">Versand</div>
                    <div class="text-xs text-base-content/60 mt-0.5">Benötigt Versand</div>
                  </div>
                </label>
              </div>
            </div>
          </div>
        </form>
    </div>

    <div id="pricing-panel" class="tab-panel p-6 hidden">
        <div class="max-w-7xl mx-auto space-y-6">
          <!-- Base Pricing Card -->
          <div class="card-modern">
            <div class="card-body p-6">
              <h3 class="text-xl font-bold text-base-content mb-6 flex items-center gap-2">
                <div class="w-1 h-6 bg-primary rounded-full"></div>
                Grundpreise
              </h3>
              <div class="grid grid-cols-1 lg:grid-cols-3 gap-5">
                <div class="form-control">
                  <label class="label pb-2">
                    <span class="label-text font-bold text-base flex items-center gap-2">
                      Grundpreis
                      <span class="badge badge-error badge-xs">Pflicht</span>
                    </span>
                  </label>
                  <div class="join w-full">
                    <input type="number" name="basePrice" step="0.01" required class="input-modern h-12 text-base font-bold join-item flex-1" value={parseFloat(product.basePrice)} />
                    <span class="btn btn-neutral join-item h-12">€</span>
                  </div>
                </div>

                <div class="form-control">
                  <label class="label pb-2">
                    <span class="label-text font-bold text-base flex items-center gap-2">
                      Vergleichspreis
                      <span class="badge badge-ghost badge-xs">Optional</span>
                    </span>
                  </label>
                  <div class="join w-full">
                    <input type="number" name="compareAtPrice" step="0.01" class="input-modern h-12 text-base join-item flex-1" value={product.compareAtPrice ? parseFloat(product.compareAtPrice) : ''} placeholder="UVP" />
                    <span class="btn btn-neutral join-item h-12">€</span>
                  </div>
                </div>

                <div class="form-control">
                  <label class="label pb-2">
                    <span class="label-text font-bold text-base">Berechnungsmethode</span>
                  </label>
                  <select name="priceCalculationMethod" class="select-modern h-12 text-base">
                    <option value="per_piece" selected={product.priceCalculationMethod === 'per_piece'}>Pro Stück</option>
                    <option value="per_meter" selected={product.priceCalculationMethod === 'per_meter'}>Pro Meter</option>
                    <option value="per_area" selected={product.priceCalculationMethod === 'per_area'}>Pro Fläche (m²)</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <!-- Price Tiers Card -->
          <div class="card bg-base-100 shadow-lg border-2 border-secondary/10 hover:border-secondary/30 transition-all duration-300">
            <div class="card-body">
              <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-6">
                <div>
                  <div class="flex items-center gap-3 mb-2">
                    <div class="badge badge-secondary badge-lg">
                      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z"/>
                      </svg>
                    </div>
                    <h2 class="card-title text-2xl">Preisstaffeln</h2>
                    <span class="badge badge-accent">{priceTiers.rows.length} Staffeln</span>
                  </div>
                  <p class="text-sm text-base-content/60 mt-1">Die erste Staffel ist der Grundpreis (0% Rabatt). Weitere Staffeln berechnen sich automatisch.</p>
                </div>
                <button type="button" id="addTierBtn" class="btn btn-primary gap-2 shadow-md hover:shadow-lg transition-all">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                  </svg>
                  Staffel hinzufügen
                </button>
              </div>
              <div class="divider divider-secondary"></div>

              <div id="priceTiersContainer" class="space-y-3">
                {priceTiers.rows.length > 0 ? (
                  priceTiers.rows.map((tier, index) => (
                    <div class="tier-row card bg-base-100 border border-base-300/50 shadow-sm rounded-xl hover:shadow-md transition-shadow">
                      <div class="card-body p-4">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                          <div class="form-control">
                            <label class="label">
                              <span class="label-text font-medium text-sm">Min. Menge</span>
                            </label>
                            <input type="number" name="tier_minQty[]" value={tier.minQuantity} required class="input input-bordered input-sm tier-minQty" />
                          </div>
                          <div class="form-control">
                            <label class="label">
                              <span class="label-text font-medium text-sm">Max. Menge</span>
                              <span class="label-text-alt text-xs">Leer lassen für ∞</span>
                            </label>
                            <input type="number" name="tier_maxQty[]" value={tier.maxQuantity || ''} class="input input-bordered input-sm tier-maxQty" placeholder="∞" />
                          </div>
                          <div class="form-control">
                            <label class="label">
                              <span class="label-text font-medium text-sm">Rabatt %</span>
                            </label>
                            <input type="number" name="tier_discount[]" value={parseFloat(tier.discountPercent)} step="0.01" required class="input input-bordered input-sm tier-discount" />
                          </div>
                          <div class="form-control">
                            <label class="label">
                              <span class="label-text font-medium text-sm">Preis (€)</span>
                              <span class="label-text-alt text-xs">Auto-berechnet</span>
                            </label>
                            <input type="number" name="tier_price[]" value={parseFloat(tier.pricePerUnit)} step="0.01" required class="input input-bordered input-sm tier-price bg-base-200" readonly />
                          </div>
                          <div class="form-control">
                            <label class="label">
                              <span class="label-text font-medium text-sm">Reihenfolge</span>
                            </label>
                            <div class="join w-full">
                              <input type="number" name="tier_order[]" value={tier.displayOrder} required class="input input-bordered input-sm join-item flex-1 tier-order" />
                              <button type="button" class="btn btn-error btn-sm join-item remove-tier">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  ))
                ) : (
                  <div class="tier-row card bg-base-100 border border-base-300/50 shadow-sm rounded-xl hover:shadow-md transition-shadow">
                    <div class="card-body p-4">
                      <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                        <div class="form-control">
                          <label class="label">
                            <span class="label-text font-medium text-sm">Min. Menge</span>
                          </label>
                          <input type="number" name="tier_minQty[]" value="0" required class="input input-bordered input-sm tier-minQty" />
                        </div>
                        <div class="form-control">
                          <label class="label">
                            <span class="label-text font-medium text-sm">Max. Menge</span>
                            <span class="label-text-alt text-xs">Leer lassen für ∞</span>
                          </label>
                          <input type="number" name="tier_maxQty[]" class="input input-bordered input-sm tier-maxQty" placeholder="∞" />
                        </div>
                        <div class="form-control">
                          <label class="label">
                            <span class="label-text font-medium text-sm">Rabatt %</span>
                          </label>
                          <input type="number" name="tier_discount[]" value="0" step="0.01" required class="input input-bordered input-sm tier-discount" />
                        </div>
                        <div class="form-control">
                          <label class="label">
                            <span class="label-text font-medium text-sm">Preis (€)</span>
                            <span class="label-text-alt text-xs">Auto-berechnet</span>
                          </label>
                          <input type="number" name="tier_price[]" value={parseFloat(product.basePrice)} step="0.01" required class="input input-bordered input-sm tier-price bg-base-200" readonly />
                        </div>
                        <div class="form-control">
                          <label class="label">
                            <span class="label-text font-medium text-sm">Reihenfolge</span>
                          </label>
                          <div class="join w-full">
                            <input type="number" name="tier_order[]" value="1" required class="input input-bordered input-sm join-item flex-1 tier-order" />
                            <button type="button" class="btn btn-error btn-sm join-item remove-tier">
                              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                              </svg>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
    </div>

    <div id="images-panel" class="tab-panel p-6 hidden">
        <ProductImageUpload productId={id} existingImages={productImages.rows} />
    </div>

    <div id="files-panel" class="tab-panel p-6 hidden">
        <div class="card bg-gradient-to-br from-base-100 to-base-200/30 border border-base-300/30 shadow-md rounded-xl">
          <div class="card-body">
            <h2 class="card-title text-lg mb-4 text-base-content">Design-Dateien</h2>
            <p class="text-sm text-base-content/60 mb-4">Verwalten Sie hochgeladene Kundendateien für dieses Produkt</p>
            <ProductFileUpload productId={id} existingFiles={productFiles.rows} />
          </div>
        </div>
    </div>

    <div id="dtf-panel" class="tab-panel p-6 hidden">
        <div class="space-y-6">
          <!-- DTF Type Card -->
          <div class="card bg-gradient-to-br from-base-100 to-base-200/30 border border-base-300/30 shadow-md rounded-xl">
            <div class="card-body">
              <h2 class="card-title text-lg mb-4 text-base-content">DTF-Konfiguration</h2>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-control">
                  <label class="label cursor-pointer justify-start gap-3 p-4 bg-base-100 rounded-xl border border-base-300/50 hover:bg-base-200/80 hover:border-base-300 transition-all duration-200 shadow-sm">
                    <input type="checkbox" name="isBlockout" class="toggle toggle-primary" checked={product.isBlockout} />
                    <div class="flex-1">
                      <span class="label-text font-semibold">Blockout-Produkt</span>
                      <p class="text-xs text-base-content/60 mt-1">Spezieller Blockout-DTF-Transfer</p>
                    </div>
                  </label>
                </div>

                <div class="form-control">
                  <label class="label">
                    <span class="label-text font-semibold">Drucktechnologie</span>
                  </label>
                  <input type="text" name="printTechnology" value={product.printTechnology || 'DTF'} class="input input-bordered" />
                </div>
              </div>
            </div>
          </div>

          <!-- File Upload Settings Card -->
          <div class="card bg-gradient-to-br from-base-100 to-base-200/30 border border-base-300/30 shadow-md rounded-xl">
            <div class="card-body">
              <h2 class="card-title text-lg mb-4 text-base-content">Datei-Upload-Einstellungen</h2>
              <div class="form-control mb-4">
                <label class="label cursor-pointer justify-start gap-3 p-4 bg-base-100 rounded-lg border border-base-300 hover:bg-base-200 transition-colors">
                  <input type="checkbox" id="acceptsFileUpload" name="acceptsFileUpload" class="toggle toggle-secondary" checked={product.acceptsFileUpload} />
                  <div class="flex-1">
                    <span class="label-text font-semibold">Datei-Upload erlauben</span>
                    <p class="text-xs text-base-content/60 mt-1">Kunden können Design-Dateien hochladen</p>
                  </div>
                </label>
              </div>

              <div id="fileUploadSettings" class={product.acceptsFileUpload ? 'space-y-4' : 'hidden space-y-4'}>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="form-control">
                    <label class="label">
                      <span class="label-text font-semibold">Max. Dateigröße (MB)</span>
                    </label>
                    <input type="number" name="maxFileSizeMb" value={product.maxFileSizeMb || 255} class="input input-bordered" />
                  </div>

                  <div class="form-control">
                    <label class="label">
                      <span class="label-text font-semibold">Erlaubte Dateitypen</span>
                    </label>
                    <input type="text" name="allowedFileTypes" value={product.allowedFileTypes || 'PDF'} class="input input-bordered" placeholder="PDF, PNG, JPG" />
                    <label class="label">
                      <span class="label-text-alt">Kommagetrennte Liste von Dateierweiterungen</span>
                    </label>
                  </div>
                </div>

                <div class="divider">Abmessungen</div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div class="form-control">
                    <label class="label">
                      <span class="label-text font-semibold">Max. Breite (mm)</span>
                    </label>
                    <input type="number" name="maxWidthMm" value={product.maxWidthMm || ''} class="input input-bordered" placeholder="560" />
                  </div>

                  <div class="form-control">
                    <label class="label">
                      <span class="label-text font-semibold">Min. Höhe (mm)</span>
                    </label>
                    <input type="number" name="minHeightMm" value={product.minHeightMm || ''} class="input input-bordered" placeholder="100" />
                  </div>

                  <div class="form-control">
                    <label class="label">
                      <span class="label-text font-semibold">Max. Höhe (mm)</span>
                    </label>
                    <input type="number" name="maxHeightMm" value={product.maxHeightMm || ''} class="input input-bordered" placeholder="5000" />
                  </div>
                </div>

                <div class="divider mt-6 mb-4">
                  <span class="text-sm font-semibold text-base-content/70">Qualitätsanforderungen</span>
                </div>

                <div class="alert alert-info shadow-sm mb-4">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <div>
                    <p class="text-sm font-medium">Diese Einstellungen definieren die Mindestanforderungen für hochgeladene Dateien.</p>
                    <p class="text-xs mt-1">Kunden erhalten automatische Warnungen, wenn ihre Dateien die Anforderungen nicht erfüllen.</p>
                  </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div class="form-control">
                    <label class="label">
                      <span class="label-text font-semibold flex items-center gap-2">
                        Erforderliche DPI
                        <div class="tooltip" data-tip="Mindest-DPI für PNG-Dateien. Empfohlen: 300 DPI für beste Druckqualität">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-base-content/50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                        </div>
                      </span>
                    </label>
                    <input
                      type="number"
                      name="requiredDpi"
                      value={product.requiredDpi || 300}
                      class="input input-bordered"
                      min="72"
                      max="600"
                      placeholder="300"
                    />
                    <label class="label">
                      <span class="label-text-alt text-base-content/60">Standard: 300 DPI</span>
                    </label>
                  </div>

                  <div class="form-control">
                    <label class="label">
                      <span class="label-text font-semibold flex items-center gap-2">
                        Min. Breite (Pixel)
                        <div class="tooltip" data-tip="Minimale Breite in Pixeln für PNG-Dateien. Leer lassen für keine Einschränkung">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-base-content/50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                        </div>
                      </span>
                    </label>
                    <input
                      type="number"
                      name="requiredMinWidth"
                      value={product.requiredMinWidth || ''}
                      class="input input-bordered"
                      min="1"
                      placeholder="z.B. 1200"
                    />
                    <label class="label">
                      <span class="label-text-alt text-base-content/60">Optional (nur PNG)</span>
                    </label>
                  </div>

                  <div class="form-control">
                    <label class="label">
                      <span class="label-text font-semibold flex items-center gap-2">
                        Min. Höhe (Pixel)
                        <div class="tooltip" data-tip="Minimale Höhe in Pixeln für PNG-Dateien. Leer lassen für keine Einschränkung">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-base-content/50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                        </div>
                      </span>
                    </label>
                    <input
                      type="number"
                      name="requiredMinHeight"
                      value={product.requiredMinHeight || ''}
                      class="input input-bordered"
                      min="1"
                      placeholder="z.B. 800"
                    />
                    <label class="label">
                      <span class="label-text-alt text-base-content/60">Optional (nur PNG)</span>
                    </label>
                  </div>
                </div>

                <div class="bg-base-200/50 rounded-lg p-4 border border-base-300/50 mt-4">
                  <h4 class="text-sm font-semibold mb-2 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Vorschau der Anforderungen
                  </h4>
                  <div class="text-xs space-y-1 text-base-content/70">
                    <p>• <strong>Akzeptierte Formate:</strong> <span id="preview-formats">{product.allowedFileTypes || 'pdf,png'}</span></p>
                    <p>• <strong>Minimale DPI:</strong> <span id="preview-dpi">{product.requiredDpi || 300}</span> DPI (nur PNG)</p>
                    <p id="preview-width-row" class={product.requiredMinWidth ? '' : 'hidden'}>
                      • <strong>Minimale Breite:</strong> <span id="preview-width">{product.requiredMinWidth || '-'}</span> px (nur PNG)
                    </p>
                    <p id="preview-height-row" class={product.requiredMinHeight ? '' : 'hidden'}>
                      • <strong>Minimale Höhe:</strong> <span id="preview-height">{product.requiredMinHeight || '-'}</span> px (nur PNG)
                    </p>
                    <p class="text-warning mt-2 flex items-center gap-1">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                      </svg>
                      Kunden erhalten Warnungen, wenn ihre Dateien diese Anforderungen nicht erfüllen
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
    </div>

    <div id="seo-panel" class="tab-panel p-8 hidden">
        <div class="card bg-base-100 shadow-lg border-2 border-success/10 hover:border-success/30 transition-all duration-300">
          <div class="card-body">
            <div class="flex items-center gap-3 mb-6">
              <div class="badge badge-success badge-lg">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd"/>
                </svg>
              </div>
              <h2 class="card-title text-2xl text-base-content">SEO-Optimierung</h2>
              <span class="badge badge-info gap-2">
                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                </svg>
                Google Search
              </span>
            </div>
            <div class="divider divider-success my-2"></div>
            <div class="space-y-6 mt-4">
              <div class="form-control">
                <label class="label">
                  <span class="label-text font-semibold flex items-center gap-2 text-lg">
                    <svg class="w-5 h-5 text-success" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    Meta-Titel
                    <span class="badge badge-ghost badge-xs">Optional</span>
                  </span>
                  <span class="label-text-alt">
                    <span class={`badge ${(product.metaTitle || '').length > 50 ? 'badge-warning' : 'badge-success'}`}>
                      {(product.metaTitle || '').length}/60 Zeichen
                    </span>
                  </span>
                </label>
                <input type="text" name="metaTitle" class="input input-bordered input-lg focus:input-success transition-all" value={product.metaTitle || ''} placeholder="Leer lassen, um Produktnamen zu verwenden" maxlength="60" />
                <label class="label">
                  <span class="label-text-alt badge badge-info badge-sm gap-1">
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                      <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                    </svg>
                    Anzeige in Browser-Tabs und Suchergebnissen
                  </span>
                </label>
              </div>

              <div class="form-control">
                <label class="label">
                  <span class="label-text font-semibold flex items-center gap-2 text-lg">
                    <svg class="w-5 h-5 text-success" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/>
                    </svg>
                    Meta-Beschreibung
                    <span class="badge badge-ghost badge-xs">Optional</span>
                  </span>
                  <span class="label-text-alt">
                    <span class={`badge ${(product.metaDescription || '').length > 140 ? 'badge-warning' : 'badge-success'}`}>
                      {(product.metaDescription || '').length}/160 Zeichen
                    </span>
                  </span>
                </label>
                <textarea name="metaDescription" class="textarea textarea-bordered textarea-lg h-28 focus:textarea-success transition-all" placeholder="Leer lassen, um Kurzbeschreibung zu verwenden" maxlength="160">{product.metaDescription || ''}</textarea>
                <label class="label">
                  <span class="label-text-alt badge badge-info badge-sm gap-1">
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                      <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                    </svg>
                    Erscheint in Suchergebnissen als Vorschautext
                  </span>
                </label>
              </div>

              <div class="divider">SEO-Vorschau</div>

              <div class="alert alert-info shadow-md">
                <div class="flex-1">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current flex-shrink-0 w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  <div>
                    <h3 class="font-bold">Automatische Fallback-Werte</h3>
                    <div class="text-sm mt-1">SEO-Felder sind optional. Wenn leer gelassen, werden automatisch Produktname und Kurzbeschreibung verwendet.</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
    </div>

    <div id="specs-panel" class="tab-panel p-8 hidden">
        <div class="card bg-base-100 shadow-lg border-2 border-accent/10 hover:border-accent/30 transition-all duration-300">
          <div class="card-body">
            <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4 mb-6">
              <div>
                <div class="flex items-center gap-3 mb-2">
                  <div class="badge badge-accent badge-lg">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                      <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                    </svg>
                  </div>
                  <h2 class="card-title text-2xl text-base-content">Produktspezifikationen</h2>
                  <span class="badge badge-info">{productSpecs.rows.length} Specs</span>
                </div>
                <p class="text-sm text-base-content/60 mt-1">Benutzerdefinierte technische Daten und Eigenschaften</p>
              </div>
              <button type="button" id="addSpecBtn" class="btn btn-primary gap-2 shadow-md hover:shadow-lg transition-all">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Spezifikation hinzufügen
              </button>
            </div>
            <div class="divider divider-accent"></div>

            <div id="specificationsContainer" class="space-y-3">
              {productSpecs.rows.length === 0 ? (
                <div class="text-center py-12 text-base-content/50">
                  <svg class="w-16 h-16 mx-auto mb-4 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  <p class="text-sm font-medium">Noch keine Spezifikationen hinzugefügt</p>
                  <p class="text-xs text-base-content/50 mt-1">Klicken Sie auf "Spezifikation hinzufügen", um zu beginnen</p>
                </div>
              ) : (
                productSpecs.rows.map((spec) => (
                  <div class="spec-row card bg-base-100 border border-base-300/50 shadow-sm rounded-xl hover:shadow-md transition-shadow" data-spec-id={spec.id}>
                    <div class="card-body p-4">
                      <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
                        <div class="col-span-12 md:col-span-3 form-control">
                          <label class="label">
                            <span class="label-text font-medium text-sm">Bezeichnung</span>
                          </label>
                          <input
                            type="text"
                            class="input input-bordered input-sm spec-label"
                            value={spec.specLabel}
                            placeholder="z.B. Material"
                          />
                        </div>
                        <div class="col-span-12 md:col-span-3 form-control">
                          <label class="label">
                            <span class="label-text font-medium text-sm">Schlüssel (eindeutig)</span>
                          </label>
                          <input
                            type="text"
                            class="input input-bordered input-sm spec-key"
                            value={spec.specKey}
                            placeholder="z.B. material"
                          />
                        </div>
                        <div class="col-span-12 md:col-span-4 form-control">
                          <label class="label">
                            <span class="label-text font-medium text-sm">Wert</span>
                          </label>
                          <input
                            type="text"
                            class="input input-bordered input-sm spec-value"
                            value={spec.specValue}
                            placeholder="z.B. Polyester"
                          />
                        </div>
                        <div class="col-span-12 md:col-span-1 form-control">
                          <label class="label">
                            <span class="label-text font-medium text-sm">Reihenfolge</span>
                          </label>
                          <input
                            type="number"
                            class="input input-bordered input-sm spec-order text-center"
                            value={spec.displayOrder}
                          />
                        </div>
                        <div class="col-span-12 md:col-span-1 flex items-end">
                          <button type="button" class="btn btn-error btn-sm btn-square remove-spec w-full">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                ))
              )}
            </div>

            <div class="flex justify-end mt-4">
              <button type="button" id="saveSpecsBtn" class="btn btn-success btn-sm gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                Spezifikationen speichern
              </button>
            </div>
          </div>
        </div>
    </div>
  </div>

    <!-- Modern Action Bar -->
    <div class="border-t-2 border-primary/20 p-6 bg-gradient-to-r from-base-100 via-base-200/30 to-base-100">
      <div class="flex flex-col lg:flex-row justify-between items-center gap-4">
        <div class="flex items-center gap-3">
          <div class="avatar placeholder">
            <div class="bg-primary text-primary-content rounded-full w-12">
              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
              </svg>
            </div>
          </div>
          <div>
            <div class="font-semibold text-sm text-base-content">Zuletzt aktualisiert</div>
            <div class="text-xs text-base-content/60 flex items-center gap-2">
              <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
              </svg>
              {new Date(product.updatedAt).toLocaleString('de-DE')}
            </div>
          </div>
        </div>
        <div class="flex gap-3">
          <a href="/admin/products" class="btn btn-ghost btn-lg gap-2 hover:bg-base-200/80 transition-all">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
            Abbrechen
          </a>
          <button type="submit" form="productForm" class="btn btn-primary btn-lg gap-2 shadow-lg hover:shadow-xl transition-all hover:scale-105">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            Änderungen speichern
            <span class="badge badge-success badge-sm">Strg+S</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</AdminLayout>

<script define:vars={{ productId: id }}>
  // Helper function for clean DaisyUI toast notifications (bottom right)
  function showToast(message, type = 'success') {
    // Remove any existing toasts first
    const existingToasts = document.querySelectorAll('.toast-container');
    existingToasts.forEach(toast => toast.remove());

    // Create toast container
    const toastContainer = document.createElement('div');
    toastContainer.className = 'toast toast-bottom toast-end z-50';
    
    const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-error' : 'alert-info';
    const icon = type === 'success' 
      ? '<svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-5 w-5" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>'
      : type === 'error'
      ? '<svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-5 w-5" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>'
      : '<svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-5 w-5" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>';
    
    toastContainer.innerHTML = `
      <div class="alert ${alertClass} shadow-lg max-w-sm">
        ${icon}
        <span class="text-sm">${message}</span>
      </div>
    `;
    
    document.body.appendChild(toastContainer);
    
    // Auto-remove after 2 seconds
    setTimeout(() => {
      toastContainer.style.opacity = '0';
      toastContainer.style.transition = 'opacity 0.3s ease-out';
      setTimeout(() => toastContainer.remove(), 300);
    }, 2000);
  }

  // Tab navigation with radio buttons
  const tabRadios = document.querySelectorAll('input[name="product_tabs"]');
  const tabPanels = {
    basic: document.getElementById('basic-panel'),
    pricing: document.getElementById('pricing-panel'),
    images: document.getElementById('images-panel'),
    dtf: document.getElementById('dtf-panel'),
    seo: document.getElementById('seo-panel'),
    specs: document.getElementById('specs-panel')
  };

  function showTab(tabName) {
    // Hide all panels
    Object.values(tabPanels).forEach(panel => {
      if (panel) panel.classList.add('hidden');
    });
    
    // Show selected panel
    if (tabPanels[tabName]) {
      tabPanels[tabName].classList.remove('hidden');
    }
  }

  // Add event listeners to radio buttons
  tabRadios.forEach(radio => {
    radio.addEventListener('change', (e) => {
      if (e.target.checked) {
        showTab(e.target.value);
      }
    });
  });

  // Initialize with first tab
  showTab('basic');

  // Toggle file upload settings
  document.getElementById('acceptsFileUpload')?.addEventListener('change', (e) => {
    const settings = document.getElementById('fileUploadSettings');
    if (settings) {
      settings.classList.toggle('hidden', !e.target.checked);
    }
  });

  // Update requirements preview in real-time
  const updateRequirementsPreview = () => {
    const allowedFileTypes = document.querySelector('[name="allowedFileTypes"]')?.value || 'pdf,png';
    const requiredDpi = document.querySelector('[name="requiredDpi"]')?.value || '300';
    const requiredMinWidth = document.querySelector('[name="requiredMinWidth"]')?.value;
    const requiredMinHeight = document.querySelector('[name="requiredMinHeight"]')?.value;

    // Update preview elements
    const previewFormats = document.getElementById('preview-formats');
    const previewDpi = document.getElementById('preview-dpi');
    const previewWidth = document.getElementById('preview-width');
    const previewHeight = document.getElementById('preview-height');
    const previewWidthRow = document.getElementById('preview-width-row');
    const previewHeightRow = document.getElementById('preview-height-row');

    if (previewFormats) previewFormats.textContent = allowedFileTypes.toUpperCase();
    if (previewDpi) previewDpi.textContent = requiredDpi;

    if (previewWidth && requiredMinWidth) {
      previewWidth.textContent = requiredMinWidth;
      previewWidthRow?.classList.remove('hidden');
    } else {
      previewWidthRow?.classList.add('hidden');
    }

    if (previewHeight && requiredMinHeight) {
      previewHeight.textContent = requiredMinHeight;
      previewHeightRow?.classList.remove('hidden');
    } else {
      previewHeightRow?.classList.add('hidden');
    }
  };

  // Add event listeners to quality requirement fields
  document.querySelector('[name="allowedFileTypes"]')?.addEventListener('input', updateRequirementsPreview);
  document.querySelector('[name="requiredDpi"]')?.addEventListener('input', updateRequirementsPreview);
  document.querySelector('[name="requiredMinWidth"]')?.addEventListener('input', updateRequirementsPreview);
  document.querySelector('[name="requiredMinHeight"]')?.addEventListener('input', updateRequirementsPreview);

  // Calculate tier price based on discount and base price
  function calculateTierPrice(discountPercent, basePrice) {
    const discount = parseFloat(discountPercent) || 0;
    const base = parseFloat(basePrice) || 0;
    return (base * (1 - discount / 100)).toFixed(2);
  }

  // Update all tier prices when base price changes
  function updateAllTierPrices() {
    const basePriceInput = document.querySelector('[name="basePrice"]');
    const basePrice = parseFloat(basePriceInput?.value) || 0;

    document.querySelectorAll('.tier-row').forEach(row => {
      const discountInput = row.querySelector('.tier-discount');
      const priceInput = row.querySelector('.tier-price');
      const discount = parseFloat(discountInput?.value) || 0;

      if (priceInput) {
        priceInput.value = calculateTierPrice(discount, basePrice);
      }
    });
  }

  // Update tier price when discount changes
  function updateTierPrice(tierRow) {
    const basePriceInput = document.querySelector('[name="basePrice"]');
    const basePrice = parseFloat(basePriceInput?.value) || 0;
    const discountInput = tierRow.querySelector('.tier-discount');
    const priceInput = tierRow.querySelector('.tier-price');
    const discount = parseFloat(discountInput?.value) || 0;

    if (priceInput) {
      priceInput.value = calculateTierPrice(discount, basePrice);
    }
  }

  // Auto-save price tiers function (defined before use)
  let saveTiersTimeout;
  async function savePriceTiersAuto(showToast = true) {
    // Clear any pending saves
    if (saveTiersTimeout) {
      clearTimeout(saveTiersTimeout);
    }

    // Debounce: wait 500ms after last change
    saveTiersTimeout = setTimeout(async () => {
      const getValue = (name) => {
        const input = document.querySelector(`[name="${name}"]`);
        if (!input) return null;
        return input.value || null;
      };

      const getAllValues = (name) => {
        const inputs = document.querySelectorAll(`[name="${name}"]`);
        return Array.from(inputs).map(input => input.value);
      };

      const basePrice = getValue('basePrice');
      const compareAtPrice = getValue('compareAtPrice');
      const priceCalculationMethod = getValue('priceCalculationMethod');

      if (!basePrice || isNaN(parseFloat(basePrice))) {
        console.warn('[Auto-save] Base price not valid, skipping save');
        return;
      }

      // Collect price tiers
      const minQties = getAllValues('tier_minQty[]');
      const maxQties = getAllValues('tier_maxQty[]');
      const discounts = getAllValues('tier_discount[]');
      const prices = getAllValues('tier_price[]');
      const orders = getAllValues('tier_order[]');

      const priceTiers = [];
      for (let i = 0; i < minQties.length; i++) {
        priceTiers.push({
          minQuantity: parseInt(minQties[i]),
          maxQuantity: maxQties[i] ? parseInt(maxQties[i]) : null,
          discountPercent: parseFloat(discounts[i]),
          pricePerUnit: parseFloat(prices[i]),
          displayOrder: parseInt(orders[i])
        });
      }

      const data = {
        basePrice: parseFloat(basePrice),
        compareAtPrice: compareAtPrice ? parseFloat(compareAtPrice) : null,
        priceCalculationMethod: priceCalculationMethod || 'per_piece',
        priceTiers: priceTiers
      };

      try {
        const response = await fetch(`/api/admin/products/${productId}/pricing`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const errorText = await response.text();
          console.error('[Auto-save] Error saving price tiers:', errorText);
          if (showToast) {
            showToast('Fehler beim automatischen Speichern', 'error');
          }
          return;
        }

        const result = await response.json();
        if (result.success && showToast) {
          showToast('✓ Automatisch gespeichert', 'success');
        }
      } catch (error) {
        console.error('[Auto-save] Error:', error);
        if (showToast) {
          const toast = document.createElement('div');
          toast.className = 'toast toast-top toast-end';
          toast.innerHTML = '<div class="alert alert-error"><span>Fehler beim automatischen Speichern</span></div>';
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 3000);
        }
      }
    }, 500);
  }

  // Add price tier
  let tierCount = document.querySelectorAll('.tier-row').length;
  document.getElementById('addTierBtn')?.addEventListener('click', () => {
    tierCount++;
    const container = document.getElementById('priceTiersContainer');
    const basePriceInput = document.querySelector('[name="basePrice"]');
    const basePrice = parseFloat(basePriceInput?.value) || 0;

    const tier = document.createElement('div');
    tier.className = 'tier-row card bg-base-100 border border-base-300';
    tier.innerHTML = `
      <div class="card-body p-4">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium text-sm">Min. Menge</span>
            </label>
            <input type="number" name="tier_minQty[]" value="${tierCount * 5}" required class="input input-bordered input-sm tier-minQty" />
          </div>
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium text-sm">Max. Menge</span>
              <span class="label-text-alt text-xs">Leer lassen für ∞</span>
            </label>
            <input type="number" name="tier_maxQty[]" class="input input-bordered input-sm tier-maxQty" placeholder="∞" />
          </div>
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium text-sm">Rabatt %</span>
            </label>
            <input type="number" name="tier_discount[]" value="10" step="0.01" required class="input input-bordered input-sm tier-discount" />
          </div>
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium text-sm">Preis (€)</span>
              <span class="label-text-alt text-xs">Auto-berechnet</span>
            </label>
            <input type="number" name="tier_price[]" value="${calculateTierPrice(10, basePrice)}" step="0.01" required class="input input-bordered input-sm tier-price bg-base-200" readonly />
          </div>
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium text-sm">Reihenfolge</span>
            </label>
            <div class="join w-full">
              <input type="number" name="tier_order[]" value="${tierCount}" required class="input input-bordered input-sm join-item flex-1 tier-order" />
              <button type="button" class="btn btn-error btn-sm join-item remove-tier">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
    container?.appendChild(tier);

    // Add event listener to the new tier's discount input
    const newTier = container?.lastElementChild;
    const discountInput = newTier?.querySelector('.tier-discount');
    discountInput?.addEventListener('input', () => {
      updateTierPrice(newTier);
      savePriceTiersAuto(false); // Auto-save without toast on input change
    });

    // Show toast and auto-save after adding tier
    showToast('Preisstaffel hinzugefügt', 'success');
    savePriceTiersAuto(false); // Don't show another toast, we already showed one
  });

  // Remove price tier
  document.addEventListener('click', async (e) => {
    if (e.target.closest('.remove-tier')) {
      const tiers = document.querySelectorAll('.tier-row');
      if (tiers.length > 1) {
        e.target.closest('.tier-row')?.remove();
        // Auto-save after removing tier
        await savePriceTiersAuto(true);
      } else {
        alert('Mindestens eine Preisstaffel ist erforderlich');
      }
    }
  });

  // Form submission
  document.getElementById('productForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Collect data from all tabs, not just the form
    const getValue = (name) => {
      // Try to find the field - could be input, textarea, or select
      const input = document.querySelector(`[name="${name}"]`);
      if (!input) {
        console.warn(`[Form] Field not found: ${name}`);
        // Try to find it in the form specifically
        const formInput = document.getElementById('productForm')?.querySelector(`[name="${name}"]`);
        if (formInput) {
          console.log(`[Form] Found ${name} in form`);
          const value = formInput.value || (formInput.type === 'checkbox' ? formInput.checked : '');
          return value === '' ? null : value;
        }
        return null;
      }
      if (input.type === 'checkbox') return input.checked;
      // Handle textarea, select, and input fields
      const value = input.value || '';
      // Don't trim for description fields - they might have intentional whitespace
      // Only return null if truly empty
      return value === '' ? null : value;
    };

    const getAllValues = (name) => {
      const inputs = document.querySelectorAll(`[name="${name}"]`);
      return Array.from(inputs).map(input => input.value);
    };

    // Find submit button - it's outside the form, so use document.querySelector
    const submitBtn = document.querySelector('button[type="submit"][form="productForm"]');
    if (!submitBtn) {
      console.error('[Form] Submit button not found!');
      alert('Fehler: Submit-Button nicht gefunden');
      return;
    }
    const originalText = submitBtn.innerHTML;

    // Collect all form values with better handling
    const name = getValue('name');
    const slug = getValue('slug');
    const categoryId = getValue('categoryId');
    const sku = getValue('sku');
    const shortDescription = getValue('shortDescription');
    const description = getValue('description');
    const basePrice = getValue('basePrice');

    // Debug: Check description field specifically
    const descriptionField = document.querySelector('textarea[name="description"]');
    console.log('[Form] Description field element:', descriptionField);
    console.log('[Form] Description field value:', descriptionField?.value);
    console.log('[Form] Description field value length:', descriptionField?.value?.length);
    
    console.log('[Form] Collected values:', {
      name,
      slug,
      categoryId,
      sku,
      shortDescription: shortDescription ? `${shortDescription.substring(0, 50)}...` : 'MISSING',
      description: description ? `${description.substring(0, 50)}...` : 'MISSING',
      basePrice
    });

    // Validate required fields before sending
    // Only check if fields are null (not found), not if they're empty strings
    // The API will handle validation of empty strings
    const missing = [];
    if (name === null) missing.push('name (Produktname)');
    if (slug === null) missing.push('slug (URL-Slug)');
    if (categoryId === null) missing.push('categoryId (Kategorie)');
    if (shortDescription === null) missing.push('shortDescription (Kurzbeschreibung)');
    if (description === null) missing.push('description (Vollständige Beschreibung)');
    if (basePrice === null || isNaN(parseFloat(basePrice))) missing.push('basePrice (Grundpreis)');
    
    if (missing.length > 0) {
      console.error('[Form] Missing required fields (not found in DOM):', missing);
      console.error('[Form] Field values:', {
        name: name === null ? 'NOT FOUND' : (name || 'EMPTY'),
        slug: slug === null ? 'NOT FOUND' : (slug || 'EMPTY'),
        categoryId: categoryId === null ? 'NOT FOUND' : (categoryId || 'EMPTY'),
        shortDescription: shortDescription === null ? 'NOT FOUND' : (shortDescription || 'EMPTY'),
        description: description === null ? 'NOT FOUND' : (description || 'EMPTY'),
        basePrice: basePrice === null ? 'NOT FOUND' : (basePrice || 'EMPTY')
      });
      alert(`Fehler: Folgende Felder konnten nicht gefunden werden:\n${missing.join('\n')}\n\nBitte laden Sie die Seite neu.`);
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
      return;
    }
    
    // Check for empty required fields (user validation)
    const emptyFields = [];
    if (!name || name.trim() === '') emptyFields.push('Produktname');
    if (!slug || slug.trim() === '') emptyFields.push('URL-Slug');
    if (!categoryId || categoryId.trim() === '') emptyFields.push('Kategorie');
    if (!shortDescription || shortDescription.trim() === '') emptyFields.push('Kurzbeschreibung');
    if (!description || description.trim() === '') emptyFields.push('Vollständige Beschreibung');
    if (!basePrice || isNaN(parseFloat(basePrice))) emptyFields.push('Grundpreis');
    
    if (emptyFields.length > 0) {
      alert(`Bitte füllen Sie alle Pflichtfelder aus:\n${emptyFields.join('\n')}`);
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
      return;
    }

    const data = {
      name,
      slug,
      categoryId,
      sku: sku || null,
      shortDescription,
      description,
      basePrice: parseFloat(basePrice),
      compareAtPrice: getValue('compareAtPrice') ? parseFloat(getValue('compareAtPrice')) : null,
      priceCalculationMethod: getValue('priceCalculationMethod') || 'per_piece',
      isBlockout: getValue('isBlockout') === true,
      acceptsFileUpload: getValue('acceptsFileUpload') === true,
      maxFileSizeMb: parseInt(getValue('maxFileSizeMb')) || 255,
      allowedFileTypes: getValue('allowedFileTypes') || 'pdf,png',
      requiredDpi: parseInt(getValue('requiredDpi')) || 300,
      requiredMinWidth: parseInt(getValue('requiredMinWidth')) || null,
      requiredMinHeight: parseInt(getValue('requiredMinHeight')) || null,
      maxWidthMm: parseInt(getValue('maxWidthMm')) || null,
      minHeightMm: parseInt(getValue('minHeightMm')) || null,
      maxHeightMm: parseInt(getValue('maxHeightMm')) || null,
      printTechnology: getValue('printTechnology') || 'DTF',
      trackInventory: getValue('trackInventory') === true,
      requiresShipping: getValue('requiresShipping') === true,
      isActive: getValue('isActive') === true,
      isFeatured: getValue('isFeatured') === true,
      metaTitle: getValue('metaTitle') || null,
      metaDescription: getValue('metaDescription') || null,
      priceTiers: []
    };

    // Collect price tiers
    const minQties = getAllValues('tier_minQty[]');
    const maxQties = getAllValues('tier_maxQty[]');
    const discounts = getAllValues('tier_discount[]');
    const prices = getAllValues('tier_price[]');
    const orders = getAllValues('tier_order[]');

    console.log('[Form] Collecting price tiers:', {
      minQties,
      maxQties,
      discounts,
      prices,
      orders
    });

    for (let i = 0; i < minQties.length; i++) {
      data.priceTiers.push({
        minQuantity: parseInt(minQties[i]),
        maxQuantity: maxQties[i] ? parseInt(maxQties[i]) : null,
        discountPercent: parseFloat(discounts[i]),
        pricePerUnit: parseFloat(prices[i]),
        displayOrder: parseInt(orders[i])
      });
    }

    console.log('[Form] Collected price tiers:', data.priceTiers);
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Speichern...';

    try {
      console.log('[Form] Sending data to API:', JSON.stringify(data, null, 2));
      
      const response = await fetch(`/api/admin/products/${productId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (!response.ok) {
        const errorText = await response.text();
        console.error('[Form] API error response:', errorText);
        throw new Error(`API returned ${response.status}: ${errorText}`);
      }

      const result = await response.json();
      console.log('[Form] API response:', result);

      if (result.success) {
        // Show success toast
        const toast = document.createElement('div');
        toast.className = 'toast toast-top toast-end';
        toast.innerHTML = '<div class="alert alert-success"><span>Produkt erfolgreich aktualisiert!</span></div>';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);

        // Reset button
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
        
        // Reload page to show updated price tiers
        setTimeout(() => window.location.reload(), 1500);
      } else {
        throw new Error(result.error?.message || 'Unbekannter Fehler');
      }
    } catch (error) {
      console.error('[Form] Error updating product:', error);
      alert('Fehler beim Aktualisieren des Produkts: ' + error.message);
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }
  });

  // Add specification
  let specCount = document.querySelectorAll('.spec-row').length;
  document.getElementById('addSpecBtn')?.addEventListener('click', () => {
    specCount++;
    const container = document.getElementById('specificationsContainer');

    // Remove empty state if it exists
    const emptyState = container?.querySelector('.text-center');
    if (emptyState) {
      emptyState.remove();
    }

    const spec = document.createElement('div');
    spec.className = 'spec-row card bg-base-100 border border-base-300';
    spec.dataset.specId = 'new';
    spec.innerHTML = `
      <div class="card-body p-4">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
          <div class="col-span-12 md:col-span-3 form-control">
            <label class="label">
              <span class="label-text font-medium text-sm">Bezeichnung</span>
            </label>
            <input type="text" class="input input-bordered input-sm spec-label" placeholder="z.B. Material" />
          </div>
          <div class="col-span-12 md:col-span-3 form-control">
            <label class="label">
              <span class="label-text font-medium text-sm">Schlüssel (eindeutig)</span>
            </label>
            <input type="text" class="input input-bordered input-sm spec-key" placeholder="z.B. material" />
          </div>
          <div class="col-span-12 md:col-span-4 form-control">
            <label class="label">
              <span class="label-text font-medium text-sm">Wert</span>
            </label>
            <input type="text" class="input input-bordered input-sm spec-value" placeholder="z.B. Polyester" />
          </div>
          <div class="col-span-12 md:col-span-1 form-control">
            <label class="label">
              <span class="label-text font-medium text-sm">Reihenfolge</span>
            </label>
            <input type="number" class="input input-bordered input-sm spec-order text-center" value="${specCount}" />
          </div>
          <div class="col-span-12 md:col-span-1 flex items-end">
            <button type="button" class="btn btn-error btn-sm btn-square remove-spec w-full">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    `;
    container?.appendChild(spec);
  });

  // Remove specification
  document.addEventListener('click', (e) => {
    if (e.target.closest('.remove-spec')) {
      const specRow = e.target.closest('.spec-row');
      specRow?.remove();

      // Show empty state if no specs remain
      const container = document.getElementById('specificationsContainer');
      if (container && container.querySelectorAll('.spec-row').length === 0) {
        container.innerHTML = `
          <div class="text-center py-12 text-base-content/50">
            <svg class="w-16 h-16 mx-auto mb-4 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <p class="text-sm font-medium">Noch keine Spezifikationen hinzugefügt</p>
            <p class="text-xs text-base-content/50 mt-1">Klicken Sie auf "Spezifikation hinzufügen", um zu beginnen</p>
          </div>
        `;
      }
    }
  });

  // Save specifications
  document.getElementById('saveSpecsBtn')?.addEventListener('click', async () => {
    const specRows = document.querySelectorAll('.spec-row');
    const specifications = [];

    specRows.forEach(row => {
      const specId = row.dataset.specId;
      const label = row.querySelector('.spec-label')?.value;
      const key = row.querySelector('.spec-key')?.value;
      const value = row.querySelector('.spec-value')?.value;
      const order = parseInt(row.querySelector('.spec-order')?.value) || 0;

      if (label && key && value) {
        specifications.push({
          id: specId !== 'new' ? specId : undefined,
          specKey: key,
          specLabel: label,
          specValue: value,
          displayOrder: order
        });
      }
    });

    try {
      const response = await fetch(`/api/admin/products/${productId}/specifications`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ specifications })
      });

      const result = await response.json();

      if (result.success) {
        // Show success toast
        const toast = document.createElement('div');
        toast.className = 'toast toast-end';
        toast.innerHTML = `
          <div class="alert alert-success">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Spezifikationen erfolgreich gespeichert!</span>
          </div>
        `;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);

        // Reload to update spec IDs
        setTimeout(() => window.location.reload(), 1500);
      } else {
        throw new Error(result.error?.message || 'Fehler beim Speichern der Spezifikationen');
      }
    } catch (error) {
      alert('Fehler beim Speichern der Spezifikationen: ' + error.message);
    }
  });

  // Delete button
  document.getElementById('deleteBtn')?.addEventListener('click', async () => {
    if (!confirm('Sind Sie sicher, dass Sie dieses Produkt deaktivieren möchten? Dies wird es im Frontend ausblenden.')) {
      return;
    }

    try {
      const response = await fetch(`/api/admin/products/${productId}`, {
        method: 'DELETE',
      });

      const result = await response.json();

      if (result.success) {
        window.location.href = '/admin/products';
      } else {
        throw new Error(result.error.message);
      }
    } catch (error) {
      alert('Fehler beim Löschen des Produkts: ' + error.message);
    }
  });
</script>
</AdminLayout>
