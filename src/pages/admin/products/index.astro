---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { pool } from '../../../lib/db';

// Note: Admin check is handled by middleware.ts
// If we reach here, user is already verified as admin

// Fetch all products
const client = await pool.connect();
try {
  var products = await client.query(`
    SELECT
      p.*,
      c.name as "categoryName",
      (SELECT COUNT(*) FROM "priceTiers" WHERE "productId" = p.id) as "tierCount"
    FROM products p
    LEFT JOIN categories c ON p."categoryId" = c.id
    ORDER BY p."createdAt" DESC
  `);
} finally {
  client.release();
}
---

<AdminLayout title="Product Management" currentPage="products">
  <div class="space-y-4">
      <!-- Page Header -->
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
        <div>
          <h1 class="text-2xl font-bold">Products</h1>
          <p class="text-sm text-base-content/60 mt-1">Manage your product catalog</p>
        </div>
        <a href="/admin/products/create" class="btn btn-muted-green btn-sm gap-2 shadow-md hover:shadow-lg transition-shadow">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          New Product
        </a>
      </div>

      <!-- Stats -->
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="stat bg-gradient-to-br from-base-100 to-base-200/30 border border-base-300/30 shadow-md rounded-xl p-4 hover:shadow-lg transition-shadow">
          <div class="stat-title text-xs">Total</div>
          <div class="stat-value text-2xl">{products.rows.length}</div>
        </div>
        <div class="stat bg-gradient-to-br from-base-100 to-base-200/30 border border-base-300/30 shadow-md rounded-xl p-4 hover:shadow-lg transition-shadow">
          <div class="stat-title text-xs">Active</div>
          <div class="stat-value text-2xl" style="color: var(--color-metrics-text);">{products.rows.filter(p => p.isActive).length}</div>
        </div>
        <div class="stat bg-gradient-to-br from-base-100 to-base-200/30 border border-base-300/30 shadow-md rounded-xl p-4 hover:shadow-lg transition-shadow">
          <div class="stat-title text-xs">Inactive</div>
          <div class="stat-value text-2xl" style="color: #EF4444;">{products.rows.filter(p => !p.isActive).length}</div>
        </div>
        <div class="stat bg-gradient-to-br from-base-100 to-base-200/30 border border-base-300/30 shadow-md rounded-xl p-4 hover:shadow-lg transition-shadow">
          <div class="stat-title text-xs">Featured</div>
          <div class="stat-value text-2xl" style="color: var(--color-yellow-accent-dark);">{products.rows.filter(p => p.isFeatured).length}</div>
        </div>
      </div>

      <!-- Products Table -->
      <div class="card bg-base-100 border border-base-300/30 shadow-xl rounded-2xl overflow-hidden">
        <div class="card-body p-0">
          <div class="overflow-x-auto">
            <table class="table table-sm">
              <thead class="bg-gradient-to-r from-base-200/50 to-base-100/50">
                <tr>
                  <th class="font-semibold">Product</th>
                  <th class="font-semibold">Category</th>
                  <th class="font-semibold">Price</th>
                  <th class="font-semibold">Type</th>
                  <th class="font-semibold">Status</th>
                  <th class="font-semibold text-right">Actions</th>
                </tr>
              </thead>
              <tbody>
                {products.rows.map((product) => (
                  <tr class="hover">
                    <td>
                      <div class="flex flex-col">
                        <span class="font-medium text-sm">{product.name}</span>
                        <span class="text-xs text-base-content/50">{product.sku || 'No SKU'}</span>
                      </div>
                    </td>
                    <td>
                      <span class="badge badge-ghost badge-sm">{product.categoryName}</span>
                    </td>
                    <td>
                      <span class="font-semibold text-sm">{parseFloat(product.basePrice).toFixed(2)}€</span>
                      {parseInt(product.tierCount) > 0 && (
                        <span class="text-xs text-base-content/50 ml-1">({product.tierCount} tiers)</span>
                      )}
                    </td>
                    <td>
                      <div class="flex flex-wrap gap-1">
                        {product.isBlockout && <span class="badge badge-secondary badge-xs">Blockout</span>}
                        {product.acceptsFileUpload && <span class="badge badge-xs" style="background-color: var(--color-yellow-accent); color: #1c1917; border-color: var(--color-yellow-accent);">Upload</span>}
                        {product.priceCalculationMethod && product.priceCalculationMethod !== 'per_piece' && (
                          <span class="badge badge-outline badge-xs">{product.priceCalculationMethod.replace('per_', '')}</span>
                        )}
                      </div>
                    </td>
                    <td>
                      <div class="flex flex-wrap gap-1">
                        <span class={`badge badge-xs ${product.isActive ? 'badge-success' : 'badge-error'}`}>
                          {product.isActive ? 'Active' : 'Inactive'}
                        </span>
                        {product.isFeatured && <span class="badge badge-xs" style="background-color: var(--color-yellow-accent); color: #1c1917; border-color: var(--color-yellow-accent);">Featured</span>}
                      </div>
                    </td>
                    <td>
                      <div class="flex gap-1 justify-end">
                        <a href={`/admin/products/${product.id}/edit`} class="btn btn-xs btn-ghost gap-1">
                          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                          </svg>
                          Edit
                        </a>
                        <a href={`/product/${product.slug}`} target="_blank" class="btn btn-xs btn-ghost gap-1">
                          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                          </svg>
                          View
                        </a>
                        <button
                          data-product-id={product.id}
                          data-is-active={product.isActive}
                          class="btn btn-xs btn-ghost gap-1 toggle-active-btn"
                          title={product.isActive ? 'Produkt deaktivieren' : 'Produkt aktivieren'}
                        >
                          {product.isActive ? (
                            <>
                              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                              </svg>
                              Deaktivieren
                            </>
                          ) : (
                            <>
                              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                              </svg>
                              Aktivieren
                            </>
                          )}
                        </button>
                        <button
                          data-product-id={product.id}
                          data-product-name={product.name}
                          class="btn btn-xs btn-error gap-1 delete-product-btn"
                          title="Produkt endgültig löschen"
                        >
                          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                          </svg>
                          Löschen
                        </button>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      </div>
  </div>

  <!-- Toggle Activation Modal -->
  <dialog id="toggleActiveModal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box max-w-2xl shadow-2xl border border-base-300/50">
      <!-- Modal Header -->
      <div class="flex items-center justify-between pb-5 mb-6 border-b border-base-300/20">
        <div class="flex items-center gap-3">
          <div id="toggleModalIcon" class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-primary">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
            </svg>
          </div>
          <div>
            <h3 class="font-bold text-xl text-base-content" id="toggleModalTitle">Produkt aktivieren</h3>
            <p class="text-sm text-base-content/60 mt-0.5" id="toggleModalSubtitle">Status des Produkts ändern</p>
          </div>
        </div>
        <form method="dialog">
          <button class="btn btn-sm btn-circle btn-ghost hover:bg-base-300 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </form>
      </div>

      <!-- Modal Content -->
      <div class="py-2">
        <p class="text-base text-base-content/80" id="toggleModalMessage">Möchten Sie dieses Produkt wirklich aktivieren?</p>
      </div>

      <!-- Modal Footer -->
      <div class="flex gap-3 pt-6 border-t border-base-300/30 mt-6">
        <button id="cancelToggleBtn" type="button" class="btn btn-ghost flex-1">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
          Abbrechen
        </button>
        <button id="confirmToggleBtn" type="button" class="btn btn-primary flex-1 gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
          </svg>
          Bestätigen
        </button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <!-- Delete Confirmation Modal -->
  <dialog id="deleteModal" class="modal modal-bottom sm:modal-middle">
    <div class="modal-box max-w-2xl shadow-2xl border border-base-300/50">
      <!-- Modal Header -->
      <div class="flex items-center justify-between pb-5 mb-6 border-b border-base-300/20">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-full bg-error/10 flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-error">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
            </svg>
          </div>
          <div>
            <h3 class="font-bold text-xl text-error">Produkt endgültig löschen</h3>
            <p class="text-sm text-base-content/60 mt-0.5">Diese Aktion kann nicht rückgängig gemacht werden</p>
          </div>
        </div>
        <form method="dialog">
          <button class="btn btn-sm btn-circle btn-ghost hover:bg-base-300 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </form>
      </div>

      <!-- Modal Content -->
      <div class="space-y-5">
        <!-- Product Name Warning -->
        <div class="bg-warning/10 border border-warning/20 rounded-lg p-4">
          <div class="flex items-start gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-warning flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <div class="flex-1">
              <p class="text-sm font-medium text-base-content mb-1">Sie sind dabei, folgendes Produkt zu löschen:</p>
              <p class="font-bold text-base text-base-content" id="deleteProductName"></p>
            </div>
          </div>
        </div>

        <!-- What will be deleted -->
        <div>
          <h4 class="text-sm font-semibold text-base-content mb-3 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" />
            </svg>
            Folgende Daten werden dauerhaft entfernt:
          </h4>
          <div class="bg-base-200/50 rounded-lg p-4">
            <ul class="list-none pl-0 space-y-2 text-sm text-base-content/80">
              <li class="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-error">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                </svg>
                Das Produkt selbst
              </li>
              <li class="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-error">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                </svg>
                Alle Produktbilder
              </li>
              <li class="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-error">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                </svg>
                Alle Preisstaffeln
              </li>
              <li class="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-error">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                </svg>
                Alle Spezifikationen
              </li>
              <li class="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-error">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                </svg>
                Alle Bewertungen
              </li>
              <li class="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-error">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
                </svg>
                Alle Verknüpfungen zu verwandten Produkten
              </li>
            </ul>
          </div>
        </div>

        <!-- Critical Warning -->
        <div class="bg-error/10 border border-error/20 rounded-lg p-4">
          <div class="flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-error flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <p class="text-sm font-bold text-error">Diese Aktion kann NICHT rückgängig gemacht werden!</p>
          </div>
        </div>

        <!-- Confirmation Input -->
        <div class="form-control">
          <label class="label">
            <span class="label-text font-medium">Geben Sie den Produktnamen zur Bestätigung ein:</span>
          </label>
          <input
            type="text"
            id="deleteConfirmInput"
            class="input input-bordered border-base-300/50 focus:border-error/50 focus:outline-none focus:ring-2 focus:ring-error/20"
            placeholder="Produktnamen eingeben"
            autocomplete="off"
          />
          <label class="label">
            <span class="label-text-alt text-base-content/50">Der Produktname muss exakt übereinstimmen</span>
          </label>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="flex gap-3 pt-6 border-t border-base-300/30 mt-6">
        <button id="cancelDeleteBtn" type="button" class="btn btn-ghost flex-1">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
          Abbrechen
        </button>
        <button id="confirmDeleteBtn" type="button" class="btn btn-error flex-1 gap-2" disabled>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
          <span id="deleteButtonText">Endgültig löschen</span>
        </button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>
</AdminLayout>

<script>
  // Handle toggle activation button clicks
  document.addEventListener('DOMContentLoaded', () => {
    const toggleActiveModal = document.getElementById('toggleActiveModal');
    const toggleModalIcon = document.getElementById('toggleModalIcon');
    const toggleModalTitle = document.getElementById('toggleModalTitle');
    const toggleModalSubtitle = document.getElementById('toggleModalSubtitle');
    const toggleModalMessage = document.getElementById('toggleModalMessage');
    const confirmToggleBtn = document.getElementById('confirmToggleBtn');
    const cancelToggleBtn = document.getElementById('cancelToggleBtn');

    const deleteModal = document.getElementById('deleteModal');
    const deleteProductName = document.getElementById('deleteProductName');
    const deleteConfirmInput = document.getElementById('deleteConfirmInput');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const deleteButtonText = document.getElementById('deleteButtonText');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');

    let currentToggleButton = null;
    let currentDeleteButton = null;
    let expectedProductName = '';

    // Toggle activation buttons
    const toggleButtons = document.querySelectorAll('.toggle-active-btn');
    toggleButtons.forEach(button => {
      button.addEventListener('click', (e) => {
        e.preventDefault();
        const isActive = button.getAttribute('data-is-active') === 'true';

        if (isActive) {
          // Deactivate
          toggleModalTitle.textContent = 'Produkt deaktivieren';
          toggleModalSubtitle.textContent = 'Das Produkt wird im Frontend ausgeblendet';
          toggleModalMessage.textContent = 'Möchten Sie dieses Produkt wirklich deaktivieren?';
          toggleModalIcon.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-warning">
              <path stroke-linecap="round" stroke-linejoin="round" d="M18.364 18.364A9 9 0 0 0 5.636 5.636m12.728 12.728A9 9 0 0 1 5.636 5.636m12.728 12.728L5.636 5.636" />
            </svg>
          `;
          toggleModalIcon.className = 'w-10 h-10 rounded-full bg-warning/10 flex items-center justify-center';
        } else {
          // Activate
          toggleModalTitle.textContent = 'Produkt aktivieren';
          toggleModalSubtitle.textContent = 'Das Produkt wird im Frontend sichtbar';
          toggleModalMessage.textContent = 'Möchten Sie dieses Produkt wirklich aktivieren?';
          toggleModalIcon.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-success">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
            </svg>
          `;
          toggleModalIcon.className = 'w-10 h-10 rounded-full bg-success/10 flex items-center justify-center';
        }

        currentToggleButton = button;
        toggleActiveModal.showModal();
      });
    });

    // Confirm toggle action
    confirmToggleBtn.addEventListener('click', async () => {
      if (!currentToggleButton) return;

      const productId = currentToggleButton.getAttribute('data-product-id');
      const isActive = currentToggleButton.getAttribute('data-is-active') === 'true';
      const actionGerman = isActive ? 'deaktivieren' : 'aktivieren';

      try {
        currentToggleButton.disabled = true;
        currentToggleButton.classList.add('loading');
        confirmToggleBtn.disabled = true;
        confirmToggleBtn.classList.add('loading');

        const response = await fetch(`/api/admin/products/${productId}/toggle-active`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
        });

        const result = await response.json();

        if (result.success) {
          toggleActiveModal.close();
          window.location.reload();
        } else {
          throw new Error(result.error?.message || 'Unbekannter Fehler');
        }
      } catch (error) {
        console.error(`Error toggling product:`, error);
        alert(`Fehler beim ${actionGerman} des Produkts: ${error.message}`);
        currentToggleButton.disabled = false;
        currentToggleButton.classList.remove('loading');
        confirmToggleBtn.disabled = false;
        confirmToggleBtn.classList.remove('loading');
        toggleActiveModal.close();
      }
    });

    // Cancel toggle action
    cancelToggleBtn.addEventListener('click', () => {
      toggleActiveModal.close();
      currentToggleButton = null;
    });

    // Delete buttons
    const deleteButtons = document.querySelectorAll('.delete-product-btn');
    deleteButtons.forEach(button => {
      button.addEventListener('click', (e) => {
        e.preventDefault();
        const productName = button.getAttribute('data-product-name');

        deleteProductName.textContent = productName;
        deleteConfirmInput.value = '';
        confirmDeleteBtn.disabled = true;
        currentDeleteButton = button;
        expectedProductName = productName;

        deleteModal.showModal();
      });
    });

    // Enable delete button when product name matches
    deleteConfirmInput.addEventListener('input', (e) => {
      confirmDeleteBtn.disabled = e.target.value !== expectedProductName;
    });

    // Confirm delete action
    confirmDeleteBtn.addEventListener('click', async () => {
      if (!currentDeleteButton) return;

      const productId = currentDeleteButton.getAttribute('data-product-id');

      try {
        currentDeleteButton.disabled = true;
        currentDeleteButton.classList.add('loading');
        confirmDeleteBtn.disabled = true;
        confirmDeleteBtn.classList.add('loading');
        deleteButtonText.textContent = 'Wird gelöscht...';

        const response = await fetch(`/api/admin/products/${productId}/hard-delete`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
          },
        });

        const result = await response.json();

        if (result.success) {
          deleteModal.close();
          // Show success message briefly before reload
          const successDiv = document.createElement('div');
          successDiv.className = 'toast toast-bottom toast-start';
          successDiv.innerHTML = `
            <div class="alert alert-success">
              <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span>Produkt wurde erfolgreich gelöscht.</span>
            </div>
          `;
          document.body.appendChild(successDiv);
          setTimeout(() => window.location.reload(), 1000);
        } else {
          throw new Error(result.error?.message || 'Unbekannter Fehler');
        }
      } catch (error) {
        console.error('Error deleting product:', error);
        alert(`Fehler beim Löschen des Produkts: ${error.message}`);
        currentDeleteButton.disabled = false;
        currentDeleteButton.classList.remove('loading');
        confirmDeleteBtn.disabled = false;
        confirmDeleteBtn.classList.remove('loading');
        deleteButtonText.textContent = 'Endgültig löschen';
        deleteModal.close();
      }
    });

    // Cancel delete action
    cancelDeleteBtn.addEventListener('click', () => {
      deleteModal.close();
      currentDeleteButton = null;
      expectedProductName = '';
      deleteConfirmInput.value = '';
    });

    // Reset state when modals are closed
    toggleActiveModal.addEventListener('close', () => {
      currentToggleButton = null;
      confirmToggleBtn.disabled = false;
      confirmToggleBtn.classList.remove('loading');
    });

    deleteModal.addEventListener('close', () => {
      currentDeleteButton = null;
      expectedProductName = '';
      deleteConfirmInput.value = '';
      confirmDeleteBtn.disabled = true;
      confirmDeleteBtn.classList.remove('loading');
      deleteButtonText.textContent = 'Endgültig löschen';
    });
  });
</script>

<style>
  /* Modern Modal Animations */
  .modal[open] .modal-box {
    animation: modal-slide-in 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  @keyframes modal-slide-in {
    from {
      transform: translateY(-20px) scale(0.95);
      opacity: 0;
    }
    to {
      transform: translateY(0) scale(1);
      opacity: 1;
    }
  }

  /* Enhanced Modal Backdrop */
  .modal-backdrop {
    backdrop-filter: blur(4px);
    background-color: rgba(0, 0, 0, 0.5);
  }

  /* Enhanced Input Borders */
  .modal-box .input,
  .modal-box .select,
  .modal-box .textarea {
    border-width: 1.5px;
    transition: all 0.2s ease;
  }

  .modal-box .input:hover,
  .modal-box .select:hover,
  .modal-box .textarea:hover {
    border-color: hsl(var(--bc) / 0.25);
  }

  /* Input Focus Enhancements */
  .modal-box .input:focus,
  .modal-box .select:focus,
  .modal-box .textarea:focus {
    transform: translateY(-1px);
    border-width: 1.5px;
    box-shadow: 0 0 0 3px hsl(var(--p) / 0.1), 0 2px 8px rgba(0, 0, 0, 0.08);
    outline: none;
  }

  /* Smooth Transitions for buttons */
  .btn {
    transition: all 0.2s ease;
  }

  .btn:hover {
    transform: translateY(-1px);
  }

  .btn:active {
    transform: translateY(0);
  }

  /* Toast animations */
  @keyframes toast-pop {
    0% {
      transform: scale(0.9);
      opacity: 0;
    }
    50% {
      transform: scale(1.05);
    }
    100% {
      transform: scale(1);
      opacity: 1;
    }
  }

  .toast {
    animation: toast-pop 0.3s ease-out;
  }
</style>
