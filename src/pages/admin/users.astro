---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { getAllUsers } from '../../lib/db';
import { getCachedUsers, setCachedUsers } from '../../lib/redis';

// Try to get users from cache first
let users = await getCachedUsers();

if (!users) {
  users = await getAllUsers();
  // Cache for 1 minute
  await setCachedUsers(users);
}

// Sort users by creation date (newest first)
users.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
---

<AdminLayout title="Benutzerverwaltung" currentPage="users">
  <!-- Page Header -->
  <div class="mb-8">
    <h2 class="text-3xl font-bold text-base-content mb-2">Benutzerverwaltung</h2>
    <p class="text-base-content/60">Verwalten Sie Benutzer und deren Berechtigungen</p>
  </div>

  <!-- Stats Overview -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
    <div class="stat bg-gradient-to-br from-base-100 to-base-200/30 border border-base-300/30 rounded-xl shadow-md hover:shadow-lg transition-shadow">
      <div class="stat-title">Gesamt</div>
      <div class="stat-value" style="color: var(--color-metrics-text);">{users.length}</div>
      <div class="stat-desc">Registrierte Benutzer</div>
    </div>
    <div class="stat bg-gradient-to-br from-base-100 to-base-200/30 border border-base-300/30 rounded-xl shadow-md hover:shadow-lg transition-shadow">
      <div class="stat-title">Verifiziert</div>
      <div class="stat-value" style="color: var(--color-metrics-text);">{users.filter(u => u.emailVerified).length}</div>
      <div class="stat-desc">E-Mail bestätigt</div>
    </div>
    <div class="stat bg-gradient-to-br from-base-100 to-base-200/30 border border-base-300/30 rounded-xl shadow-md hover:shadow-lg transition-shadow">
      <div class="stat-title">Admins</div>
      <div class="stat-value" style="color: var(--color-yellow-accent-dark);">{users.filter(u => u.isAdmin).length}</div>
      <div class="stat-desc">Mit Admin-Rechten</div>
    </div>
    <div class="stat bg-gradient-to-br from-base-100 to-base-200/30 border border-base-300/30 rounded-xl shadow-md hover:shadow-lg transition-shadow">
      <div class="stat-title">Gesperrt</div>
      <div class="stat-value" style="color: #EF4444;">{users.filter(u => u.accountLocked).length}</div>
      <div class="stat-desc">Konto gesperrt</div>
    </div>
  </div>

  <!-- Users Table -->
  <div class="card bg-base-100 border border-base-300/30 shadow-xl rounded-2xl overflow-hidden">
    <div class="card-body">
      <div class="overflow-x-auto">
        <table class="table table-zebra">
          <thead>
            <tr>
              <th>Benutzer</th>
              <th>Status</th>
              <th>Rolle</th>
              <th>Gewerbetreibender</th>
              <th>USt-IdNr.</th>
              <th>Rabatt</th>
              <th>Registriert</th>
              <th>Letzter Login</th>
              <th>Aktionen</th>
            </tr>
          </thead>
          <tbody>
            {users.map((user) => (
              <tr>
                <td>
                  <div class="flex items-center gap-3">
                    <div class="avatar placeholder">
                      <div class="bg-neutral text-neutral-content rounded-full w-10">
                        <span class="text-sm">{user.name.charAt(0).toUpperCase()}</span>
                      </div>
                    </div>
                    <div>
                      <div class="font-bold">{user.name}</div>
                      <div class="text-sm opacity-50">{user.email}</div>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="flex flex-col gap-1">
                    {user.emailVerified ? (
                      <span class="badge badge-success badge-sm gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                        </svg>
                        Verifiziert
                      </span>
                    ) : (
                      <span class="badge badge-warning badge-sm gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" />
                        </svg>
                        Unbestätigt
                      </span>
                    )}
                    {user.accountLocked && (
                      <span class="badge badge-error badge-sm gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" />
                        </svg>
                        Gesperrt
                      </span>
                    )}
                  </div>
                </td>
                <td>
                  {user.isAdmin ? (
                    <span class="badge badge-primary gap-1">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456ZM16.894 20.567 16.5 21.75l-.394-1.183a2.25 2.25 0 0 0-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 0 0 1.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 0 0 1.423 1.423l1.183.394-1.183.394a2.25 2.25 0 0 0-1.423 1.423Z" />
                      </svg>
                      Admin
                    </span>
                  ) : (
                    <span class="badge badge-ghost">Benutzer</span>
                  )}
                </td>
                <td>
                  {user.gewerbebetreiber ? (
                    <span class="badge badge-success badge-sm gap-1">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                      </svg>
                      Ja
                    </span>
                  ) : (
                    <span class="badge badge-ghost badge-sm">Nein</span>
                  )}
                </td>
                <td>
                  {user.umsatzsteuernummer ? (
                    <span class="text-sm font-mono">{user.umsatzsteuernummer}</span>
                  ) : (
                    <span class="text-sm opacity-50">-</span>
                  )}
                </td>
                <td>
                  {user.discountPercent > 0 ? (
                    <span class="badge badge-accent badge-sm">{user.discountPercent}%</span>
                  ) : (
                    <span class="text-sm opacity-50">-</span>
                  )}
                </td>
                <td>
                  <div class="text-sm">
                    {new Date(user.createdAt).toLocaleDateString('de-DE', {
                      year: 'numeric',
                      month: 'short',
                      day: 'numeric'
                    })}
                  </div>
                </td>
                <td>
                  {user.lastLoginAt ? (
                    <div class="text-sm">
                      {new Date(user.lastLoginAt).toLocaleDateString('de-DE', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                      })}
                    </div>
                  ) : (
                    <span class="text-sm opacity-50">Nie</span>
                  )}
                </td>
                <td>
                  <a href={`/admin/users/${user.id}`} class="btn btn-ghost btn-sm gap-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                    </svg>
                    Details
                  </a>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Info Notice -->
  <div class="alert alert-admin mt-6">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z"></path></svg>
    <div>
      <div class="font-bold">Benutzerdetails</div>
      <div class="text-sm">Klicken Sie auf "Details" um alle Benutzerdaten einzusehen und individuelle Rabatte festzulegen. Admin-Status und Kontosperrungen können nur direkt über die Datenbank geändert werden.</div>
    </div>
  </div>
</AdminLayout>
