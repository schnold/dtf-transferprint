---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { getAllUsers } from '../../lib/db';
import { getCachedUsers, setCachedUsers } from '../../lib/redis';

// Try to get users from cache first
let users = await getCachedUsers();

if (!users) {
  users = await getAllUsers();
  // Cache for 1 minute
  await setCachedUsers(users);
}

// Sort users by creation date (newest first)
users.sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime());
---

<AdminLayout title="Benutzerverwaltung" currentPage="users">
  <!-- Page Header -->
  <div class="mb-8">
    <h2 class="text-3xl font-bold text-base-content mb-2">Benutzerverwaltung</h2>
    <p class="text-base-content/60">Verwalten Sie Benutzer und deren Berechtigungen</p>
  </div>

  <!-- Stats Overview -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
    <div class="stat bg-base-100 rounded-lg shadow">
      <div class="stat-title">Gesamt</div>
      <div class="stat-value text-primary">{users.length}</div>
      <div class="stat-desc">Registrierte Benutzer</div>
    </div>
    <div class="stat bg-base-100 rounded-lg shadow">
      <div class="stat-title">Verifiziert</div>
      <div class="stat-value text-success">{users.filter(u => u.emailVerified).length}</div>
      <div class="stat-desc">E-Mail bestätigt</div>
    </div>
    <div class="stat bg-base-100 rounded-lg shadow">
      <div class="stat-title">Admins</div>
      <div class="stat-value text-warning">{users.filter(u => u.isAdmin).length}</div>
      <div class="stat-desc">Mit Admin-Rechten</div>
    </div>
    <div class="stat bg-base-100 rounded-lg shadow">
      <div class="stat-title">Gesperrt</div>
      <div class="stat-value text-error">{users.filter(u => u.accountLocked).length}</div>
      <div class="stat-desc">Konto gesperrt</div>
    </div>
  </div>

  <!-- Users Table -->
  <div class="card bg-base-100 shadow-md">
    <div class="card-body">
      <div class="overflow-x-auto">
        <table class="table table-zebra">
          <thead>
            <tr>
              <th>Benutzer</th>
              <th>Status</th>
              <th>Rolle</th>
              <th>Registriert</th>
              <th>Letzter Login</th>
              <th>Benutzer-ID</th>
            </tr>
          </thead>
          <tbody>
            {users.map((user) => (
              <tr>
                <td>
                  <div class="flex items-center gap-3">
                    <div class="avatar placeholder">
                      <div class="bg-neutral text-neutral-content rounded-full w-10">
                        <span class="text-sm">{user.name.charAt(0).toUpperCase()}</span>
                      </div>
                    </div>
                    <div>
                      <div class="font-bold">{user.name}</div>
                      <div class="text-sm opacity-50">{user.email}</div>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="flex flex-col gap-1">
                    {user.emailVerified ? (
                      <span class="badge badge-success badge-sm gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                        </svg>
                        Verifiziert
                      </span>
                    ) : (
                      <span class="badge badge-warning badge-sm gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" />
                        </svg>
                        Unbestätigt
                      </span>
                    )}
                    {user.accountLocked && (
                      <span class="badge badge-error badge-sm gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 1 0-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 0 0 2.25-2.25v-6.75a2.25 2.25 0 0 0-2.25-2.25H6.75a2.25 2.25 0 0 0-2.25 2.25v6.75a2.25 2.25 0 0 0 2.25 2.25Z" />
                        </svg>
                        Gesperrt
                      </span>
                    )}
                  </div>
                </td>
                <td>
                  {user.isAdmin ? (
                    <span class="badge badge-primary gap-1">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456ZM16.894 20.567 16.5 21.75l-.394-1.183a2.25 2.25 0 0 0-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 0 0 1.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 0 0 1.423 1.423l1.183.394-1.183.394a2.25 2.25 0 0 0-1.423 1.423Z" />
                      </svg>
                      Admin
                    </span>
                  ) : (
                    <span class="badge badge-ghost">Benutzer</span>
                  )}
                </td>
                <td>
                  <div class="text-sm">
                    {new Date(user.createdAt).toLocaleDateString('de-DE', {
                      year: 'numeric',
                      month: 'short',
                      day: 'numeric'
                    })}
                  </div>
                </td>
                <td>
                  {user.lastLoginAt ? (
                    <div class="text-sm">
                      {new Date(user.lastLoginAt).toLocaleDateString('de-DE', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                      })}
                    </div>
                  ) : (
                    <span class="text-sm opacity-50">Nie</span>
                  )}
                </td>
                <td>
                  <div class="text-xs text-base-content/50">
                    ID: {user.id.substring(0, 8)}...
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Security Notice -->
  <div class="alert alert-warning mt-6">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
    <div>
      <div class="font-bold">Schreibgeschützte Ansicht</div>
      <div class="text-sm">Admin-Status und Kontosperrungen können nur direkt über die Datenbank geändert werden. Dies dient der Sicherheit und verhindert unbefugte Rechteänderungen.</div>
    </div>
  </div>
</AdminLayout>
