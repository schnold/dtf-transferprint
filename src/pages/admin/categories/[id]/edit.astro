---
import AdminLayout from '../../../../layouts/AdminLayout.astro';
import { pool } from '../../../../lib/db';

// Note: Admin check is handled by middleware.ts
const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/admin/categories');
}

const client = await pool.connect();
try {
  // Fetch the category to edit
  const categoryResult = await client.query(
    `SELECT * FROM categories WHERE id = $1`,
    [id]
  );

  if (categoryResult.rows.length === 0) {
    return Astro.redirect('/admin/categories');
  }

  var category = categoryResult.rows[0];

  // Fetch all categories for parent selection (excluding this category and its descendants)
  var categories = await client.query(`
    WITH RECURSIVE category_tree AS (
      SELECT
        id,
        name,
        "parentId",
        0 as level,
        name::text as path
      FROM categories
      WHERE "parentId" IS NULL AND id != $1

      UNION ALL

      SELECT
        c.id,
        c.name,
        c."parentId",
        ct.level + 1,
        ct.path || ' > ' || c.name
      FROM categories c
      INNER JOIN category_tree ct ON c."parentId" = ct.id
      WHERE c.id != $1
    )
    SELECT * FROM category_tree
    ORDER BY path
  `, [id]);
} finally {
  client.release();
}

// Available icons for selection
const availableIcons = [
  { value: 'box', label: 'Box (Standard)', svg: 'M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z' },
  { value: 'layers', label: 'Layers (Blockout)', svg: 'M6.429 9.75L2.25 12l4.179 2.25m0-4.5l5.571 3 5.571-3m-11.142 0L2.25 7.5l4.179-2.25m11.142 0L21.75 7.5l-4.179 2.25m0 0L21.75 12l-4.179 2.25m0 0l4.179 2.25L21.75 16.5l-4.179-2.25m-11.142 0l-4.179 2.25L2.25 16.5l4.179-2.25' },
  { value: 'folder', label: 'Folder', svg: 'M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z' },
  { value: 'document', label: 'Document', svg: 'M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z' },
  { value: 'building', label: 'Building', svg: 'M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M6.75 21v-3.375c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21M3 3h12m-.75 4.5H21m-3.75 3.75h.008v.008h-.008v-.008zm0 3h.008v.008h-.008v-.008zm0 3h.008v.008h-.008v-.008z' },
  { value: 'book', label: 'Book', svg: 'M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25' },
  { value: 'question', label: 'Question (Support)', svg: 'M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z' },
  { value: 'plus', label: 'Plus', svg: 'M12 4.5v15m7.5-7.5h-15' },
  { value: 'star', label: 'Star', svg: 'M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z' },
  { value: 'tag', label: 'Tag', svg: 'M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z' },
];
---

<AdminLayout title="Edit Category" currentPage="categories">
  <div class="max-w-4xl mx-auto">
    <div class="mb-6">
      <h1 class="text-3xl font-bold">Kategorie bearbeiten</h1>
      <p class="text-base-content/60 mt-1">Aktualisieren Sie die Kategorie "{category.name}"</p>
    </div>

    <form id="categoryForm" class="space-y-6">
      <!-- Basic Information -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <h2 class="card-title">Grundinformationen</h2>

          <div class="form-control">
            <label class="label">
              <span class="label-text">Kategoriename *</span>
            </label>
            <input
              type="text"
              name="name"
              required
              class="input input-bordered"
              placeholder="DTF Transfer"
              id="categoryName"
              value={category.name}
            />
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text">Slug *</span>
              <span class="label-text-alt">URL-freundlicher Identifier</span>
            </label>
            <input
              type="text"
              name="slug"
              required
              class="input input-bordered"
              placeholder="dtf-transfer"
              id="categorySlug"
              value={category.slug}
            />
            <label class="label">
              <span class="label-text-alt">Wird automatisch aus dem Namen generiert</span>
            </label>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text">Beschreibung</span>
            </label>
            <textarea
              name="description"
              class="textarea textarea-bordered h-24"
              placeholder="Optionale Beschreibung der Kategorie"
            >{category.description || ''}</textarea>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text">Übergeordnete Kategorie</span>
              <span class="label-text-alt">Leer lassen für Hauptkategorie</span>
            </label>
            <select name="parentId" class="select select-bordered">
              <option value="">Keine (Hauptkategorie)</option>
              {categories.rows.map((cat) => (
                <option value={cat.id} selected={cat.id === category.parentId}>
                  {[...Array(cat.level)].map(() => '  ')} {cat.name}
                </option>
              ))}
            </select>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text">Anzeigereihenfolge</span>
              <span class="label-text-alt">Niedrigere Zahlen erscheinen zuerst</span>
            </label>
            <input
              type="number"
              name="displayOrder"
              value={category.displayOrder || 0}
              class="input input-bordered"
              placeholder="0"
            />
          </div>
        </div>
      </div>

      <!-- Icon Selection -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <h2 class="card-title">Icon für Navbar-Menü</h2>
          <p class="text-sm text-base-content/60 mb-4">Wählen Sie ein Icon, das in der Navbar-Dropdown-Menü angezeigt wird</p>

          <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
            {availableIcons.map((icon) => (
              <label class="cursor-pointer">
                <input
                  type="radio"
                  name="icon"
                  value={icon.value}
                  class="peer sr-only"
                  checked={category.icon === icon.value}
                />
                <div class="flex flex-col items-center gap-2 p-4 rounded-lg border-2 border-base-300 peer-checked:border-primary peer-checked:bg-primary/10 hover:bg-base-200 transition-all">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                    <path stroke-linecap="round" stroke-linejoin="round" d={icon.svg} />
                  </svg>
                  <span class="text-xs font-medium text-center">{icon.label}</span>
                </div>
              </label>
            ))}
          </div>
        </div>
      </div>

      <!-- Media -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <h2 class="card-title">Bild</h2>

          <div class="form-control">
            <label class="label">
              <span class="label-text">Bild-URL</span>
              <span class="label-text-alt">Optional</span>
            </label>
            <input
              type="url"
              name="imageUrl"
              class="input input-bordered"
              placeholder="https://example.com/image.jpg"
              value={category.imageUrl || ''}
            />
          </div>
        </div>
      </div>

      <!-- Status -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <h2 class="card-title">Status</h2>

          <div class="form-control">
            <label class="label cursor-pointer">
              <span class="label-text">Kategorie aktivieren</span>
              <input
                type="checkbox"
                name="isActive"
                checked={category.isActive}
                class="checkbox checkbox-success"
              />
            </label>
          </div>
        </div>
      </div>

      <!-- Submit -->
      <div class="flex gap-4">
        <button type="submit" class="btn btn-primary flex-1">Änderungen speichern</button>
        <a href="/admin/categories" class="btn btn-ghost">Abbrechen</a>
      </div>
    </form>
  </div>

  <script define:vars={{ categoryId: id }}>
    // Auto-generate slug from name
    const nameInput = document.getElementById('categoryName');
    const slugInput = document.getElementById('categorySlug');

    nameInput.addEventListener('input', (e) => {
      const slug = e.target.value
        .toLowerCase()
        .replace(/ä/g, 'ae')
        .replace(/ö/g, 'oe')
        .replace(/ü/g, 'ue')
        .replace(/ß/g, 'ss')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
      slugInput.value = slug;
    });

    // Form submission
    document.getElementById('categoryForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(e.target);
      const data = {
        name: formData.get('name'),
        slug: formData.get('slug'),
        description: formData.get('description') || null,
        parentId: formData.get('parentId') || null,
        displayOrder: parseInt(formData.get('displayOrder')) || 0,
        icon: formData.get('icon') || null,
        imageUrl: formData.get('imageUrl') || null,
        isActive: formData.get('isActive') === 'on',
      };

      try {
        const response = await fetch(`/api/admin/categories/${categoryId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (result.success) {
          alert('Kategorie erfolgreich aktualisiert!');
          window.location.href = '/admin/categories';
        } else {
          alert('Fehler: ' + result.error.message);
        }
      } catch (error) {
        alert('Fehler beim Aktualisieren der Kategorie: ' + error.message);
      }
    });
  </script>
</AdminLayout>
