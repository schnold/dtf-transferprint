---
import AdminLayout from '../../../../layouts/AdminLayout.astro';
import { pool } from '../../../../lib/db';
import { CATEGORY_ICONS, getIconsByCategory, getIcon } from '../../../../constants/icons';

// Note: Admin check is handled by middleware.ts
const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/admin/categories');
}

const client = await pool.connect();
try {
  // Fetch the category to edit
  const categoryResult = await client.query(
    `SELECT * FROM categories WHERE id = $1`,
    [id]
  );

  if (categoryResult.rows.length === 0) {
    return Astro.redirect('/admin/categories');
  }

  var category = categoryResult.rows[0];

  // Fetch all categories for parent selection (excluding this category and its descendants)
  var categories = await client.query(`
    WITH RECURSIVE category_tree AS (
      SELECT
        id,
        name,
        "parentId",
        0 as level,
        name::text as path
      FROM categories
      WHERE "parentId" IS NULL AND id != $1

      UNION ALL

      SELECT
        c.id,
        c.name,
        c."parentId",
        ct.level + 1,
        ct.path || ' > ' || c.name
      FROM categories c
      INNER JOIN category_tree ct ON c."parentId" = ct.id
      WHERE c.id != $1
    )
    SELECT * FROM category_tree
    ORDER BY path
  `, [id]);
} finally {
  client.release();
}

// Get current icon or default to box
const currentIcon = getIcon(category.icon || 'box') || getIcon('box')!;
---

<AdminLayout title="Edit Category" currentPage="categories">
  <div class="max-w-4xl mx-auto">
    <div class="mb-6">
      <h1 class="text-3xl font-bold">Kategorie bearbeiten</h1>
      <p class="text-base-content/60 mt-1">Aktualisieren Sie die Kategorie "{category.name}"</p>
    </div>

    <form id="categoryForm" class="space-y-6">
      <!-- Basic Information -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <h2 class="card-title">Grundinformationen</h2>

          <div class="form-control">
            <label class="label">
              <span class="label-text">Kategoriename *</span>
            </label>
            <input
              type="text"
              name="name"
              required
              class="input input-bordered"
              placeholder="DTF Transfer"
              id="categoryName"
              value={category.name}
            />
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text">Slug *</span>
              <span class="label-text-alt">URL-freundlicher Identifier</span>
            </label>
            <input
              type="text"
              name="slug"
              required
              class="input input-bordered"
              placeholder="dtf-transfer"
              id="categorySlug"
              value={category.slug}
            />
            <label class="label">
              <span class="label-text-alt">Wird automatisch aus dem Namen generiert</span>
            </label>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text">Beschreibung</span>
            </label>
            <textarea
              name="description"
              class="textarea textarea-bordered h-24"
              placeholder="Optionale Beschreibung der Kategorie"
            >{category.description || ''}</textarea>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text">Übergeordnete Kategorie</span>
              <span class="label-text-alt">Leer lassen für Hauptkategorie</span>
            </label>
            <select name="parentId" class="select select-bordered">
              <option value="">Keine (Hauptkategorie)</option>
              {categories.rows.map((cat) => (
                <option value={cat.id} selected={cat.id === category.parentId}>
                  {[...Array(cat.level)].map(() => '  ')} {cat.name}
                </option>
              ))}
            </select>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text">Anzeigereihenfolge</span>
              <span class="label-text-alt">Niedrigere Zahlen erscheinen zuerst</span>
            </label>
            <input
              type="number"
              name="displayOrder"
              value={category.displayOrder || 0}
              class="input input-bordered"
              placeholder="0"
            />
          </div>
        </div>
      </div>

      <!-- Icon Selection -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <h2 class="card-title">Icon für Navbar-Menü</h2>
          <p class="text-sm text-base-content/60 mb-4">Wählen Sie ein Icon, das in der Navbar-Dropdown-Menü angezeigt wird</p>

          <div class="form-control">
            <label class="label">
              <span class="label-text">Icon auswählen</span>
            </label>
            <div class="dropdown dropdown-bottom w-full">
              <label tabindex="0" class="btn btn-outline w-full justify-between" id="iconSelectButton">
                <span class="flex items-center gap-2">
                  <svg id="selectedIconPreview" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d={currentIcon.svg} />
                  </svg>
                  <span id="selectedIconLabel">{currentIcon.label}</span>
                </span>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                </svg>
              </label>
              <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded-box z-[1] w-full max-h-96 overflow-y-auto shadow-lg border border-base-300 p-2">
                {Object.entries(getIconsByCategory()).map(([category, icons]) => {
                  return (
                    <>
                      <li class="menu-title">
                        <span>{category}</span>
                      </li>
                      {icons.map((icon) => (
                        <li>
                          <a
                            class="icon-option flex items-center gap-3"
                            data-icon-value={icon.value}
                            data-icon-svg={icon.svg}
                            data-icon-label={icon.label}
                          >
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                              <path stroke-linecap="round" stroke-linejoin="round" d={icon.svg} />
                            </svg>
                            <span>{icon.label}</span>
                          </a>
                        </li>
                      ))}
                    </>
                  );
                })}
              </ul>
            </div>
            <input type="hidden" name="icon" id="iconInput" value={category.icon || 'box'} />
          </div>
        </div>
      </div>

      <!-- Media -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <h2 class="card-title">Bild</h2>

          <div class="form-control">
            <label class="label">
              <span class="label-text">Bild-URL</span>
              <span class="label-text-alt">Optional</span>
            </label>
            <input
              type="url"
              name="imageUrl"
              class="input input-bordered"
              placeholder="https://example.com/image.jpg"
              value={category.imageUrl || ''}
            />
          </div>
        </div>
      </div>

      <!-- Status -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <h2 class="card-title">Status</h2>

          <div class="form-control">
            <label class="label cursor-pointer">
              <span class="label-text">Kategorie aktivieren</span>
              <input
                type="checkbox"
                name="isActive"
                checked={category.isActive}
                class="checkbox checkbox-success"
              />
            </label>
          </div>
        </div>
      </div>

      <!-- Submit -->
      <div class="flex gap-4">
        <button type="submit" class="btn btn-primary flex-1">Änderungen speichern</button>
        <a href="/admin/categories" class="btn btn-ghost">Abbrechen</a>
      </div>
    </form>
  </div>

  <script define:vars={{ categoryId: id }}>
    // Auto-generate slug from name
    const nameInput = document.getElementById('categoryName');
    const slugInput = document.getElementById('categorySlug');

    nameInput.addEventListener('input', (e) => {
      const slug = e.target.value
        .toLowerCase()
        .replace(/ä/g, 'ae')
        .replace(/ö/g, 'oe')
        .replace(/ü/g, 'ue')
        .replace(/ß/g, 'ss')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
      slugInput.value = slug;
    });

    // Icon dropdown selection handler
    document.querySelectorAll('.icon-option').forEach(option => {
      option.addEventListener('click', (e) => {
        e.preventDefault();
        const iconValue = option.getAttribute('data-icon-value');
        const iconSvg = option.getAttribute('data-icon-svg');
        const iconLabel = option.getAttribute('data-icon-label');
        
        // Update hidden input
        document.getElementById('iconInput').value = iconValue;
        
        // Update button preview
        const preview = document.getElementById('selectedIconPreview');
        const label = document.getElementById('selectedIconLabel');
        if (preview) {
          preview.querySelector('path').setAttribute('d', iconSvg);
        }
        if (label) {
          label.textContent = iconLabel;
        }
        
        // Close dropdown
        document.querySelector('.dropdown').blur();
      });
    });

    // Form submission
    document.getElementById('categoryForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(e.target);
      const data = {
        name: formData.get('name'),
        slug: formData.get('slug'),
        description: formData.get('description') || null,
        parentId: formData.get('parentId') || null,
        displayOrder: parseInt(formData.get('displayOrder')) || 0,
        icon: formData.get('icon') || null,
        imageUrl: formData.get('imageUrl') || null,
        isActive: formData.get('isActive') === 'on',
      };

      try {
        const response = await fetch(`/api/admin/categories/${categoryId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (result.success) {
          alert('Kategorie erfolgreich aktualisiert!');
          window.location.href = '/admin/categories';
        } else {
          alert('Fehler: ' + result.error.message);
        }
      } catch (error) {
        alert('Fehler beim Aktualisieren der Kategorie: ' + error.message);
      }
    });
  </script>
</AdminLayout>
