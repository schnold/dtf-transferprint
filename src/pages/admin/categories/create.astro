---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { pool } from '../../../lib/db';
import { CATEGORY_ICONS, getIconsByCategory } from '../../../constants/icons';

// Note: Admin check is handled by middleware.ts
// If we reach here, user is already verified as admin

// Fetch all categories for parent selection
const client = await pool.connect();
try {
  var categories = await client.query(`
    WITH RECURSIVE category_tree AS (
      SELECT
        id,
        name,
        "parentId",
        0 as level,
        name::text as path
      FROM categories
      WHERE "parentId" IS NULL

      UNION ALL

      SELECT
        c.id,
        c.name,
        c."parentId",
        ct.level + 1,
        ct.path || ' > ' || c.name
      FROM categories c
      INNER JOIN category_tree ct ON c."parentId" = ct.id
    )
    SELECT * FROM category_tree
    ORDER BY path
  `);
} finally {
  client.release();
}
---

<AdminLayout title="Create Category" currentPage="categories">
  <div class="max-w-4xl mx-auto">
    <div class="mb-6">
      <h1 class="text-3xl font-bold">Neue Kategorie erstellen</h1>
      <p class="text-base-content/60 mt-1">Erstellen Sie eine neue Kategorie für das Navbar-Menü</p>
    </div>

    <form id="categoryForm" class="space-y-6">
      <!-- Basic Information -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <h2 class="card-title">Grundinformationen</h2>

          <div class="form-control">
            <label class="label">
              <span class="label-text">Kategoriename *</span>
            </label>
            <input
              type="text"
              name="name"
              required
              class="input input-bordered"
              placeholder="DTF Transfer"
              id="categoryName"
            />
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text">Slug *</span>
              <span class="label-text-alt">URL-freundlicher Identifier</span>
            </label>
            <input
              type="text"
              name="slug"
              required
              class="input input-bordered"
              placeholder="dtf-transfer"
              id="categorySlug"
            />
            <label class="label">
              <span class="label-text-alt">Wird automatisch aus dem Namen generiert</span>
            </label>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text">Beschreibung</span>
            </label>
            <textarea
              name="description"
              class="textarea textarea-bordered h-24"
              placeholder="Optionale Beschreibung der Kategorie"
            ></textarea>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text">Übergeordnete Kategorie</span>
              <span class="label-text-alt">Leer lassen für Hauptkategorie</span>
            </label>
            <select name="parentId" class="select select-bordered">
              <option value="">Keine (Hauptkategorie)</option>
              {categories.rows.map((cat) => (
                <option value={cat.id}>
                  {[...Array(cat.level)].map(() => '  ')} {cat.name}
                </option>
              ))}
            </select>
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text">Anzeigereihenfolge</span>
              <span class="label-text-alt">Niedrigere Zahlen erscheinen zuerst</span>
            </label>
            <input
              type="number"
              name="displayOrder"
              value="0"
              class="input input-bordered"
              placeholder="0"
            />
          </div>
        </div>
      </div>

      <!-- Icon Selection -->
      <div class="card bg-base-100 shadow-xl" style="overflow: visible;">
        <div class="card-body" style="overflow: visible;">
          <h2 class="card-title">Icon für Navbar-Menü</h2>
          <p class="text-sm text-base-content/60 mb-4">Wählen Sie ein Icon, das in der Navbar-Dropdown-Menü angezeigt wird</p>

          <div class="form-control" style="overflow: visible; position: relative;">
            <label class="label">
              <span class="label-text">Icon auswählen</span>
            </label>

            <div id="iconPicker" style="position: relative;">
              <button
                type="button"
                id="iconPickerToggle"
                class="input input-bordered w-full flex items-center justify-between cursor-pointer text-left"
              >
                <span class="flex items-center gap-2">
                  <span id="selectedIconPreviewWrap" class="w-5 h-5 shrink-0 flex items-center justify-center">
                    <span class="w-5 h-5 rounded border-2 border-dashed border-base-content/30 block"></span>
                  </span>
                  <span id="selectedIconLabel">Kein Icon</span>
                </span>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 shrink-0 text-base-content/50">
                  <path d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                </svg>
              </button>

              <div
                id="iconDropdownPanel"
                class="hidden bg-base-100 border border-base-300 rounded-xl shadow-xl w-full max-h-72 overflow-y-auto p-2"
                style="position: absolute; z-index: 9999; top: calc(100% + 4px); left: 0;"
              >
                <!-- No icon option -->
                <div class="px-2 pt-2 pb-1">
                  <span class="text-xs font-semibold text-base-content/50 uppercase tracking-wide">Ohne Icon</span>
                </div>
                <button
                  type="button"
                  class="icon-option flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-base-200 transition-colors text-left w-full mb-1"
                  data-icon-value=""
                  data-icon-svg=""
                  data-icon-label="Kein Icon"
                >
                  <span class="w-5 h-5 rounded border-2 border-dashed border-base-content/30 shrink-0 block"></span>
                  <span class="text-sm text-base-content">Kein Icon</span>
                </button>

                {Object.entries(getIconsByCategory()).map(([cat, icons]) => (
                  <>
                    <div class="px-2 pt-3 pb-1">
                      <span class="text-xs font-semibold text-base-content/50 uppercase tracking-wide">{cat}</span>
                    </div>
                    <div class="grid grid-cols-1 gap-0.5">
                      {icons.map((icon) => (
                        <button
                          type="button"
                          class="icon-option flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-base-200 transition-colors text-left w-full"
                          data-icon-value={icon.value}
                          data-icon-svg={icon.svgContent}
                          data-icon-label={icon.label}
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 shrink-0 text-base-content/70" set:html={icon.svgContent} />
                          <span class="text-sm text-base-content">{icon.label}</span>
                        </button>
                      ))}
                    </div>
                  </>
                ))}
              </div>
            </div>

            <input type="hidden" name="icon" id="iconInput" value="" />
          </div>
        </div>
      </div>

      <!-- Media -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <h2 class="card-title">Bild</h2>

          <div class="form-control">
            <label class="label">
              <span class="label-text">Bild-URL</span>
              <span class="label-text-alt">Optional</span>
            </label>
            <input
              type="url"
              name="imageUrl"
              class="input input-bordered"
              placeholder="https://example.com/image.jpg"
            />
          </div>
        </div>
      </div>

      <!-- Status -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <h2 class="card-title">Status</h2>

          <div class="form-control">
            <label class="label cursor-pointer">
              <span class="label-text">Kategorie aktivieren</span>
              <input type="checkbox" name="isActive" checked class="checkbox checkbox-success" />
            </label>
          </div>
        </div>
      </div>

      <!-- Submit -->
      <div class="flex gap-4">
        <button type="submit" class="btn btn-primary flex-1">Kategorie erstellen</button>
        <a href="/admin/categories" class="btn btn-ghost">Abbrechen</a>
      </div>
    </form>
  </div>

  <script>
    // Auto-generate slug from name
    const nameInput = document.getElementById('categoryName');
    const slugInput = document.getElementById('categorySlug');

    nameInput.addEventListener('input', (e) => {
      const slug = e.target.value
        .toLowerCase()
        .replace(/ä/g, 'ae')
        .replace(/ö/g, 'oe')
        .replace(/ü/g, 'ue')
        .replace(/ß/g, 'ss')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
      slugInput.value = slug;
    });

    // Custom icon picker toggle
    const iconToggle = document.getElementById('iconPickerToggle');
    const iconPanel = document.getElementById('iconDropdownPanel');

    iconToggle.addEventListener('click', () => {
      iconPanel.classList.toggle('hidden');
    });

    document.addEventListener('click', (e) => {
      if (!iconToggle.contains(e.target) && !iconPanel.contains(e.target)) {
        iconPanel.classList.add('hidden');
      }
    });

    // Icon selection handler
    document.querySelectorAll('.icon-option').forEach(option => {
      option.addEventListener('click', () => {
        const iconValue = option.getAttribute('data-icon-value');
        const iconSvg = option.getAttribute('data-icon-svg');
        const iconLabel = option.getAttribute('data-icon-label');

        document.getElementById('iconInput').value = iconValue;

        const wrap = document.getElementById('selectedIconPreviewWrap');
        const label = document.getElementById('selectedIconLabel');
        if (wrap) {
          if (iconSvg) {
            wrap.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">${iconSvg}</svg>`;
          } else {
            wrap.innerHTML = `<span class="w-5 h-5 rounded border-2 border-dashed border-base-content/30 block"></span>`;
          }
        }
        if (label) label.textContent = iconLabel;

        iconPanel.classList.add('hidden');
      });
    });

    // Form submission
    document.getElementById('categoryForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(e.target);
      const data = {
        name: formData.get('name'),
        slug: formData.get('slug'),
        description: formData.get('description') || null,
        parentId: formData.get('parentId') || null,
        displayOrder: parseInt(formData.get('displayOrder')) || 0,
        icon: formData.get('icon') || null,
        imageUrl: formData.get('imageUrl') || null,
        isActive: formData.get('isActive') === 'on',
      };

      try {
        const response = await fetch('/api/admin/categories/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (result.success) {
          alert('Kategorie erfolgreich erstellt!');
          window.location.href = '/admin/categories';
        } else {
          alert('Fehler: ' + result.error.message);
        }
      } catch (error) {
        alert('Fehler beim Erstellen der Kategorie: ' + error.message);
      }
    });
  </script>
</AdminLayout>
