---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { pool } from '../../../lib/db';

// Note: Admin check is handled by middleware.ts
// If we reach here, user is already verified as admin

// Fetch all categories with hierarchy
const client = await pool.connect();
try {
  var categoriesResult = await client.query(`
    WITH RECURSIVE category_tree AS (
      SELECT
        id,
        name,
        slug,
        "parentId",
        description,
        "displayOrder",
        "isActive",
        "imageUrl",
        0 as level,
        name::text as path,
        "displayOrder"::text as sort_path
      FROM categories
      WHERE "parentId" IS NULL

      UNION ALL

      SELECT
        c.id,
        c.name,
        c.slug,
        c."parentId",
        c.description,
        c."displayOrder",
        c."isActive",
        c."imageUrl",
        ct.level + 1,
        ct.path || ' > ' || c.name,
        ct.sort_path || '_' || c."displayOrder"::text
      FROM categories c
      INNER JOIN category_tree ct ON c."parentId" = ct.id
    )
    SELECT
      ct.*,
      COUNT(p.id) as product_count
    FROM category_tree ct
    LEFT JOIN products p ON ct.id = p."categoryId" AND p."isActive" = true
    GROUP BY ct.id, ct.name, ct.slug, ct."parentId", ct.description, ct."displayOrder", ct."isActive", ct."imageUrl", ct.level, ct.path, ct.sort_path
    ORDER BY ct.sort_path
  `);

  var categories = categoriesResult.rows;
} finally {
  client.release();
}
---

<AdminLayout title="Category Management" currentPage="categories">
  <div>
    <!-- Page Header -->
    <div class="flex justify-between items-center mb-6">
      <div>
        <h1 class="text-3xl font-bold">Kategorienverwaltung</h1>
        <p class="text-base-content/60 mt-1">Verwalten Sie Kategorien für die Navbar-Menüstruktur</p>
      </div>
      <a href="/admin/categories/create" class="btn btn-primary">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Kategorie erstellen
      </a>
    </div>

    <!-- Stats -->
    <div class="stats shadow mb-6 w-full">
      <div class="stat">
        <div class="stat-title">Kategorien gesamt</div>
        <div class="stat-value">{categories.length}</div>
      </div>
      <div class="stat">
        <div class="stat-title">Aktiv</div>
        <div class="stat-value text-success">{categories.filter(c => c.isActive).length}</div>
      </div>
      <div class="stat">
        <div class="stat-title">Inaktiv</div>
        <div class="stat-value text-error">{categories.filter(c => !c.isActive).length}</div>
      </div>
      <div class="stat">
        <div class="stat-title">Hauptkategorien</div>
        <div class="stat-value text-info">{categories.filter(c => !c.parentId).length}</div>
      </div>
    </div>

    <!-- Categories Table -->
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <div class="overflow-x-auto">
          <table class="table table-zebra">
            <thead>
              <tr>
                <th>Kategorie</th>
                <th>Slug</th>
                <th>Hierarchie</th>
                <th>Produkte</th>
                <th>Reihenfolge</th>
                <th>Status</th>
                <th>Aktionen</th>
              </tr>
            </thead>
            <tbody>
              {categories.map((category) => (
                <tr>
                  <td>
                    <div class="flex items-center gap-2">
                      {[...Array(category.level)].map(() => (
                        <span class="text-base-content/30">└</span>
                      ))}
                      <div>
                        <div class="font-bold">{category.name}</div>
                        {category.description && (
                          <div class="text-sm opacity-50 line-clamp-1">{category.description}</div>
                        )}
                      </div>
                    </div>
                  </td>
                  <td>
                    <code class="text-xs bg-base-200 px-2 py-1 rounded">{category.slug}</code>
                  </td>
                  <td>
                    <div class="flex items-center gap-2">
                      <span class="badge badge-outline badge-sm">
                        Level {category.level}
                      </span>
                      {category.level > 0 && (
                        <span class="text-xs text-base-content/60">
                          {category.path}
                        </span>
                      )}
                    </div>
                  </td>
                  <td>
                    {parseInt(category.product_count) > 0 ? (
                      <span class="badge badge-success">{category.product_count} Produkte</span>
                    ) : (
                      <span class="badge badge-ghost">Keine Produkte</span>
                    )}
                  </td>
                  <td>
                    <span class="font-mono text-sm">{category.displayOrder}</span>
                  </td>
                  <td>
                    {category.isActive ? (
                      <span class="badge badge-success">Aktiv</span>
                    ) : (
                      <span class="badge badge-error">Inaktiv</span>
                    )}
                  </td>
                  <td>
                    <div class="flex gap-2">
                      <a href={`/admin/categories/${category.id}/edit`} class="btn btn-sm btn-ghost">
                        Bearbeiten
                      </a>
                      <button
                        class="btn btn-sm btn-ghost text-error"
                        onclick={`if(confirm('Kategorie "${category.name}" wirklich löschen?')) deleteCategory('${category.id}')`}
                      >
                        Löschen
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Info Box -->
    <div class="alert alert-info shadow-lg mt-6">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <div>
        <div class="font-semibold">Kategorie-Hierarchie für Navbar</div>
        <div class="text-sm opacity-80">
          Kategorien werden in einer mehrschichtigen Hierarchie angezeigt. Hauptkategorien erscheinen direkt im Menü,
          Unterkategorien als Dropdowns. Die Reihenfolge bestimmt die Anzeige im Menü.
        </div>
      </div>
    </div>
  </div>

  <script>
    async function deleteCategory(id) {
      try {
        const response = await fetch(`/api/admin/categories/${id}`, {
          method: 'DELETE',
        });

        const result = await response.json();

        if (result.success) {
          location.reload();
        } else {
          alert('Fehler: ' + result.error.message);
        }
      } catch (error) {
        alert('Fehler beim Löschen der Kategorie');
      }
    }
  </script>
</AdminLayout>
