---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { pool } from '../../lib/db';

// Fetch all zusatzleistungen
const client = await pool.connect();
let zusatzleistungen = [];
try {
	const result = await client.query(`
		SELECT * FROM "zusatzleistungen"
		ORDER BY "displayOrder", "createdAt"
	`);
	zusatzleistungen = result.rows.map(row => ({
		...row,
		price: parseFloat(row.price),
	}));
} finally {
	client.release();
}

const formatPrice = (price: number) => {
	return new Intl.NumberFormat('de-DE', {
		style: 'currency',
		currency: 'EUR'
	}).format(price);
};
---

<AdminLayout title="Einstellungen - Zusatzleistungen" currentPage="settings">
	<!-- Page Header -->
	<div class="mb-6 flex items-center justify-between">
		<div>
			<h2 class="text-3xl font-bold text-base-content mb-2">Zusatzleistungen</h2>
			<p class="text-base-content/60">Verwalten Sie Ihre zusätzlichen Services und Dienstleistungen</p>
		</div>
		<button class="btn btn-admin-primary gap-2" onclick="openCreateModal()">
			<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
				<path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
			</svg>
			Neue Zusatzleistung
		</button>
	</div>

	<!-- Zusatzleistungen List -->
	<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="services-container">
		{zusatzleistungen.map((service) => (
			<div class="card bg-base-100 shadow-md hover:shadow-lg transition-shadow border border-base-300/50" data-service-id={service.id}>
				<div class="card-body">
					<div class="flex items-start justify-between mb-3">
						<div class="flex-1">
							<h3 class="card-title text-lg">{service.name}</h3>
							<div class="text-2xl font-bold mt-2" style="color: var(--color-metrics-text);">{formatPrice(service.price)}</div>
						</div>
						<div class="form-control">
							<label class="label cursor-pointer gap-2">
								<input
									type="checkbox"
									class="toggle toggle-sm"
									style="--toggle-color: var(--color-metrics-text);"
									checked={service.isActive}
									onchange={`toggleStatus('${service.id}', this.checked)`}
								/>
							</label>
						</div>
					</div>

					<p class="text-sm text-base-content/60 mb-4 min-h-[3rem]">{service.description || 'Keine Beschreibung'}</p>

					<div class="flex items-center gap-2 text-sm text-base-content/60">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
						</svg>
						<span>Reihenfolge: {service.displayOrder}</span>
					</div>

					<div class="card-actions justify-end mt-4 pt-4 border-t border-base-300/50">
						<button class="btn btn-sm btn-ghost" onclick={`openEditModal('${service.id}')`}>
							Bearbeiten
						</button>
						<button class="btn btn-sm btn-ghost text-error" onclick={`deleteService('${service.id}')`}>
							Löschen
						</button>
					</div>
				</div>
			</div>
		))}
	</div>

	{zusatzleistungen.length === 0 && (
		<div class="text-center py-12">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-base-content/20 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
			</svg>
			<h3 class="text-xl font-semibold text-base-content mb-2">Keine Zusatzleistungen</h3>
			<p class="text-base-content/60 mb-4">Erstellen Sie Ihre erste Zusatzleistung</p>
			<button class="btn btn-admin-primary" onclick="openCreateModal()">Zusatzleistung erstellen</button>
		</div>
	)}

	<!-- Create/Edit Modal -->
	<dialog id="service-modal" class="modal">
		<div class="modal-box max-w-2xl">
			<form method="dialog">
				<button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
			</form>
			<h3 class="font-bold text-lg mb-4" id="modal-title">Zusatzleistung erstellen</h3>

			<form id="service-form" class="space-y-4">
				<input type="hidden" id="service-id" name="id" />

				<div class="form-control">
					<label class="label">
						<span class="label-text font-medium">Name *</span>
					</label>
					<input type="text" id="service-name" name="name" placeholder="z.B. Profi Datencheck" class="input input-bordered" required />
				</div>

				<div class="form-control">
					<label class="label">
						<span class="label-text font-medium">Beschreibung</span>
					</label>
					<textarea id="service-description" name="description" placeholder="Kurze Beschreibung der Leistung" class="textarea textarea-bordered" rows="3"></textarea>
				</div>

				<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
					<div class="form-control">
						<label class="label">
							<span class="label-text font-medium">Preis (€) *</span>
						</label>
						<input type="number" id="service-price" name="price" placeholder="20.00" step="0.01" min="0" class="input input-bordered" required />
						<label class="label">
							<span class="label-text-alt">Pro Warenkorb-Artikel (nicht pro Menge)</span>
						</label>
					</div>

					<div class="form-control">
						<label class="label">
							<span class="label-text font-medium">Anzeigereihenfolge</span>
						</label>
						<input type="number" id="service-display-order" name="displayOrder" placeholder="0" min="0" class="input input-bordered" />
						<label class="label">
							<span class="label-text-alt">Niedrigere Zahlen werden zuerst angezeigt</span>
						</label>
					</div>
				</div>

				<div class="form-control">
					<label class="label cursor-pointer gap-2 justify-start">
						<input type="checkbox" id="service-is-active" name="isActive" class="checkbox" style="--checkbox-color: var(--color-metrics-text);" checked />
						<span class="label-text font-medium">Aktiv</span>
					</label>
					<label class="label">
						<span class="label-text-alt">Inaktive Leistungen werden nicht in Produkten angezeigt</span>
					</label>
				</div>

				<div class="modal-action">
					<button type="button" class="btn btn-ghost" onclick="document.getElementById('service-modal').close()">Abbrechen</button>
					<button type="submit" class="btn btn-admin-primary">Speichern</button>
				</div>
			</form>
		</div>
		<form method="dialog" class="modal-backdrop">
			<button>close</button>
		</form>
	</dialog>
</AdminLayout>

<script>
	const formatPrice = (price: number) => {
		return new Intl.NumberFormat('de-DE', {
			style: 'currency',
			currency: 'EUR'
		}).format(price);
	};

	// Open create modal
	(window as any).openCreateModal = () => {
		const modal = document.getElementById('service-modal') as HTMLDialogElement;
		const form = document.getElementById('service-form') as HTMLFormElement;
		const title = document.getElementById('modal-title');

		if (title) title.textContent = 'Zusatzleistung erstellen';
		form.reset();
		(document.getElementById('service-id') as HTMLInputElement).value = '';
		(document.getElementById('service-is-active') as HTMLInputElement).checked = true;
		modal?.showModal();
	};

	// Open edit modal
	(window as any).openEditModal = async (serviceId: string) => {
		const modal = document.getElementById('service-modal') as HTMLDialogElement;
		const title = document.getElementById('modal-title');

		if (title) title.textContent = 'Zusatzleistung bearbeiten';

		try {
			const response = await fetch(`/api/admin/zusatzleistungen/${serviceId}`);
			const result = await response.json();

			if (result.success) {
				const service = result.data;
				(document.getElementById('service-id') as HTMLInputElement).value = service.id;
				(document.getElementById('service-name') as HTMLInputElement).value = service.name;
				(document.getElementById('service-description') as HTMLTextAreaElement).value = service.description || '';
				(document.getElementById('service-price') as HTMLInputElement).value = service.price;
				(document.getElementById('service-display-order') as HTMLInputElement).value = service.displayOrder || '0';
				(document.getElementById('service-is-active') as HTMLInputElement).checked = service.isActive;

				modal?.showModal();
			} else {
				alert('Fehler beim Laden der Zusatzleistung');
			}
		} catch (error) {
			console.error('Error loading service:', error);
			alert('Fehler beim Laden der Zusatzleistung');
		}
	};

	// Handle form submission
	document.getElementById('service-form')?.addEventListener('submit', async (e) => {
		e.preventDefault();

		const form = e.target as HTMLFormElement;
		const formData = new FormData(form);

		const serviceId = (document.getElementById('service-id') as HTMLInputElement).value;
		const isEdit = !!serviceId;

		const data = {
			name: formData.get('name'),
			description: formData.get('description') || null,
			price: parseFloat(formData.get('price') as string),
			displayOrder: parseInt(formData.get('displayOrder') as string) || 0,
			isActive: (document.getElementById('service-is-active') as HTMLInputElement).checked,
		};

		try {
			const url = isEdit ? `/api/admin/zusatzleistungen/${serviceId}` : '/api/admin/zusatzleistungen';
			const method = isEdit ? 'PUT' : 'POST';

			const response = await fetch(url, {
				method,
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(data),
			});

			const result = await response.json();

			if (result.success) {
				alert(isEdit ? 'Zusatzleistung aktualisiert!' : 'Zusatzleistung erstellt!');
				window.location.reload();
			} else {
				alert('Fehler: ' + result.error.message);
			}
		} catch (error) {
			console.error('Error saving service:', error);
			alert('Fehler beim Speichern der Zusatzleistung');
		}
	});

	// Toggle status
	(window as any).toggleStatus = async (serviceId: string, isActive: boolean) => {
		try {
			const response = await fetch(`/api/admin/zusatzleistungen/${serviceId}`, {
				method: 'PATCH',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ isActive }),
			});

			const result = await response.json();

			if (!result.success) {
				alert('Fehler beim Aktualisieren des Status');
				window.location.reload();
			}
		} catch (error) {
			console.error('Error toggling status:', error);
			alert('Fehler beim Aktualisieren des Status');
			window.location.reload();
		}
	};

	// Delete service
	(window as any).deleteService = async (serviceId: string) => {
		if (!confirm('Möchten Sie diese Zusatzleistung wirklich löschen?')) {
			return;
		}

		try {
			const response = await fetch(`/api/admin/zusatzleistungen/${serviceId}`, {
				method: 'DELETE',
			});

			const result = await response.json();

			if (result.success) {
				alert('Zusatzleistung gelöscht!');
				window.location.reload();
			} else {
				alert('Fehler: ' + result.error.message);
			}
		} catch (error) {
			console.error('Error deleting service:', error);
			alert('Fehler beim Löschen der Zusatzleistung');
		}
	};
</script>
