---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { pool } from '../../lib/db';
import { settingsCache } from '../../lib/settings-cache';

const client = await pool.connect();
let zusatzleistungen = [];
let bannerSettings = { enabled: true, text: '20% auf Stickerei bis 28.02.' };

try {
	// Fetch all zusatzleistungen
	const zusatzResult = await client.query(`
		SELECT * FROM "zusatzleistungen"
		ORDER BY "displayOrder", "createdAt"
	`);
	zusatzleistungen = zusatzResult.rows.map(row => ({
		...row,
		price: parseFloat(row.price),
	}));

	// Fetch banner settings from cache
	bannerSettings = await settingsCache.getBannerSettings();
} catch (error) {
	console.error('Error fetching settings:', error);
} finally {
	client.release();
}

const formatPrice = (price: number) => {
	return new Intl.NumberFormat('de-DE', {
		style: 'currency',
		currency: 'EUR'
	}).format(price);
};
---

<AdminLayout title="Einstellungen" currentPage="settings">
	<!-- Page Header -->
	<div class="mb-8">
		<h1 class="text-3xl font-bold text-base-content mb-2">Einstellungen</h1>
		<p class="text-base-content/60">Verwalten Sie Ihre Website-Einstellungen</p>
	</div>

	<!-- Banner Settings Section -->
	<div class="card bg-base-100 shadow-md border border-base-300/50 mb-8">
		<div class="card-body">
			<h2 class="text-2xl font-bold text-base-content mb-4 flex items-center gap-2">
				<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6" style="color: var(--color-metrics-text);">
					<path stroke-linecap="round" stroke-linejoin="round" d="M10.34 15.84c-.688-.06-1.386-.09-2.09-.09H7.5a4.5 4.5 0 110-9h.75c.704 0 1.402-.03 2.09-.09m0 9.18c.253.962.584 1.892.985 2.783.247.55.06 1.21-.463 1.511l-.657.38c-.551.318-1.26.117-1.527-.461a20.845 20.845 0 01-1.44-4.282m3.102.069a18.03 18.03 0 01-.59-4.59c0-1.586.205-3.124.59-4.59m0 9.18a23.848 23.848 0 018.835 2.535M10.34 6.66a23.847 23.847 0 008.835-2.535m0 0A23.74 23.74 0 0018.795 3m.38 1.125a23.91 23.91 0 011.014 5.395m-1.014 8.855c-.118.38-.245.754-.38 1.125m.38-1.125a23.91 23.91 0 001.014-5.395m0-3.46c.495.413.811 1.035.811 1.73 0 .695-.316 1.317-.811 1.73m0-3.46a24.347 24.347 0 010 3.46" />
				</svg>
				Werbebanner
			</h2>
			<p class="text-base-content/60 mb-6">Verwalten Sie das Werbebanner am oberen Seitenrand</p>

			<form id="banner-settings-form" class="space-y-4">
				<div class="form-control">
					<label class="label cursor-pointer gap-3 justify-start">
						<input
							type="checkbox"
							id="banner-enabled"
							class="toggle"
							style="--toggle-color: var(--color-metrics-text);"
							checked={bannerSettings.enabled}
						/>
						<div>
							<span class="label-text font-medium text-base">Banner anzeigen</span>
							<p class="text-sm text-base-content/60 mt-1">Aktivieren Sie das Banner, um es auf allen Seiten anzuzeigen</p>
						</div>
					</label>
				</div>

				<div class="form-control">
					<label class="label">
						<span class="label-text font-medium">Bannertext</span>
					</label>
					<input
						type="text"
						id="banner-text"
						placeholder="z.B. 20% auf Stickerei bis 28.02."
						class="input input-bordered w-full"
						value={bannerSettings.text}
						required
					/>
					<label class="label">
						<span class="label-text-alt">Der Text wird im Banner als Laufschrift angezeigt</span>
					</label>
				</div>

				<div class="flex justify-end gap-2 pt-4">
					<button type="submit" class="btn btn-admin-primary">
						<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
							<path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
						</svg>
						Banner-Einstellungen speichern
					</button>
				</div>
			</form>
		</div>
	</div>

	<!-- Zusatzleistungen Section -->
	<div class="mb-6 flex items-center justify-between">
		<div>
			<h2 class="text-2xl font-bold text-base-content mb-2">Zusatzleistungen</h2>
			<p class="text-base-content/60">Verwalten Sie Ihre zusätzlichen Services und Dienstleistungen</p>
		</div>
		<button class="btn btn-admin-primary gap-2" onclick="openCreateModal()">
			<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
				<path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
			</svg>
			Neue Zusatzleistung
		</button>
	</div>

	<!-- Zusatzleistungen List -->
	<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="services-container">
		{zusatzleistungen.map((service) => (
			<div class="card bg-base-100 shadow-md hover:shadow-lg transition-shadow border border-base-300/50" data-service-id={service.id}>
				<div class="card-body">
					<div class="flex items-start justify-between mb-3">
						<div class="flex-1">
							<h3 class="card-title text-lg">{service.name}</h3>
							<div class="text-2xl font-bold mt-2" style="color: var(--color-metrics-text);">{formatPrice(service.price)}</div>
						</div>
						<div class="form-control">
							<label class="label cursor-pointer gap-2">
								<input
									type="checkbox"
									class="toggle toggle-sm"
									checked={service.isActive}
									onchange={`toggleStatus('${service.id}', this.checked)`}
								/>
							</label>
						</div>
					</div>

					<p class="text-sm text-base-content/60 mb-4 min-h-[3rem]">{service.description || 'Keine Beschreibung'}</p>

					<div class="flex items-center gap-2 text-sm text-base-content/60">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" />
						</svg>
						<span>Reihenfolge: {service.displayOrder}</span>
					</div>

					<div class="card-actions justify-end mt-4 pt-4 border-t border-base-300/50">
						<button class="btn btn-sm btn-ghost" onclick={`openEditModal('${service.id}')`}>
							Bearbeiten
						</button>
						<button class="btn btn-sm btn-ghost text-error" onclick={`deleteService('${service.id}')`}>
							Löschen
						</button>
					</div>
				</div>
			</div>
		))}
	</div>

	{zusatzleistungen.length === 0 && (
		<div class="text-center py-12">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-base-content/20 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
			</svg>
			<h3 class="text-xl font-semibold text-base-content mb-2">Keine Zusatzleistungen</h3>
			<p class="text-base-content/60 mb-4">Erstellen Sie Ihre erste Zusatzleistung</p>
			<button class="btn btn-admin-primary" onclick="openCreateModal()">Zusatzleistung erstellen</button>
		</div>
	)}

	<!-- Create/Edit Modal -->
	<dialog id="service-modal" class="modal">
		<div class="modal-box max-w-2xl">
			<form method="dialog">
				<button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
			</form>
			<h3 class="font-bold text-lg mb-4" id="modal-title">Zusatzleistung erstellen</h3>

			<form id="service-form" class="space-y-4">
				<input type="hidden" id="service-id" name="id" />

				<div class="form-control">
					<label class="label">
						<span class="label-text font-medium">Name *</span>
					</label>
					<input type="text" id="service-name" name="name" placeholder="z.B. Profi Datencheck" class="input input-bordered" required />
				</div>

				<div class="form-control">
					<label class="label">
						<span class="label-text font-medium">Beschreibung</span>
					</label>
					<textarea id="service-description" name="description" placeholder="Kurze Beschreibung der Leistung" class="textarea textarea-bordered" rows="3"></textarea>
				</div>

				<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
					<div class="form-control">
						<label class="label">
							<span class="label-text font-medium">Preis (€) *</span>
						</label>
						<input type="number" id="service-price" name="price" placeholder="20.00" step="0.01" min="0" class="input input-bordered" required />
						<label class="label">
							<span class="label-text-alt">Pro Warenkorb-Artikel (nicht pro Menge)</span>
						</label>
					</div>

					<div class="form-control">
						<label class="label">
							<span class="label-text font-medium">Anzeigereihenfolge</span>
						</label>
						<input type="number" id="service-display-order" name="displayOrder" placeholder="0" min="0" class="input input-bordered" />
						<label class="label">
							<span class="label-text-alt">Niedrigere Zahlen werden zuerst angezeigt</span>
						</label>
					</div>
				</div>

				<div class="form-control">
					<label class="label cursor-pointer gap-2 justify-start">
						<input type="checkbox" id="service-is-active" name="isActive" class="checkbox" style="--checkbox-color: var(--color-metrics-text);" checked />
						<span class="label-text font-medium">Aktiv</span>
					</label>
					<label class="label">
						<span class="label-text-alt">Inaktive Leistungen werden nicht in Produkten angezeigt</span>
					</label>
				</div>

				<div class="modal-action">
					<button type="button" class="btn btn-ghost" onclick="document.getElementById('service-modal').close()">Abbrechen</button>
					<button type="submit" class="btn btn-admin-primary">Speichern</button>
				</div>
			</form>
		</div>
		<form method="dialog" class="modal-backdrop">
			<button>close</button>
		</form>
	</dialog>

	<!-- Confirmation Modal -->
	<dialog id="confirm-modal" class="modal">
		<div class="modal-box max-w-md">
			<h3 class="font-bold text-lg mb-2" id="confirm-title">Bestätigung</h3>
			<p class="text-base-content/70 mb-6" id="confirm-message">Möchten Sie fortfahren?</p>
			<div class="flex gap-3 justify-end">
				<button class="btn btn-ghost" onclick="document.getElementById('confirm-modal').close()">Abbrechen</button>
				<button id="confirm-button" class="btn btn-error">Löschen</button>
			</div>
		</div>
		<form method="dialog" class="modal-backdrop">
			<button>close</button>
		</form>
	</dialog>
</AdminLayout>

<script>
	const formatPrice = (price: number) => {
		return new Intl.NumberFormat('de-DE', {
			style: 'currency',
			currency: 'EUR'
		}).format(price);
	};

	// Handle banner settings form submission
	document.getElementById('banner-settings-form')?.addEventListener('submit', async (e) => {
		e.preventDefault();

		const enabled = (document.getElementById('banner-enabled') as HTMLInputElement).checked;
		const text = (document.getElementById('banner-text') as HTMLInputElement).value;

		try {
			const response = await fetch('/api/admin/banner-settings', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ enabled, text }),
			});

			const result = await response.json();

			if (result.success) {
				alert('Banner-Einstellungen gespeichert!');
				window.location.reload();
			} else {
				alert('Fehler: ' + result.error.message);
			}
		} catch (error) {
			console.error('Error saving banner settings:', error);
			alert('Fehler beim Speichern der Banner-Einstellungen');
		}
	});

	// Open create modal
	(window as any).openCreateModal = () => {
		const modal = document.getElementById('service-modal') as HTMLDialogElement;
		const form = document.getElementById('service-form') as HTMLFormElement;
		const title = document.getElementById('modal-title');

		if (title) title.textContent = 'Zusatzleistung erstellen';
		form.reset();
		(document.getElementById('service-id') as HTMLInputElement).value = '';
		(document.getElementById('service-is-active') as HTMLInputElement).checked = true;
		modal?.showModal();
	};

	// Open edit modal
	(window as any).openEditModal = async (serviceId: string) => {
		const modal = document.getElementById('service-modal') as HTMLDialogElement;
		const title = document.getElementById('modal-title');

		if (title) title.textContent = 'Zusatzleistung bearbeiten';

		try {
			const response = await fetch(`/api/admin/zusatzleistungen/${serviceId}`);
			const result = await response.json();

			if (result.success) {
				const service = result.data;
				(document.getElementById('service-id') as HTMLInputElement).value = service.id;
				(document.getElementById('service-name') as HTMLInputElement).value = service.name;
				(document.getElementById('service-description') as HTMLTextAreaElement).value = service.description || '';
				(document.getElementById('service-price') as HTMLInputElement).value = service.price;
				(document.getElementById('service-display-order') as HTMLInputElement).value = service.displayOrder || '0';
				(document.getElementById('service-is-active') as HTMLInputElement).checked = service.isActive;

				modal?.showModal();
			} else {
				alert('Fehler beim Laden der Zusatzleistung');
			}
		} catch (error) {
			console.error('Error loading service:', error);
			alert('Fehler beim Laden der Zusatzleistung');
		}
	};

	// Handle form submission
	document.getElementById('service-form')?.addEventListener('submit', async (e) => {
		e.preventDefault();

		const form = e.target as HTMLFormElement;
		const formData = new FormData(form);

		const serviceId = (document.getElementById('service-id') as HTMLInputElement).value;
		const isEdit = !!serviceId;

		const data = {
			name: formData.get('name'),
			description: formData.get('description') || null,
			price: parseFloat(formData.get('price') as string),
			displayOrder: parseInt(formData.get('displayOrder') as string) || 0,
			isActive: (document.getElementById('service-is-active') as HTMLInputElement).checked,
		};

		try {
			const url = isEdit ? `/api/admin/zusatzleistungen/${serviceId}` : '/api/admin/zusatzleistungen';
			const method = isEdit ? 'PUT' : 'POST';

			const response = await fetch(url, {
				method,
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(data),
			});

			const result = await response.json();

			if (result.success) {
				alert(isEdit ? 'Zusatzleistung aktualisiert!' : 'Zusatzleistung erstellt!');
				window.location.reload();
			} else {
				alert('Fehler: ' + result.error.message);
			}
		} catch (error) {
			console.error('Error saving service:', error);
			alert('Fehler beim Speichern der Zusatzleistung');
		}
	});

	// Toggle status
	(window as any).toggleStatus = async (serviceId: string, isActive: boolean) => {
		try {
			const response = await fetch(`/api/admin/zusatzleistungen/${serviceId}`, {
				method: 'PATCH',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ isActive }),
			});

			const result = await response.json();

			if (!result.success) {
				alert('Fehler beim Aktualisieren des Status');
				window.location.reload();
			}
		} catch (error) {
			console.error('Error toggling status:', error);
			alert('Fehler beim Aktualisieren des Status');
			window.location.reload();
		}
	};

	// Show confirmation modal
	const showConfirmModal = (title: string, message: string, onConfirm: () => void) => {
		const modal = document.getElementById('confirm-modal') as HTMLDialogElement;
		const titleEl = document.getElementById('confirm-title');
		const messageEl = document.getElementById('confirm-message');
		const confirmBtn = document.getElementById('confirm-button');

		if (titleEl) titleEl.textContent = title;
		if (messageEl) messageEl.textContent = message;

		// Remove old listeners by cloning the button
		if (confirmBtn) {
			const newBtn = confirmBtn.cloneNode(true) as HTMLButtonElement;
			confirmBtn.parentNode?.replaceChild(newBtn, confirmBtn);
			
			newBtn.addEventListener('click', () => {
				modal.close();
				onConfirm();
			});
		}

		modal?.showModal();
	};

	// Delete service
	(window as any).deleteService = async (serviceId: string) => {
		showConfirmModal(
			'Zusatzleistung löschen',
			'Möchten Sie diese Zusatzleistung wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden.',
			async () => {
				try {
					const response = await fetch(`/api/admin/zusatzleistungen/${serviceId}`, {
						method: 'DELETE',
					});

					const result = await response.json();

					if (result.success) {
						alert('Zusatzleistung gelöscht!');
						window.location.reload();
					} else {
						alert('Fehler: ' + result.error.message);
					}
				} catch (error) {
					console.error('Error deleting service:', error);
					alert('Fehler beim Löschen der Zusatzleistung');
				}
			}
		);
	};
</script>
