---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { getUserById } from '../../../lib/db';

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/admin/users');
}

const user = await getUserById(id);

if (!user) {
  return Astro.redirect('/admin/users');
}
---

<AdminLayout title={`Benutzer: ${user.name}`} currentPage="users">
  <!-- Breadcrumb -->
  <div class="mb-6">
    <nav class="flex" aria-label="Breadcrumb">
      <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li class="inline-flex items-center">
          <a href="/admin/users" class="text-base-content/60 hover:text-base-content inline-flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
            </svg>
            Zur체ck zur Benutzerliste
          </a>
        </li>
      </ol>
    </nav>
  </div>

  <!-- Page Header -->
  <div class="mb-8">
    <div class="flex items-center gap-4">
      <div class="avatar placeholder">
        <div class="bg-neutral text-neutral-content rounded-full w-16">
          <span class="text-2xl">{user.name.charAt(0).toUpperCase()}</span>
        </div>
      </div>
      <div>
        <h2 class="text-3xl font-bold text-base-content">{user.name}</h2>
        <p class="text-base-content/60">{user.email}</p>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- User Information Card -->
    <div class="card bg-base-100 border border-base-300/30 shadow-xl rounded-2xl">
      <div class="card-body">
        <h3 class="card-title text-lg mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
          </svg>
          Kontoinformationen
        </h3>

        <div class="space-y-4">
          <div class="flex justify-between items-center py-2 border-b border-base-300/30">
            <span class="text-base-content/70">Benutzer-ID</span>
            <span class="font-mono text-sm">{user.id}</span>
          </div>

          <div class="flex justify-between items-center py-2 border-b border-base-300/30">
            <span class="text-base-content/70">Name</span>
            <span class="font-medium">{user.name}</span>
          </div>

          <div class="flex justify-between items-center py-2 border-b border-base-300/30">
            <span class="text-base-content/70">E-Mail</span>
            <span class="font-medium">{user.email}</span>
          </div>

          <div class="flex justify-between items-center py-2 border-b border-base-300/30">
            <span class="text-base-content/70">E-Mail verifiziert</span>
            {user.emailVerified ? (
              <span class="badge badge-success gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                </svg>
                Ja
              </span>
            ) : (
              <span class="badge badge-warning gap-1">Nein</span>
            )}
          </div>

          <div class="flex justify-between items-center py-2 border-b border-base-300/30">
            <span class="text-base-content/70">Rolle</span>
            {user.isAdmin ? (
              <span class="badge badge-primary gap-1">Admin</span>
            ) : (
              <span class="badge badge-ghost">Benutzer</span>
            )}
          </div>

          <div class="flex justify-between items-center py-2 border-b border-base-300/30">
            <span class="text-base-content/70">Konto gesperrt</span>
            {user.accountLocked ? (
              <span class="badge badge-error gap-1">Ja</span>
            ) : (
              <span class="badge badge-success gap-1">Nein</span>
            )}
          </div>

          <div class="flex justify-between items-center py-2 border-b border-base-300/30">
            <span class="text-base-content/70">Registriert am</span>
            <span>{new Date(user.createdAt).toLocaleDateString('de-DE', {
              year: 'numeric',
              month: 'long',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            })}</span>
          </div>

          <div class="flex justify-between items-center py-2">
            <span class="text-base-content/70">Letzter Login</span>
            <span>
              {user.lastLoginAt ? new Date(user.lastLoginAt).toLocaleDateString('de-DE', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              }) : 'Nie'}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Business Information Card -->
    <div class="card bg-base-100 border border-base-300/30 shadow-xl rounded-2xl">
      <div class="card-body">
        <h3 class="card-title text-lg mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M6.75 21v-3.375c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21M3 3h12m-.75 4.5H21m-3.75 3.75h.008v.008h-.008v-.008Zm0 3h.008v.008h-.008v-.008Zm0 3h.008v.008h-.008v-.008Z" />
          </svg>
          Gesch채ftsdaten
        </h3>

        <div class="space-y-4">
          <div class="flex justify-between items-center py-2 border-b border-base-300/30">
            <span class="text-base-content/70">Gewerbetreibender</span>
            {user.gewerbebetreiber ? (
              <span class="badge badge-success gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                </svg>
                Ja
              </span>
            ) : (
              <span class="badge badge-ghost">Nein</span>
            )}
          </div>

          <div class="flex justify-between items-center py-2">
            <span class="text-base-content/70">USt-IdNr.</span>
            <span class="font-mono font-medium">{user.umsatzsteuernummer || '-'}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Discount Settings Card -->
    <div class="card bg-base-100 border border-base-300/30 shadow-xl rounded-2xl lg:col-span-2">
      <div class="card-body">
        <h3 class="card-title text-lg mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 0 0 3 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 0 0 5.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 0 0 9.568 3Z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6Z" />
          </svg>
          Rabatteinstellungen
        </h3>

        <p class="text-base-content/70 mb-4">
          Legen Sie einen individuellen Rabatt f체r diesen Benutzer fest. Dieser Rabatt wird auf den Endpreis im Shop angewendet.
        </p>

        <form id="discount-form" class="flex flex-col sm:flex-row gap-4 items-end">
          <div class="form-control w-full sm:w-auto">
            <label class="label">
              <span class="label-text">Rabatt in Prozent</span>
            </label>
            <div class="join">
              <input
                type="number"
                id="discountPercent"
                name="discountPercent"
                min="0"
                max="100"
                step="0.01"
                value={user.discountPercent}
                class="input input-bordered join-item w-32"
                placeholder="0"
              />
              <span class="btn btn-disabled join-item">%</span>
            </div>
          </div>

          <button type="submit" class="btn btn-primary" id="save-discount-btn">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
            </svg>
            Rabatt speichern
          </button>
        </form>

        <div id="discount-message" class="mt-4 hidden"></div>

        <div class="mt-4 p-4 bg-base-200 rounded-lg">
          <div class="flex items-start gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-info mt-0.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" />
            </svg>
            <div class="text-sm text-base-content/70">
              <p class="font-medium text-base-content">Hinweis zum Rabatt</p>
              <p>Der Rabatt wird automatisch auf alle Bestellungen dieses Benutzers angewendet. Ein Rabatt von 10% bedeutet, dass der Benutzer nur 90% des regul채ren Preises zahlt.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</AdminLayout>

<script define:vars={{ userId: user.id }}>
  const form = document.getElementById('discount-form');
  const messageDiv = document.getElementById('discount-message');
  const saveBtn = document.getElementById('save-discount-btn');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;

    if (discountPercent < 0 || discountPercent > 100) {
      showMessage('Der Rabatt muss zwischen 0 und 100 liegen.', 'error');
      return;
    }

    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="loading loading-spinner loading-sm"></span> Speichern...';

    try {
      const response = await fetch('/api/admin/users/update-discount', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          userId: userId,
          discountPercent: discountPercent,
        }),
      });

      const result = await response.json();

      if (response.ok) {
        showMessage('Rabatt wurde erfolgreich gespeichert.', 'success');
      } else {
        showMessage(result.error || 'Fehler beim Speichern des Rabatts.', 'error');
      }
    } catch (error) {
      showMessage('Fehler beim Speichern des Rabatts.', 'error');
    } finally {
      saveBtn.disabled = false;
      saveBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" /></svg> Rabatt speichern`;
    }
  });

  function showMessage(text, type) {
    messageDiv.className = `alert ${type === 'success' ? 'alert-success' : 'alert-error'}`;
    messageDiv.innerHTML = `<span>${text}</span>`;
    messageDiv.classList.remove('hidden');

    setTimeout(() => {
      messageDiv.classList.add('hidden');
    }, 5000);
  }
</script>
